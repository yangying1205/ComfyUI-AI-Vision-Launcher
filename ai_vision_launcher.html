<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI视界启动器</title>
    <!-- Font Awesome 图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 版本管理优化脚本 -->
    <script src="version-management-optimized.js" defer></script>
    <script src="version-management-integration.js" defer></script>
    <!-- 使用本地字体，避免外部CDN依赖 -->
    <style>
        /* 内嵌Font Awesome图标样式 */
        .fa, .fas, .far, .fal, .fab {
            font-family: 'Font Awesome 6 Free', 'Font Awesome 6 Pro', sans-serif;
            font-weight: 900;
        }
        /* 如果没有Font Awesome，使用Unicode符号作为备用 */
        .fa-play:before { content: '▶'; }
        .fa-stop:before { content: '⏹'; }
        .fa-pause:before { content: '⏸'; }
        .fa-refresh:before { content: '🔄'; }
        .fa-download:before { content: '⬇'; }
        .fa-upload:before { content: '⬆'; }
        .fa-cog:before { content: '⚙'; }
        .fa-home:before { content: '🏠'; }
        .fa-folder:before { content: '📁'; }
        .fa-file:before { content: '📄'; }
        .fa-check:before { content: '✓'; }
        .fa-times:before { content: '✕'; }
        .fa-plus:before { content: '+'; }
        .fa-minus:before { content: '-'; }
        .fa-search:before { content: '🔍'; }
        .fa-star:before { content: '⭐'; }
        .fa-heart:before { content: '❤'; }
        .fa-info:before { content: 'ℹ'; }
        .fa-warning:before { content: '⚠'; }
        .fa-error:before { content: '❌'; }
        /* 插件管理按钮图标 */
        .fa-external-link-alt:before { content: '🔗'; }
        .fa-trash:before { content: '🗑'; }
        .fa-code-branch:before { content: '🔀'; }
        .fa-sync-alt:before { content: '🔄'; }
        .fa-spinner:before { content: '⟳'; }
        .fa-rocket:before { content: '🚀'; }
        .fa-puzzle-piece:before { content: '🧩'; }
        .fa-exclamation-triangle:before { content: '⚠'; }
        .fa-info-circle:before { content: 'ℹ'; }
        .fa-check-circle:before { content: '✓'; }
        .fa-lightbulb:before { content: '💡'; }
        .fa-eraser:before { content: '🧹'; }
        .fa-history:before { content: '📜'; }

        /* 版本管理优化样式 */
        .version-loading-content {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-primary);
        }

        .loading-spinner-modern {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 245, 255, 0.2);
            border-top: 3px solid var(--neon-glow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-progress-modern {
            width: 100%;
            max-width: 300px;
            height: 4px;
            background: rgba(0, 245, 255, 0.1);
            border-radius: 2px;
            margin: 15px auto;
            overflow: hidden;
        }

        .progress-bar-modern {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-glow), #00ff88);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .loading-text {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .loading-status-modern {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .version-error-content {
            text-align: center;
            padding: 30px 20px;
            color: #ff4757;
        }

        .version-error-content i {
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .error-detail {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 10px 0;
        }

        .retry-btn {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
        }

        .version-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .version-item.current {
            border-left-color: var(--neon-glow);
            background: rgba(0, 245, 255, 0.05);
        }

        .version-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .current-icon {
            color: var(--neon-glow);
            font-size: 1rem;
        }

        .version-type-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .version-type-badge.stable {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .version-type-badge.development {
            background: rgba(255, 102, 0, 0.2);
            color: #ff6600;
            border: 1px solid rgba(255, 102, 0, 0.3);
        }

        .version-switch-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .fa-clock:before { content: '🕐'; }
    </style>
    <!-- 音效管理器 -->
    <script src="assets/sounds/audio-manager.js"></script>

    <!-- 便携包启动器性能优化 -->
    <script src="emergency-performance-fix.js"></script>

    <!-- 前端速度修复 -->
    <script src="frontend-speed-fix.js"></script>
    <style>
        :root {
            --primary-bg: #0a0a0f;
            --secondary-bg: #1a1a2e;
            --accent-cyan: #00f5ff;
            --accent-blue: #0066ff;
            --neon-glow: #00ffff;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --border-glow: #00f5ff;
            --card-bg: rgba(26, 26, 46, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            background: var(--primary-bg);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 防止水平滚动条和内嵌滚动条 */
        * {
            box-sizing: border-box;
        }

        .page-content, .plugin-management-container, .plugin-content {
            overflow-x: hidden !important;
        }

        /* 强制防止插件页面出现内嵌滚动条 */
        #available-plugin-list, #installed-plugin-list {
            overflow: visible !important;
            max-height: none !important;
            height: auto !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* 确保插件管理页面容器不会产生滚动条 */
        .plugin-management-page, .installed-plugins, .available-plugins {
            overflow: visible !important;
        }

        /* 插件列表容器 - 防止内嵌滚动条 */
        .plugin-list {
            overflow: visible !important;
            max-height: none !important;
            height: auto !important;
        }

        /* 主容器 - 竖版比例 */
        .launcher-container {
            width: 600px;
            height: 900px;
            background: var(--card-bg);
            border: 2px solid var(--border-glow);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow:
                0 0 30px rgba(0, 245, 255, 0.3),
                0 0 60px rgba(0, 245, 255, 0.1),
                inset 0 0 30px rgba(0, 245, 255, 0.05);
        }

        /* 背景容器 */
        .background-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            border-radius: 18px;
            overflow: hidden;
        }

        .background-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(1.0) contrast(1.1);
            transition: all 0.5s ease;
        }

        .background-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(1.0) contrast(1.1);
            transition: all 0.5s ease;
            display: none;
        }

        .background-image.dimmed {
            filter: brightness(0.15) contrast(1.2);
            opacity: 0.6;
        }

        .background-video.dimmed {
            filter: brightness(0.15) contrast(1.2);
            opacity: 0.6;
        }

        .background-overlay {
            display: none;
        }

        /* 内容层 */
        .content-layer {
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 25px;
        }

        /* 顶部标题区域 */
        .header-section {
            text-align: center;
            margin-bottom: 25px;
        }

        .app-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--neon-glow);
            text-shadow:
                0 0 10px #00BFFF,
                0 0 20px #0080FF,
                0 0 30px #004FFF,
                0 0 40px #002FFF,
                1px 1px 3px rgba(0, 0, 0, 0.8);
            letter-spacing: 3px;
            margin-bottom: 8px;
        }

        .app-subtitle {
            font-family: 'Exo 2', sans-serif;
            font-size: 1rem;
            color: var(--neon-glow);
            font-weight: 300;
            letter-spacing: 2px;
            text-shadow:
                0 0 6px #00BFFF,
                0 0 12px #0080FF,
                0 0 18px #004FFF,
                1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        /* 功能导航标签 */
        .navigation-tabs {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            gap: 8px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 8px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--neon-glow);
            font-family: 'Exo 2', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-shadow:
                0 0 8px var(--neon-glow),
                0 0 16px var(--neon-glow),
                2px 2px 6px rgba(0, 0, 0, 0.9);
        }

        .tab-btn:hover {
            color: #FFFFFF;
            text-shadow:
                0 0 2px #6A5ACD,
                0 0 4px #6A5ACD,
                0 0 8px #6A5ACD,
                0 0 12px #6A5ACD,
                1px 1px 3px rgba(0, 0, 0, 1),
                -1px -1px 3px rgba(0, 0, 0, 1),
                1px -1px 3px rgba(0, 0, 0, 1),
                -1px 1px 3px rgba(0, 0, 0, 1);
        }

        .tab-btn.active {
            color: #FFFFFF;
            text-shadow:
                0 0 3px #6A5ACD,
                0 0 6px #6A5ACD,
                0 0 12px #6A5ACD,
                0 0 18px #6A5ACD,
                1px 1px 4px rgba(0, 0, 0, 1),
                -1px -1px 4px rgba(0, 0, 0, 1),
                1px -1px 4px rgba(0, 0, 0, 1),
                -1px 1px 4px rgba(0, 0, 0, 1);
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
            min-height: 0;
            width: 100%;
            height: 100%;
        }

        .main-home {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            gap: 30px;
            position: relative;
            z-index: 50;
        }

        /* 当插件管理页面激活时，隐藏主页 */
        .main-home.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            z-index: 1 !important;
        }

        /* 图片上传区域 */
        .upload-section {
            position: absolute;
            top: 25px;
            right: 25px;
            z-index: 20;
        }

        .upload-btn {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            text-shadow:
                0 0 8px rgba(255, 255, 255, 0.6),
                0 0 16px rgba(255, 255, 255, 0.4),
                2px 2px 6px rgba(0, 0, 0, 0.9);
            margin-right: 8px;
        }

        .upload-btn:hover {
            color: var(--neon-glow);
            text-shadow:
                0 0 12px var(--neon-glow),
                0 0 24px var(--neon-glow),
                2px 2px 8px rgba(0, 0, 0, 0.9);
        }



        /* 配置信息卡片 */
        .info-card {
            background: rgba(0, 245, 255, 0.08);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(15px);
        }

        .info-card h3 {
            color: var(--neon-glow);
            font-size: 1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .info-label {
            color: var(--text-secondary);
        }

        .info-value {
            color: var(--neon-glow);
            font-weight: 500;
        }

        /* 功能内容区域 - 优化性能 */
        .tab-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.95);
            padding: 30px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            border-radius: 18px;
            /* 移除backdrop-filter以提高性能 */
        }

        .tab-content.active {
            display: block !important;
            z-index: 200 !important;
        }

        /* 插件管理页面使用通用样式，不需要特殊覆盖 */

        /* 简化的插件管理布局 */
        .plugin-management-simple {
            width: 100% !important;
            height: 100% !important;
            color: white !important;
        }

        .plugin-header-simple {
            display: flex !important;
            align-items: center !important;
            margin-bottom: 25px !important;
            padding-bottom: 15px !important;
            border-bottom: 1px solid #333 !important;
        }

        .plugin-header-simple h2 {
            color: #00f5ff !important;
            margin: 0 !important;
            font-size: 24px !important;
        }

        .plugin-header-simple i {
            color: #00f5ff !important;
            font-size: 24px !important;
            margin-right: 15px !important;
        }

        .plugin-count {
            margin-left: auto !important;
            color: #ccc !important;
            font-size: 14px !important;
        }

        .plugin-content-simple {
            background: rgba(0, 245, 255, 0.1) !important;
            border: 1px solid #00f5ff !important;
            border-radius: 8px !important;
            padding: 20px !important;
            margin-bottom: 20px !important;
        }

        .plugin-content-simple h3 {
            color: #00f5ff !important;
            margin: 0 0 15px 0 !important;
            font-size: 18px !important;
        }

        .plugin-items-container {
            /* 移除固定高度限制，使用自然高度 */
            overflow: visible !important;
        }

        .plugin-item-simple {
            background: rgba(255,255,255,0.05) !important;
            padding: 15px !important;
            margin: 10px 0 !important;
            border-radius: 8px !important;
            border-left: 3px solid #00f5ff !important;
        }

        .plugin-item-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            flex-wrap: wrap !important;
        }

        .plugin-info-simple {
            flex: 1 !important;
            min-width: 300px !important;
        }

        .plugin-name-simple {
            color: #00f5ff !important;
            font-size: 16px !important;
            font-weight: bold !important;
            margin-bottom: 8px !important;
        }

        .plugin-status {
            margin-left: 15px !important;
            font-size: 14px !important;
        }

        .plugin-status.enabled {
            color: #28a745 !important;
        }

        .plugin-status.disabled {
            color: #dc3545 !important;
        }

        .plugin-details {
            color: #ccc !important;
            font-size: 12px !important;
            margin-bottom: 5px !important;
        }

        .plugin-description {
            color: #999 !important;
            font-size: 11px !important;
        }

        .plugin-actions-simple {
            display: flex !important;
            gap: 8px !important;
            flex-wrap: wrap !important;
            margin-top: 10px !important;
        }

        .plugin-btn-simple {
            padding: 6px 12px !important;
            border: none !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            color: white !important;
        }

        .plugin-btn-simple.home { background: #007bff !important; }
        .plugin-btn-simple.update { background: #28a745 !important; }
        .plugin-btn-simple.switch { background: #6c757d !important; }
        .plugin-btn-simple.toggle { background: #ffc107 !important; color: black !important; }
        .plugin-btn-simple.uninstall { background: #dc3545 !important; }

        .plugin-footer {
            text-align: center !important;
            color: #666 !important;
            padding: 20px !important;
            border-top: 1px solid #333 !important;
            font-size: 12px !important;
        }


        /* 底部启动按钮区域 */
        .launch-section {
            margin-top: auto;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .launch-btn {
            width: 90%;
            min-width: 400px;
            padding: 18px 30px;
            font-size: 1.3rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--accent-cyan), var(--accent-blue));
            border: 2px solid var(--neon-glow);
            border-radius: 12px;
            color: #000;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow:
                0 0 20px rgba(0, 245, 255, 0.4),
                0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .launch-btn:hover {
            transform: translateY(-2px);
            box-shadow:
                0 0 25px var(--neon-glow),
                0 0 50px var(--neon-glow),
                0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .launch-btn:active {
            transform: translateY(0);
        }

        .launch-btn.running {
            background: linear-gradient(45deg, #ff4757, #ff3742);
            border-color: #ff4757;
        }

        .launch-btn.starting {
            background: linear-gradient(45deg, #ffa502, #ff6348);
            border-color: #ffa502;
            cursor: not-allowed;
        }

        .launch-btn.stopping {
            background: linear-gradient(45deg, #ff7675, #fd79a8);
            border-color: #ff7675;
            cursor: not-allowed;
        }

        .launch-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* 浏览器按钮 */
        .browser-btn {
            width: 90%;
            min-width: 400px;
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(45deg, rgba(0, 245, 255, 0.1), rgba(0, 102, 255, 0.1));
            border: 2px solid rgba(0, 245, 255, 0.6);
            border-radius: 10px;
            color: var(--accent-cyan);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            box-shadow:
                0 0 15px rgba(0, 245, 255, 0.2),
                0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .browser-btn:hover {
            background: linear-gradient(45deg, rgba(0, 245, 255, 0.2), rgba(0, 102, 255, 0.2));
            border-color: var(--neon-glow);
            transform: translateY(-1px);
            box-shadow:
                0 0 20px rgba(0, 245, 255, 0.4),
                0 3px 12px rgba(0, 0, 0, 0.3);
        }

        .browser-btn:active {
            transform: translateY(0);
        }

        /* 显卡信息 */
        .gpu-info {
            position: relative;
            margin-top: 15px;
            width: 90%;
            min-width: 400px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 245, 255, 0.5);
            border-radius: 10px;
            backdrop-filter: blur(15px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .gpu-details {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .gpu-icon-container {
            position: relative;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gpu-icon {
            font-size: 1.5rem;
            color: var(--neon-glow);
            z-index: 2;
        }

        .rotating-ring {
            position: absolute;
            top: -2px;
            left: -2px;
            width: 39px;
            height: 39px;
            border: 2px solid transparent;
            border-top: 2px solid var(--neon-glow);
            border-right: 2px solid var(--neon-glow);
            border-radius: 50%;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 0 8px var(--neon-glow);
            pointer-events: none; /* 确保不影响点击事件 */
        }

        .gpu-info.working::before {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background: radial-gradient(circle,
                #ffffff 0%,
                #ffffff 25%,
                var(--neon-glow) 50%,
                rgba(0, 245, 255, 0.8) 75%,
                rgba(0, 245, 255, 0.4) 90%,
                transparent 100%
            );
            border-radius: 50%;
            opacity: 1;
            animation: snake-head-trace 3s linear infinite;
            pointer-events: none;
            z-index: 5;
            box-shadow:
                0 0 10px #ffffff,
                0 0 20px var(--neon-glow);
        }

        .gpu-info.working::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle,
                rgba(255, 255, 255, 0.9) 0%,
                rgba(255, 255, 255, 0.7) 20%,
                var(--neon-glow) 40%,
                rgba(0, 245, 255, 0.7) 65%,
                rgba(0, 245, 255, 0.4) 85%,
                transparent 100%
            );
            border-radius: 50%;
            opacity: 1;
            animation: snake-body1-trace 3s linear infinite;
            pointer-events: none;
            z-index: 4;
            box-shadow: 0 0 8px var(--neon-glow);
        }

        /* 蛇身体段 - 适中的尺寸递减，保持亮度 */
        .gpu-info.working .gpu-chip::before {
            content: '';
            position: absolute;
            width: 7px;
            height: 7px;
            background: radial-gradient(circle,
                rgba(255, 255, 255, 0.8) 0%,
                rgba(255, 255, 255, 0.6) 25%,
                var(--neon-glow) 45%,
                rgba(0, 245, 255, 0.6) 70%,
                rgba(0, 245, 255, 0.3) 90%,
                transparent 100%
            );
            border-radius: 50%;
            opacity: 1;
            animation: snake-body2-trace 3s linear infinite;
            pointer-events: none;
            z-index: 3;
            box-shadow: 0 0 7px rgba(0, 245, 255, 0.7);
        }

        .gpu-info.working .gpu-chip::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: radial-gradient(circle,
                rgba(255, 255, 255, 0.7) 0%,
                rgba(255, 255, 255, 0.5) 30%,
                var(--neon-glow) 50%,
                rgba(0, 245, 255, 0.5) 75%,
                rgba(0, 245, 255, 0.3) 90%,
                transparent 100%
            );
            border-radius: 50%;
            opacity: 1;
            animation: snake-body3-trace 3s linear infinite;
            pointer-events: none;
            z-index: 2;
            box-shadow: 0 0 6px rgba(0, 245, 255, 0.6);
        }

        .gpu-info.working .gpu-name::before {
            content: '';
            position: absolute;
            width: 5px;
            height: 5px;
            background: radial-gradient(circle,
                rgba(255, 255, 255, 0.6) 0%,
                rgba(255, 255, 255, 0.4) 35%,
                var(--neon-glow) 55%,
                rgba(0, 245, 255, 0.4) 80%,
                transparent 100%
            );
            border-radius: 50%;
            opacity: 1;
            animation: snake-body4-trace 3s linear infinite;
            pointer-events: none;
            z-index: 1;
            box-shadow: 0 0 5px rgba(0, 245, 255, 0.5);
        }

        .gpu-info.working .gpu-name::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle,
                rgba(255, 255, 255, 0.5) 0%,
                rgba(255, 255, 255, 0.3) 40%,
                var(--neon-glow) 60%,
                rgba(0, 245, 255, 0.3) 85%,
                transparent 100%
            );
            border-radius: 50%;
            opacity: 1;
            animation: snake-tail-trace 3s linear infinite;
            pointer-events: none;
            z-index: 1;
            box-shadow: 0 0 4px rgba(0, 245, 255, 0.4);
        }



        @keyframes snake-head-trace {
            /* 蛇头 - 领先移动 (10px) */
            0% {
                top: -5px;
                left: -5px;
            }
            25% {
                top: -5px;
                left: calc(100% - 5px);
            }
            50% {
                top: calc(100% - 5px);
                left: calc(100% - 5px);
            }
            75% {
                top: calc(100% - 5px);
                left: -5px;
            }
            100% {
                top: -5px;
                left: -5px;
            }
        }

        @keyframes snake-body1-trace {
            /* 蛇身1 - 延迟3% (8px) */
            0% {
                top: -4px;
                left: -12px;
            }
            3% {
                top: -4px;
                left: -4px;
            }
            28% {
                top: -4px;
                left: calc(100% - 4px);
            }
            53% {
                top: calc(100% - 4px);
                left: calc(100% - 4px);
            }
            78% {
                top: calc(100% - 4px);
                left: -4px;
            }
            100% {
                top: -4px;
                left: -12px;
            }
        }

        @keyframes snake-body2-trace {
            /* 蛇身2 - 延迟6% (7px) */
            0% {
                top: -3.5px;
                left: -20px;
            }
            6% {
                top: -3.5px;
                left: -3.5px;
            }
            31% {
                top: -3.5px;
                left: calc(100% - 3.5px);
            }
            56% {
                top: calc(100% - 3.5px);
                left: calc(100% - 3.5px);
            }
            81% {
                top: calc(100% - 3.5px);
                left: -3.5px;
            }
            100% {
                top: -3.5px;
                left: -20px;
            }
        }

        @keyframes snake-body3-trace {
            /* 蛇身3 - 延迟9% (6px) */
            0% {
                top: -3px;
                left: -28px;
            }
            9% {
                top: -3px;
                left: -3px;
            }
            34% {
                top: -3px;
                left: calc(100% - 3px);
            }
            59% {
                top: calc(100% - 3px);
                left: calc(100% - 3px);
            }
            84% {
                top: calc(100% - 3px);
                left: -3px;
            }
            100% {
                top: -3px;
                left: -28px;
            }
        }

        @keyframes snake-body4-trace {
            /* 蛇身4 - 延迟12% (5px) */
            0% {
                top: -2.5px;
                left: -36px;
            }
            12% {
                top: -2.5px;
                left: -2.5px;
            }
            37% {
                top: -2.5px;
                left: calc(100% - 2.5px);
            }
            62% {
                top: calc(100% - 2.5px);
                left: calc(100% - 2.5px);
            }
            87% {
                top: calc(100% - 2.5px);
                left: -2.5px;
            }
            100% {
                top: -2.5px;
                left: -36px;
            }
        }

        @keyframes snake-tail-trace {
            /* 蛇尾 - 延迟15% (4px) */
            0% {
                top: -2px;
                left: -44px;
            }
            15% {
                top: -2px;
                left: -2px;
            }
            40% {
                top: -2px;
                left: calc(100% - 2px);
            }
            65% {
                top: calc(100% - 2px);
                left: calc(100% - 2px);
            }
            90% {
                top: calc(100% - 2px);
                left: -2px;
            }
            100% {
                top: -2px;
                left: -44px;
            }
        }







        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 8px var(--neon-glow);
                border-top-color: var(--neon-glow);
                border-right-color: var(--neon-glow);
            }
            50% {
                box-shadow: 0 0 15px var(--neon-glow), 0 0 20px var(--neon-glow);
                border-top-color: #ffffff;
                border-right-color: #ffffff;
            }
        }

        .gpu-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .gpu-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--neon-glow);
            text-shadow: 0 0 5px var(--neon-glow);
        }

        .gpu-usage {
            font-size: 0.75rem;
            color: var(--text-primary);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .gpu-status {
            font-size: 0.8rem;
            color: var(--text-primary);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* 扫描线效果 */
        .launcher-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 245, 255, 0.02) 2px,
                rgba(0, 245, 255, 0.02) 4px
            );
            pointer-events: none;
            z-index: 5;
            border-radius: 18px;
        }

        /* 专家模式按钮 */
        .expert-mode-btn {
            background: rgba(255, 102, 0, 0.2);
            border: 1px solid rgba(255, 102, 0, 0.5);
            color: #ff6600;
            font-size: 0.75rem;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .expert-mode-btn:hover {
            background: rgba(255, 102, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 102, 0, 0.3);
        }

        /* 启动设置页面样式 */
        .launch-settings-container {
            padding: 20px;
            max-width: 100%;
            color: var(--text-primary);
        }

        .launch-settings-container h3 {
            color: var(--neon-glow);
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px var(--neon-glow);
        }

        /* 预设配置卡片 */
        .preset-section {
            margin-bottom: 25px;
        }

        .preset-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .preset-card {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .preset-card:hover {
            border-color: var(--neon-glow);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.3);
            transform: translateY(-2px);
        }

        .preset-card.active {
            border-color: var(--neon-glow);
            background: rgba(0, 245, 255, 0.1);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.4);
        }

        .preset-card h4 {
            color: var(--neon-glow);
            font-size: 0.9rem;
            margin-bottom: 6px;
            text-shadow: 0 0 5px var(--neon-glow);
        }

        .preset-card p {
            color: var(--text-secondary);
            font-size: 0.7rem;
            line-height: 1.3;
            font-family: 'JetBrains Mono', monospace;
        }

        /* 设置区域 */
        .memory-section, .attention-section, .network-section, .proxy-section {
            margin-bottom: 25px;
            background: rgba(26, 26, 46, 0.4);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        /* 启动设置页面输入框样式 */
        .launch-settings-container input[type="text"],
        .launch-settings-container input[type="number"],
        .launch-settings-container select {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s ease;
            width: 100%;
        }

        .launch-settings-container input[type="text"]:focus,
        .launch-settings-container input[type="number"]:focus,
        .launch-settings-container select:focus {
            outline: none;
            border-color: var(--neon-glow);
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.3);
            background: rgba(26, 26, 46, 0.8);
        }

        .launch-settings-container select option {
            background: rgba(26, 26, 46, 0.95);
            color: var(--text-primary);
            padding: 8px;
        }

        /* 水平布局的设置项 */
        .setting-item.horizontal {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 15px;
            padding: 8px 0;
        }

        .setting-item.horizontal label {
            flex-shrink: 0;
            min-width: 140px;
            margin-bottom: 0;
            padding-top: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* 显存优化版块的特殊调整 - 标签位置与复选框对齐 */
        .memory-section .setting-item.horizontal label {
            margin-left: 24px; /* 与复选框标签对齐 */
        }

        .setting-item.horizontal input,
        .setting-item.horizontal select {
            flex: 1;
            max-width: 280px;
            min-width: 200px;
        }

        .setting-item.horizontal .input-with-hint {
            flex: 1;
            max-width: 280px;
            min-width: 200px;
        }

        .setting-item.horizontal .input-with-hint input,
        .setting-item.horizontal .input-with-hint select {
            width: 100%;
            margin-bottom: 4px;
        }

        .setting-item.horizontal .input-with-hint .hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.3;
            opacity: 0.8;
        }

        /* 代理设置的特殊样式 */
        .proxy-inputs .setting-item.horizontal {
            gap: 15px; /* 减少间距，防止输入框跑出边界 */
        }

        .proxy-inputs .setting-item.horizontal label {
            margin-left: 24px; /* 与"启用代理"复选框标签对齐 */
            min-width: 100px; /* 减少标签宽度，为输入框留出空间 */
        }

        .proxy-inputs .setting-item.horizontal input {
            max-width: 280px; /* 减少最大宽度，防止跑出边界 */
            min-width: 200px;
        }

        /* 单选按钮组 */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .radio-item:hover {
            background: rgba(0, 245, 255, 0.05);
        }

        .radio-item input[type="radio"] {
            margin-top: 3px;
            accent-color: var(--neon-glow);
        }

        .radio-item span {
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .radio-item small {
            color: var(--text-secondary);
            font-size: 0.75rem;
            display: block;
            margin-top: 2px;
        }

        /* 复选框组 */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: rgba(0, 245, 255, 0.05);
        }

        .checkbox-item input[type="checkbox"] {
            margin-top: 3px;
            accent-color: var(--neon-glow);
        }

        .checkbox-item span {
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .checkbox-item small {
            color: var(--text-secondary);
            font-size: 0.7rem;
            display: block;
            margin-top: 2px;
        }

        /* 输入框组 */
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .input-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-item label {
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .input-item input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s ease;
        }

        .input-item input:focus {
            outline: none;
            border-color: var(--neon-glow);
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.3);
        }

        .input-item small {
            color: var(--text-secondary);
            font-size: 0.7rem;
        }

        /* 命令预览 */
        .command-preview {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(5px);
        }

        .command-preview h4 {
            color: var(--neon-glow);
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .command-text {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 6px;
            padding: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--neon-glow);
            word-break: break-all;
            line-height: 1.4;
            text-shadow: 0 0 5px var(--neon-glow);
        }

        /* 专家模式 */
        .expert-settings {
            margin-top: 20px;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.5s ease;
        }

        .expert-settings.active {
            opacity: 1;
            max-height: 500px;
        }

        /* 启动按钮在设置页面 */
        .settings-launch-btn {
            width: 100%;
            margin-top: 25px;
            background: linear-gradient(45deg, var(--accent-cyan), var(--accent-blue));
            border: 2px solid var(--neon-glow);
            border-radius: 12px;
            padding: 15px 30px;
            color: #000;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: none;
        }

        .settings-launch-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(0, 245, 255, 0.6);
        }

        .settings-launch-btn i {
            margin-right: 8px;
        }

        /* 操作按钮组 */
        .actions-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 245, 255, 0.2);
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }

        .btn-primary {
            background: rgba(0, 102, 255, 0.8);
            color: white;
            border: 1px solid rgba(0, 102, 255, 0.6);
        }

        .btn-primary:hover {
            background: rgba(0, 102, 255, 1);
            box-shadow: 0 0 15px rgba(0, 102, 255, 0.5);
            transform: translateY(-2px);
        }

        .btn-success {
            background: rgba(0, 255, 102, 0.8);
            color: #000;
            border: 1px solid rgba(0, 255, 102, 0.6);
        }

        .btn-success:hover {
            background: rgba(0, 255, 102, 1);
            box-shadow: 0 0 15px rgba(0, 255, 102, 0.5);
            transform: translateY(-2px);
        }

        .btn-warning {
            background: rgba(255, 153, 0, 0.8);
            color: white;
            border: 1px solid rgba(255, 153, 0, 0.6);
        }

        .btn-warning:hover {
            background: rgba(255, 153, 0, 1);
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
            transform: translateY(-2px);
        }

        /* 更新通知动画 */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* 信息卡片样式 */
        .info-card {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .info-card h3 {
            color: var(--neon-glow);
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px var(--neon-glow);
        }

        .info-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 245, 255, 0.1);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .info-value {
            color: var(--neon-glow);
            font-weight: 600;
            font-size: 0.9rem;
            text-shadow: 0 0 5px var(--neon-glow);
        }

        /* 版本管理页面样式 */
        .version-management-container {
            padding: 20px;
            max-width: 100%;
            color: var(--text-primary);
        }

        /* 版本更新状态样式 */
        .version-update-status {
            margin: 10px 0;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.9rem;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .update-checking {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            color: #3498db;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .update-notification {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
            color: #2ecc71;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .update-error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .update-close-btn {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 4px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .update-close-btn:hover {
            opacity: 1;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 版本管理头部 */
        .version-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 245, 255, 0.2);
        }



        .version-header h2 {
            color: var(--neon-glow);
            font-size: 1.3rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px var(--neon-glow);
        }

        /* 刷新版本按钮 */
        .refresh-versions-btn {
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.1), rgba(0, 245, 255, 0.2));
            border: 1px solid rgba(0, 245, 255, 0.3);
            color: var(--neon-glow);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .refresh-versions-btn:hover {
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.2), rgba(0, 245, 255, 0.3));
            border-color: rgba(0, 245, 255, 0.5);
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.3);
            transform: translateY(-1px);
        }

        .refresh-versions-btn:active {
            transform: translateY(0);
        }

        .refresh-versions-btn i {
            transition: transform 0.3s ease;
        }

        .refresh-versions-btn:hover i {
            transform: rotate(180deg);
        }

        /* 版本类型切换标签 */
        .version-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 25px;
            background: rgba(26, 26, 46, 0.4);
            border-radius: 10px;
            padding: 4px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 245, 255, 0.2);
        }

        .version-tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .version-tab-btn:hover {
            color: var(--text-primary);
            background: rgba(0, 245, 255, 0.1);
        }

        .version-tab-btn.active {
            color: var(--neon-glow);
            background: rgba(0, 245, 255, 0.15);
            text-shadow: 0 0 10px var(--neon-glow);
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.3);
        }

        /* 版本列表容器 */
        .version-list-container {
            position: relative;
            min-height: 400px;
        }

        /* 加载状态 */
        .version-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            font-size: 16px;
            gap: 16px;
            flex-direction: column;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 245, 255, 0.3);
            border-top: 3px solid var(--neon-glow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* 版本列表 */
        .version-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* 版本条目 */
        .version-item {
            background: rgba(26, 26, 46, 0.4);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 10px;
            padding: 16px 20px;
            min-height: 80px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .version-item:hover {
            border-color: rgba(0, 245, 255, 0.4);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.2);
        }

        .version-item:last-child {
            margin-bottom: 0;
        }

        .version-item.current {
            border-color: var(--neon-glow);
            background: rgba(0, 245, 255, 0.03);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
            animation: currentVersionPulse 3s ease-in-out infinite;
        }

        @keyframes currentVersionPulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 25px rgba(0, 245, 255, 0.5);
            }
        }

        /* 版本信息 */
        .version-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-height: 48px;
            justify-content: center;
        }

        .version-main {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .version-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(0, 245, 255, 0.3);
            transition: all 0.3s ease;
        }

        .version-id {
            color: var(--neon-glow);
            font-weight: 600;
            font-size: 1rem;
            text-shadow: 0 0 5px var(--neon-glow);
            font-family: 'JetBrains Mono', monospace;
        }

        .version-commit {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-left: 24px;
            font-style: italic;
            opacity: 0.8;
            line-height: 1.3;
            max-height: 2.6em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .version-item.current .version-indicator {
            background: var(--neon-glow);
            box-shadow: 0 0 10px var(--neon-glow);
        }

        .version-item.latest {
            border-color: rgba(0, 245, 255, 0.4);
            background: rgba(0, 245, 255, 0.05);
        }

        .version-item.latest .version-indicator {
            background: rgba(0, 245, 255, 0.6);
            box-shadow: 0 0 8px rgba(0, 245, 255, 0.4);
        }

        .version-id {
            color: var(--neon-glow);
            font-weight: 600;
            font-size: 1rem;
            text-shadow: 0 0 5px var(--neon-glow);
            font-family: 'JetBrains Mono', monospace;
        }

        .version-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-left: auto;
        }



        /* 🚀 高性能版本徽章样式 */
        .badge {
            font-size: 11px;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .current-badge {
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            text-shadow: 0 0 3px rgba(40, 167, 69, 0.5);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .latest-badge {
            color: #00f5ff;
            background: rgba(0, 245, 255, 0.1);
            text-shadow: 0 0 3px rgba(0, 245, 255, 0.5);
            border: 1px solid rgba(0, 245, 255, 0.3);
        }

        .newer-badge {
            color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.3);
            animation: badgePulse 2s infinite;
        }

        .version-author {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-left: 24px;
            opacity: 0.7;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @keyframes badgePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* 🚀 aki级别快速加载样式 */
        .version-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .version-loading i {
            margin-right: 8px;
            color: var(--primary-color);
        }

        .version-loading span {
            animation: loadingPulse 1.5s infinite;
        }

        @keyframes loadingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* 版本切换按钮 - 与原始项目样式保持一致 */
        .version-switch-btn {
            background: transparent;
            border: 1px solid var(--neon-glow);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--neon-glow);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            min-width: 70px;
        }

        .version-switch-btn:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .version-switch-btn.current {
            background: rgba(0, 200, 100, 0.8);
            border-color: rgba(0, 200, 100, 0.6);
            cursor: default;
            color: white;
        }

        .version-switch-btn.current:hover {
            background: rgba(0, 200, 100, 0.8);
            box-shadow: none;
        }

        .version-switch-btn.newer {
            background: transparent;
            border-color: #ff6b35;
            color: #ff6b35;
        }

        .version-switch-btn.newer:hover {
            background: rgba(255, 107, 53, 0.1);
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
        }

        /* 开发版本特殊样式 */
        .version-item.development {
            border-color: rgba(255, 107, 53, 0.4);
            background: rgba(255, 107, 53, 0.05);
        }

        .version-item.development:hover {
            border-color: rgba(255, 107, 53, 0.6);
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.3);
        }

        .version-item.development.current {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.4);
        }

        .version-switch-btn.development {
            background: transparent;
            border-color: var(--neon-glow);
            color: var(--neon-glow);
        }

        .version-switch-btn.development:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .version-switch-btn.development.current {
            background: rgba(0, 200, 100, 0.8);
            border-color: rgba(0, 200, 100, 0.6);
        }

        .version-switch-btn.development.current:hover {
            background: rgba(0, 200, 100, 0.8);
            box-shadow: none;
        }



        .version-item.newer {
            border-left: 3px solid #ff6b35;
            background: rgba(255, 107, 53, 0.05);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0); }
        }

        /* 模态对话框 */
        .version-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: modalFadeIn 0.3s ease;
        }

        .version-modal.show {
            display: flex;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid var(--neon-glow);
            border-radius: 12px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            backdrop-filter: blur(20px);
            box-shadow: 0 0 30px rgba(0, 245, 255, 0.3);
        }

        .modal-content h3 {
            color: var(--neon-glow);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-shadow: 0 0 10px var(--neon-glow);
        }

        .modal-content p {
            color: var(--text-primary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-content #target-version,
        .modal-content #progress-version {
            color: var(--neon-glow);
            font-weight: 600;
            text-shadow: 0 0 5px var(--neon-glow);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        /* 进度条 */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
            border: 1px solid rgba(0, 245, 255, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-glow), var(--accent-blue));
            border-radius: 4px;
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px var(--neon-glow);
        }

        .modal-content small {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        /* 插件管理页面样式 - 性能优化版本 */
        .plugin-management-container {
            padding: 20px;
            max-width: 100%;
            color: var(--text-primary);
            /* 移除固定高度限制，与版本管理页面保持一致 */
            /* 启用硬件加速和优化 */
            transform: translateZ(0);
            will-change: transform;
            contain: layout style paint;
        }

        .plugin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .plugin-header h2 {
            color: var(--neon-glow);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px var(--neon-glow);
            margin: 0;
        }

        .plugin-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 5px;
            /* 性能优化 */
            transform: translateZ(0);
            will-change: transform;
        }

        .plugin-tab-btn {
            padding: 10px 16px;
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            min-width: fit-content;
            flex-shrink: 0;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .plugin-tab-btn:hover {
            border-color: var(--neon-glow);
            background: rgba(0, 245, 255, 0.1);
        }

        .plugin-tab-btn.active {
            border-color: var(--neon-glow);
            background: rgba(0, 245, 255, 0.15);
            color: var(--neon-glow);
            text-shadow: 0 0 5px var(--neon-glow);
        }

        /* 确保标签文字在小屏幕上也保持一行 */
        @media (max-width: 768px) {
            .plugin-tabs {
                gap: 6px;
            }

            .plugin-tab-btn {
                padding: 8px 14px;
                font-size: 0.85rem;
                gap: 6px;
            }
        }

        @media (max-width: 600px) {
            .plugin-tabs {
                gap: 4px;
            }

            .plugin-tab-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
                gap: 5px;
            }

            .plugin-tab-btn i {
                font-size: 0.9em;
            }
        }

        @media (max-width: 500px) {
            .plugin-tab-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
                gap: 4px;
            }

            .plugin-tab-btn i {
                font-size: 0.85em;
            }
        }

        .plugin-content {
            /* 移除overflow-y: auto，使用页面级别的滚动条 */
        }

        /* 已安装插件样式 */
        .installed-plugins {
            display: none;
        }

        .installed-plugins.active {
            display: block;
        }

        /* 可安装插件样式 */
        .available-plugins {
            display: none;
        }

        .available-plugins.active {
            display: block !important;
        }

        /* 插件工具栏样式 - 简约设计 */
        .plugin-toolbar {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(26, 26, 46, 0.4);
            border-radius: 12px;
            border: 1px solid rgba(0, 245, 255, 0.15);
            backdrop-filter: blur(15px);
        }

        .search-container {
            flex: 2;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--neon-glow);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 16px;
        }

        .filter-container {
            flex: 1;
            min-width: 180px;
        }

        .category-select {
            width: 100%;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-select:focus {
            outline: none;
            border-color: var(--neon-glow);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
        }

        .category-select option {
            background: rgba(26, 26, 46, 0.95);
            color: var(--text-primary);
            padding: 8px;
        }

        /* 插件列表布局 - 紧凑表格式，优化滚动性能 */
        .plugin-list {
            display: block;
            padding: 0;
            margin: 0;
            /* 优化滚动性能 */
            contain: layout style paint;
            transform: translate3d(0, 0, 0);
        }

        /* 可用插件项 - 两行布局设计，优化滚动性能 */
        .available-plugin-item {
            background: rgba(26, 26, 46, 0.2);
            border: 1px solid rgba(0, 245, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
            /* 启用硬件加速，优化滚动性能 */
            transform: translate3d(0, 0, 0);
            will-change: transform, background-color, border-color;
        }

        .available-plugin-item:hover {
            border-color: rgba(0, 245, 255, 0.3);
            background: rgba(26, 26, 46, 0.4);
            transform: translate3d(4px, 0, 0);
        }

        /* 插件信息区域 */
        .available-plugin-info {
            display: flex;
            width: 100%;
            gap: 20px;
        }

        /* 左侧：插件名称和描述 */
        .plugin-main-info {
            flex: 1;
            min-width: 0;
        }

        /* 插件标题行：名称 + 作者 */
        .plugin-title-line {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 6px;
        }

        .available-plugin-name {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .plugin-author {
            color: #ffa500;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* 插件描述 */
        .plugin-description {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* 底部信息行：分类、星标、主页、安装 */
        .plugin-bottom-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            font-size: 12px;
            margin-top: 8px;
        }

        /* 左侧信息组 */
        .plugin-left-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        /* 右侧按钮组 */
        .plugin-right-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .plugin-category {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .plugin-stars {
            color: #ffd700;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            min-width: 60px;
        }

        .plugin-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            white-space: nowrap;
            min-width: 60px;
        }

        .plugin-action-btn.install {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .plugin-action-btn.install:hover {
            background: linear-gradient(135deg, #218838, #1ea080);
            transform: translateY(-1px);
        }

        .plugin-action-btn.installed {
            background: rgba(108, 117, 125, 0.6);
            color: rgba(255, 255, 255, 0.8);
            cursor: not-allowed;
        }

        .plugin-action-btn.info {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
            border: 1px solid rgba(0, 123, 255, 0.3);
        }

        .plugin-action-btn.info:hover {
            background: rgba(0, 123, 255, 0.2);
            border-color: rgba(0, 123, 255, 0.5);
            transform: translateY(-1px);
        }

        /* 加载状态样式 */
        .plugin-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px 40px;
            color: var(--text-secondary);
            font-size: 16px;
            gap: 16px;
            flex-direction: column;
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            min-width: 300px;
        }

        .loading-progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(0, 245, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--neon-glow));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
            box-shadow: 0 0 8px rgba(0, 245, 255, 0.6);
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 245, 255, 0.2);
            border-top: 3px solid var(--neon-glow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 环境配置页面样式 */
        .environment-container {
            padding: 20px;
        }

        /* 环境配置子标签导航 */
        .environment-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(0, 245, 255, 0.2);
            padding-bottom: 16px;
        }

        .environment-tab-btn {
            background: rgba(26, 26, 46, 0.3);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 8px;
            padding: 12px 20px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .environment-tab-btn:hover {
            border-color: rgba(0, 245, 255, 0.4);
            background: rgba(26, 26, 46, 0.5);
            color: var(--text-primary);
        }

        .environment-tab-btn.active {
            background: rgba(0, 245, 255, 0.1);
            border-color: var(--neon-glow);
            color: var(--neon-glow);
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.2);
        }



        /* 设置页面样式 */
        .settings-container {
            padding: 0;
        }

        /* 卡片式网格布局 */
        .settings-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            padding: 0;
        }

        /* 设置卡片 */
        .settings-card {
            background: rgba(0, 245, 255, 0.03);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .settings-card:hover {
            border-color: rgba(0, 245, 255, 0.4);
            box-shadow: 0 8px 32px rgba(0, 245, 255, 0.1);
            transform: translateY(-2px);
        }

        /* 卡片头部 */
        .settings-card-header {
            background: rgba(0, 245, 255, 0.08);
            padding: 16px 24px;
            border-bottom: 1px solid rgba(0, 245, 255, 0.15);
        }

        .settings-card-header h3 {
            color: var(--neon-glow);
            font-size: 1.3rem;
            margin: 0 0 4px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 0 10px var(--neon-glow);
        }

        .settings-card-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin: 0;
            line-height: 1.3;
        }

        /* 卡片内容 */
        .settings-card-content {
            padding: 24px;
        }

        /* 设置组 */
        .settings-group {
            margin-bottom: 24px;
        }

        .settings-group:last-child {
            margin-bottom: 0;
        }

        .settings-group h4 {
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .settings-group h4 i {
            font-size: 14px;
            color: var(--neon-glow);
        }

        /* 设置项容器 */
        .settings-items {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item label {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
            flex: 1;
        }

        /* 信息列表 */
        .info-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-list .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-list .info-item:last-child {
            border-bottom: none;
        }

        /* 设置页面返回按钮 */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }



        /* 紧凑型设置项 */
        .setting-item.compact {
            padding: 8px 0;
        }

        .upload-btn.compact {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 100px;
        }

        /* 紧凑型主题选择器 */
        .theme-selector.compact {
            gap: 6px;
        }

        .theme-btn.compact {
            padding: 6px 10px;
            font-size: 11px;
        }

        .theme-btn.compact .theme-color {
            width: 10px;
            height: 10px;
        }

        /* 文件上传区域 */
        .file-upload-area {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .upload-btn {
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 6px;
            padding: 8px 16px;
            color: var(--neon-glow);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-btn:hover {
            background: rgba(0, 245, 255, 0.2);
            border-color: var(--neon-glow);
            transform: translateY(-1px);
        }

        .upload-info {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* 主题选择器 */
        .theme-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .theme-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .theme-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .theme-btn.active {
            border-color: var(--neon-glow);
            background: rgba(0, 245, 255, 0.1);
            color: var(--neon-glow);
        }

        .theme-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* 操作按钮 */
        .action-btn {
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 6px;
            padding: 10px 20px;
            color: var(--neon-glow);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover {
            background: rgba(0, 245, 255, 0.2);
            border-color: var(--neon-glow);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 245, 255, 0.2);
        }

        .action-btn.primary {
            background: linear-gradient(45deg, var(--accent-cyan), var(--accent-blue));
            border-color: var(--neon-glow);
            color: #000;
        }

        .action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            color: var(--text-primary);
        }

        .action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* 表单选择器 */
        .form-select {
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 14px;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-select:hover {
            border-color: var(--neon-glow);
            background: rgba(26, 26, 46, 0.9);
        }

        .form-select:focus {
            outline: none;
            border-color: var(--neon-glow);
            box-shadow: 0 0 8px rgba(0, 245, 255, 0.3);
        }

        .form-select option {
            background: rgba(26, 26, 46, 0.95);
            color: var(--text-primary);
            padding: 8px;
        }

        /* 切换开关 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-label {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            transition: 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .toggle-label:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-label {
            background: var(--neon-glow);
            border-color: var(--neon-glow);
        }

        .toggle-switch input:checked + .toggle-label:before {
            transform: translateX(26px);
            background: #000;
        }

        /* 信息网格 */
        .info-grid {
            display: grid;
            gap: 12px;
        }

        .info-grid .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-grid .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
        }

        .info-value {
            color: var(--neon-glow);
            font-weight: 500;
            font-size: 13px;
        }

        /* 环境标签页内容 */
        .environment-tab-content {
            display: none;
        }

        .environment-tab-content.active {
            display: block;
        }

        /* 环境信息网格 */
        .env-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        /* 环境信息卡片 */
        .env-info-card {
            background: rgba(26, 26, 46, 0.3);
            border: 1px solid rgba(0, 245, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .env-info-card h4 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .env-info-card h4 i {
            color: var(--neon-glow);
        }

        /* 环境信息列表 */
        .env-info-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .env-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 245, 255, 0.1);
        }

        .env-info-item:last-child {
            border-bottom: none;
        }

        .env-label {
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .env-value {
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            text-align: right;
            max-width: 60%;
            word-break: break-all;
        }

        /* 环境操作按钮 */
        .env-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .env-refresh-btn {
            background: linear-gradient(135deg, var(--neon-glow), #00ff88);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            color: #000;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .env-refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 245, 255, 0.3);
        }

        /* 终端容器样式 */
        .terminal-container {
            background: rgba(26, 26, 46, 0.3);
            border: 1px solid rgba(0, 245, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .terminal-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0, 245, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-header h4 {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-controls {
            display: flex;
            gap: 8px;
        }

        .terminal-btn {
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--neon-glow);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .terminal-btn:hover {
            background: rgba(0, 245, 255, 0.2);
            border-color: var(--neon-glow);
        }

        .terminal-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0a0a0a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .terminal-welcome {
            padding: 16px;
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
            color: #00ff88;
        }

        .terminal-welcome p {
            margin: 4px 0;
        }

        .terminal-welcome ul {
            margin: 8px 0 0 20px;
            padding: 0;
        }

        .terminal-welcome li {
            margin: 4px 0;
        }

        .terminal-welcome code {
            background: rgba(0, 255, 0, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            color: #00ff00;
        }

        .terminal-output {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            scroll-behavior: smooth;
        }

        .terminal-output::-webkit-scrollbar {
            width: 8px;
        }

        .terminal-output::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .terminal-output::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 0, 0.3);
            border-radius: 4px;
        }

        .terminal-output::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 0, 0.5);
        }

        .terminal-input-line {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-top: 1px solid rgba(0, 255, 0, 0.2);
            background: rgba(0, 0, 0, 0.5);
        }

        .terminal-prompt {
            color: #00ff88;
            font-weight: bold;
            margin-right: 8px;
        }

        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            outline: none;
        }

        .terminal-input::placeholder {
            color: rgba(0, 255, 0, 0.5);
        }

        .plugin-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: rgba(26, 26, 46, 0.4);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 10px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .plugin-item:hover {
            border-color: rgba(0, 245, 255, 0.4);
            background: rgba(26, 26, 46, 0.6);
        }

        .plugin-item.disabled {
            opacity: 0.6;
        }

        .plugin-item.disabled .plugin-name {
            text-decoration: line-through;
        }

        /* 空状态样式 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--accent-cyan);
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 1rem;
            margin-bottom: 30px;
            opacity: 0.8;
        }

        .empty-state .btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, var(--accent-cyan), var(--accent-blue));
            border: 2px solid var(--neon-glow);
            border-radius: 8px;
            color: #000;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .empty-state .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.4);
        }

        .plugin-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .plugin-name {
            color: var(--neon-glow);
            font-size: 1rem;
            font-weight: 600;
            text-shadow: 0 0 5px var(--neon-glow);
            min-width: 200px;
        }

        .plugin-version {
            color: var(--text-secondary);
            font-size: 0.85rem;
            min-width: 80px;
        }

        .plugin-date {
            color: var(--text-secondary);
            font-size: 0.8rem;
            min-width: 100px;
        }

        .plugin-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .plugin-btn {
            padding: 6px 12px;
            border: 1px solid;
            border-radius: 6px;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
        }

        .plugin-btn-link {
            border-color: rgba(0, 150, 255, 0.5);
            color: #0096ff;
        }

        .plugin-btn-link:hover {
            background: rgba(0, 150, 255, 0.1);
            border-color: #0096ff;
        }

        .plugin-btn-update {
            border-color: rgba(0, 200, 100, 0.5);
            color: #00c864;
        }

        .plugin-btn-update:hover {
            background: rgba(0, 200, 100, 0.1);
            border-color: #00c864;
        }

        /* 已安装插件功能按钮样式 - 与原始项目保持一致 */
        [data-plugin-name] button {
            transition: all 0.2s ease !important;
        }

        [data-plugin-name] button:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
        }

        /* 主页按钮悬停效果 */
        [data-plugin-name] button[onclick*="openInExternalBrowser"]:hover {
            background: #0056b3 !important;
            box-shadow: 0 4px 8px rgba(0,123,255,0.4) !important;
        }

        /* 启用/禁用按钮悬停效果 */
        [data-plugin-name] button[onclick*="togglePlugin"]:hover {
            filter: brightness(1.1) !important;
        }

        /* 卸载按钮悬停效果 */
        [data-plugin-name] button[onclick*="uninstallPlugin"]:hover {
            background: #c82333 !important;
            box-shadow: 0 4px 8px rgba(220,53,69,0.4) !important;
        }

        /* 切换按钮悬停效果 */
        [data-plugin-name] button[onclick*="showPluginVersions"]:hover {
            background: #5a6268 !important;
            box-shadow: 0 4px 8px rgba(108,117,125,0.4) !important;
        }

        /* 更新按钮悬停效果 */
        [data-plugin-name] button[onclick*="updatePlugin"]:hover {
            filter: brightness(1.1) !important;
        }

        /* 手动安装插件样式 */
        .manual-install-container {
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .manual-install-info,
        .manual-install-form,
        .install-progress,
        .install-history {
            margin-bottom: 30px;
        }

        .info-card,
        .form-card,
        .progress-card,
        .history-card {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 12px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }

        .info-card h3,
        .form-card h3,
        .progress-card h3,
        .history-card h3 {
            color: var(--neon-glow);
            margin: 0 0 20px 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-content p {
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .info-content ul {
            color: var(--text-secondary);
            padding-left: 20px;
            margin-bottom: 20px;
        }

        .info-content li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .info-content strong {
            color: var(--neon-glow);
        }

        .warning-note {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffc107;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .url-input,
        .name-input {
            flex: 1;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .url-input:focus,
        .name-input:focus {
            outline: none;
            border-color: var(--neon-glow);
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.3);
        }

        .validate-btn {
            padding: 12px 16px;
            background: rgba(0, 245, 255, 0.2);
            border: 1px solid var(--neon-glow);
            border-radius: 8px;
            color: var(--neon-glow);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px;
        }

        .validate-btn:hover {
            background: rgba(0, 245, 255, 0.3);
            transform: translateY(-1px);
        }

        .input-hint {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .install-options {
            margin: 25px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .option-group {
            margin-bottom: 15px;
        }

        .option-group:last-child {
            margin-bottom: 0;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
        }

        .option-checkbox {
            display: none;
        }

        .checkmark {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            position: relative;
            transition: all 0.3s ease;
        }

        .option-checkbox:checked + .checkmark {
            background: var(--neon-glow);
            border-color: var(--neon-glow);
        }

        .option-checkbox:checked + .checkmark::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-weight: bold;
            font-size: 12px;
        }

        .install-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .install-btn,
        .clear-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .install-btn.primary {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
        }

        .install-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .clear-btn.secondary {
            background: rgba(108, 117, 125, 0.8);
            color: white;
        }

        .clear-btn.secondary:hover {
            background: rgba(108, 117, 125, 1);
            transform: translateY(-1px);
        }

        /* 安装进度样式 */
        .progress-content {
            text-align: center;
        }

        .progress-info {
            margin-bottom: 20px;
        }

        .progress-text {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .progress-details {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .progress-bar-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-glow), #00ff88);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-percentage {
            color: var(--neon-glow);
            font-weight: 500;
            min-width: 40px;
            text-align: right;
        }

        .progress-actions {
            display: flex;
            justify-content: center;
        }

        .cancel-btn {
            padding: 10px 20px;
            background: rgba(220, 53, 69, 0.8);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cancel-btn:hover {
            background: rgba(220, 53, 69, 1);
            transform: translateY(-1px);
        }

        /* 安装历史样式 */
        .history-content {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-empty {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .history-empty i {
            font-size: 24px;
            opacity: 0.5;
        }

        .history-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            border-color: rgba(0, 245, 255, 0.3);
            background: rgba(0, 245, 255, 0.05);
        }

        .history-item:last-child {
            margin-bottom: 0;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-name {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }

        .history-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .history-status.success {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .history-status.failed {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .history-status.installing {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .history-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .history-url {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 15px;
        }

        .history-time {
            white-space: nowrap;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .manual-install-container {
                padding: 15px;
            }

            .input-container {
                flex-direction: column;
                align-items: stretch;
            }

            .validate-btn {
                margin-top: 10px;
            }

            .install-actions {
                flex-direction: column;
            }

            .progress-bar-container {
                flex-direction: column;
                gap: 10px;
            }

            .progress-percentage {
                text-align: center;
            }

            .history-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .history-details {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }

        .plugin-btn-switch {
            border-color: rgba(255, 165, 0, 0.5);
            color: #ffa500;
        }

        .plugin-btn-switch:hover {
            background: rgba(255, 165, 0, 0.1);
            border-color: #ffa500;
        }

        .plugin-btn-toggle {
            border-color: rgba(0, 245, 255, 0.5);
            color: var(--neon-glow);
        }

        .plugin-btn-toggle:hover {
            background: rgba(0, 245, 255, 0.1);
            border-color: var(--neon-glow);
        }

        .plugin-btn-toggle.disabled {
            border-color: rgba(255, 100, 100, 0.5);
            color: #ff6464;
        }

        .plugin-btn-toggle.disabled:hover {
            background: rgba(255, 100, 100, 0.1);
            border-color: #ff6464;
        }

        .plugin-btn-uninstall {
            border-color: rgba(255, 100, 100, 0.5);
            color: #ff6464;
        }

        .plugin-btn-uninstall:hover {
            background: rgba(255, 100, 100, 0.1);
            border-color: #ff6464;
        }

        /* 新插件安装样式 */
        .install-plugins {
            display: none;
        }

        .install-plugins.active {
            display: block;
        }

        .plugin-search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .plugin-search-input {
            flex: 1;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .plugin-search-input:focus {
            outline: none;
            border-color: var(--neon-glow);
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.3);
        }

        .plugin-category-select {
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            min-width: 150px;
        }

        .available-plugin-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: rgba(26, 26, 46, 0.4);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 10px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .available-plugin-item:hover {
            border-color: rgba(0, 245, 255, 0.4);
            background: rgba(26, 26, 46, 0.6);
        }

        .available-plugin-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .available-plugin-name {
            color: var(--neon-glow);
            font-size: 1rem;
            font-weight: 600;
            text-shadow: 0 0 5px var(--neon-glow);
            min-width: 250px;
        }

        .plugin-author {
            color: var(--text-secondary);
            font-size: 0.85rem;
            min-width: 120px;
        }

        .plugin-stars {
            color: #ffa500;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 80px;
        }

        .plugin-btn-install {
            border-color: rgba(0, 200, 100, 0.5);
            color: #00c864;
        }

        .plugin-btn-install:hover {
            background: rgba(0, 200, 100, 0.1);
            border-color: #00c864;
        }

        /* 版本切换模态框 */
        .version-switch-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 15000;
            animation: modalFadeIn 0.3s ease;
        }

        .version-switch-modal.show {
            display: flex;
        }

        .version-switch-content {
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid var(--neon-glow);
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            box-shadow: 0 0 30px rgba(0, 245, 255, 0.3);
        }

        .version-switch-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .version-switch-header h3 {
            color: var(--neon-glow);
            margin: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px var(--neon-glow);
        }

        .version-close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .version-close-btn:hover {
            color: var(--text-primary);
        }



        .version-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .version-number {
            color: var(--neon-glow);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* 插件管理加载状态 */
        .plugin-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* 按钮加载状态样式 - 统一的点点点动画 */
        .btn-loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .btn-loading .btn-text {
            position: relative;
        }

        /* 点点点动画效果 */
        .btn-loading .btn-text::after {
            content: '';
            display: inline-block;
            animation: loading-dots 1.5s infinite;
        }

        @keyframes loading-dots {
            0%, 20% {
                content: '';
            }
            25%, 45% {
                content: '.';
            }
            50%, 70% {
                content: '..';
            }
            75%, 95% {
                content: '...';
            }
            100% {
                content: '';
            }
        }

        .plugin-loading {
            gap: 15px;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 245, 255, 0.2);
            border-top: 3px solid var(--neon-glow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .plugin-list {
            display: none;
        }

        .plugin-list.show {
            display: block;
        }

        /* 插件版本切换模态框样式 */
        .version-switch-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 15000;
            animation: modalFadeIn 0.3s ease;
        }

        .version-switch-modal.show {
            display: flex;
        }

        .version-switch-content {
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid var(--neon-glow);
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow: 0 0 30px rgba(0, 245, 255, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .version-switch-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(0, 245, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .version-switch-header h3 {
            color: var(--neon-glow);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            text-shadow: 0 0 10px var(--neon-glow);
        }

        .close-btn {
            background: transparent;
            border: 1px solid rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: #ff4757;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255, 0, 0, 0.1);
            border-color: #ff4757;
            transform: scale(1.1);
        }

        .version-switch-list {
            max-height: 50vh;
            overflow-y: auto;
            padding: 15px 25px 25px;
        }

        .version-switch-list .version-item {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .version-switch-list .version-item:hover {
            border-color: rgba(0, 245, 255, 0.4);
            background: rgba(26, 26, 46, 0.8);
        }

        .version-switch-list .version-item.current {
            border-color: var(--neon-glow);
            background: rgba(0, 245, 255, 0.03);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.3);
        }

        /* 自定义确认对话框样式 */
        .custom-confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .custom-confirm-content {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 12px;
            min-width: 400px;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: confirmFadeIn 0.3s ease-out;
        }

        @keyframes confirmFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .custom-confirm-header {
            padding: 20px 20px 0 20px;
            border-bottom: 1px solid #444;
            margin-bottom: 20px;
        }

        .custom-confirm-header h3 {
            margin: 0;
            color: #fff;
            font-size: 18px;
            font-weight: 600;
        }

        .custom-confirm-body {
            padding: 0 20px 20px 20px;
            color: #ccc;
            line-height: 1.6;
        }

        .custom-confirm-body p {
            margin: 0;
            font-size: 14px;
        }

        .custom-confirm-footer {
            padding: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            border-top: 1px solid #444;
        }

        .custom-confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        .custom-confirm-btn.cancel {
            background: #444;
            color: #ccc;
        }

        .custom-confirm-btn.cancel:hover {
            background: #555;
            color: #fff;
        }

        .custom-confirm-btn.confirm {
            background: #00ff88;
            color: #000;
        }

        .custom-confirm-btn.confirm:hover {
            background: #00e67a;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="launcher-container">
        <!-- 背景图片 -->
        <div class="background-container">
            <img id="backgroundImage" class="background-image" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxyYWRpYWxHcmFkaWVudCBpZD0iZ3JhZGllbnQiIGN4PSI1MCUiIGN5PSI1MCUiIHI9IjUwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMwZjRjNzUiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI1MCUiIHN0b3AtY29sb3I9IiMxNjIxM2UiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjMGEwYTBmIi8+CiAgICA8L3JhZGlhbEdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2dyYWRpZW50KSIvPgo8L3N2Zz4=" alt="Default Background">
            <video id="backgroundVideo" class="background-video" autoplay muted loop>
                <source src="" type="video/mp4">
                <source src="" type="video/webm">
            </video>
            <div class="background-overlay"></div>
        </div>



        <!-- 内容层 -->
        <div class="content-layer">
            <!-- 顶部标题 -->
            <div class="header-section">
                <h1 class="app-title">AI视界</h1>
                <p class="app-subtitle">Create New Visual Horizons with AI</p>
            </div>

            <!-- 功能导航标签 -->
            <nav class="navigation-tabs">
                <button class="tab-btn active" data-tab="home">主页</button>
                <button class="tab-btn" data-tab="launch-settings">启动设置</button>
                <button class="tab-btn" data-tab="version-management">版本管理</button>
                <button class="tab-btn" data-tab="plugin-management">插件管理</button>
                <button class="tab-btn" data-tab="environment-config">环境配置</button>
                <button class="tab-btn" data-tab="settings">设置</button>
            </nav>

            <!-- 主内容区域 -->
            <div class="main-content">
                <!-- 主页面内容 -->
                <div class="main-home" id="mainHome">
                    <!-- 底部启动区域 -->
                    <div class="launch-section">
                        <button class="launch-btn" id="launchBtn">
                            <i class="fas fa-rocket"></i>
                            启动 COMFYUI
                        </button>

                        <!-- 打开浏览器按钮 -->
                        <button class="browser-btn" id="browserBtn" style="display: none;">
                            <i class="fas fa-external-link-alt"></i>
                            打开浏览器
                        </button>

                        <!-- 显卡信息 -->
                        <div class="gpu-info" id="gpuInfo">
                            <div class="gpu-details">
                                <div class="gpu-icon-container">
                                    <i class="fas fa-microchip gpu-icon"></i>
                                    <div class="rotating-ring"></div>
                                </div>
                                <div class="gpu-text">
                                    <span class="gpu-name" id="gpuName">检测中...</span>
                                    <span class="gpu-usage" id="gpuUsage">显存: 0GB / 16GB</span>
                                </div>
                            </div>
                            <div class="gpu-status" id="gpuStatus">45%</div>
                        </div>
                    </div>
                </div>

                <!-- 启动设置页面 -->
                <div id="launch-settings" class="tab-content">
                <div class="launch-settings-container">
                    <!-- 快速配置预设 -->
                    <section class="preset-section">
                        <h3>快速配置预设</h3>
                        <div class="preset-cards">
                            <div class="preset-card" data-preset="high-end">
                                <h4>高端显卡 (16GB+)</h4>
                                <p>--highvram --use-flash-attention --bf16-unet</p>
                            </div>
                            <div class="preset-card" data-preset="mid-range">
                                <h4>中端显卡 (8-16GB)</h4>
                                <p>--normalvram --use-pytorch-cross-attention</p>
                            </div>
                            <div class="preset-card" data-preset="low-end">
                                <h4>低端显卡 (4-8GB)</h4>
                                <p>--lowvram --use-split-cross-attention</p>
                            </div>
                        </div>
                    </section>

                    <!-- 显存优化 -->
                    <section class="memory-section">
                        <h3><i class="fas fa-memory"></i> 显存优化</h3>
                        <div class="memory-mode-selector">
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="vram-mode" value="gpu-only" id="gpu-only">
                                    <span>GPU专用模式</span>
                                    <small>所有模型保持在GPU (需大显存)</small>
                                </label>

                                <label class="radio-item">
                                    <input type="radio" name="vram-mode" value="highvram" id="highvram" checked>
                                    <span>高显存模式</span>
                                    <small>模型保持在GPU内存中 (推荐)</small>
                                </label>

                                <label class="radio-item">
                                    <input type="radio" name="vram-mode" value="normalvram" id="normalvram">
                                    <span>普通模式</span>
                                    <small>平衡显存使用</small>
                                </label>

                                <label class="radio-item">
                                    <input type="radio" name="vram-mode" value="lowvram" id="lowvram">
                                    <span>低显存模式</span>
                                    <small>拆分UNet减少显存使用</small>
                                </label>

                                <label class="radio-item">
                                    <input type="radio" name="vram-mode" value="cpu" id="cpu">
                                    <span>CPU模式</span>
                                    <small>所有计算在CPU (显存不足时)</small>
                                </label>
                            </div>
                        </div>

                        <div class="advanced-memory">
                            <div class="setting-item horizontal">
                                <label>预留显存 (GB)</label>
                                <div class="input-with-hint">
                                    <input type="number" id="reserve-vram" step="0.5" min="0" max="16" value="0">
                                    <small class="hint">为系统预留的显存大小</small>
                                </div>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="async-offload">
                                <label for="async-offload">异步权重卸载</label>
                                <small class="hint">提升大模型加载速度</small>
                            </div>
                        </div>
                    </section>

                    <!-- 交叉注意力优化 -->
                    <section class="attention-section">
                        <h3><i class="fas fa-brain"></i> 交叉注意力优化</h3>
                        <div class="attention-selector">
                            <div class="setting-item horizontal">
                                <label>注意力优化方法</label>
                                <select id="attention-method">
                                    <option value="">默认</option>
                                    <option value="use-flash-attention">FlashAttention (推荐 - 高端显卡)</option>
                                    <option value="use-pytorch-cross-attention">PyTorch 2.0 (稳定性好)</option>
                                    <option value="use-sage-attention">Sage Attention (新技术)</option>
                                    <option value="use-split-cross-attention">分割注意力 (省显存)</option>
                                    <option value="use-quad-cross-attention">二次注意力 (兼容性好)</option>
                                </select>
                            </div>
                        </div>

                        <div class="attention-options">
                            <div class="setting-item horizontal">
                                <label>注意力上采样</label>
                                <select id="upcast-mode">
                                    <option value="">自动</option>
                                    <option value="force-upcast-attention">强制启用</option>
                                    <option value="dont-upcast-attention">禁用</option>
                                </select>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="disable-xformers">
                                <label for="disable-xformers">禁用 xformers</label>
                                <small class="hint">解决某些兼容性问题</small>
                            </div>
                        </div>
                    </section>

                    <!-- 监听设置 -->
                    <section class="network-section">
                        <h3><i class="fas fa-network-wired"></i> 监听设置</h3>
                        <div class="setting-grid">
                            <div class="setting-item horizontal">
                                <label>监听地址</label>
                                <div class="input-with-hint">
                                    <select id="listen-ip">
                                        <option value="127.0.0.1">127.0.0.1 (仅本机访问)</option>
                                        <option value="0.0.0.0">0.0.0.0 (允许外部访问)</option>
                                    </select>
                                    <small class="hint">选择0.0.0.0可通过局域网访问</small>
                                </div>
                            </div>
                            <div class="setting-item horizontal">
                                <label>端口</label>
                                <div class="input-with-hint">
                                    <input type="number" id="port" value="8188" min="1" max="65535">
                                    <small class="hint">Web界面访问端口</small>
                                </div>
                            </div>
                            <div class="setting-item horizontal">
                                <label>CORS设置</label>
                                <div class="input-with-hint">
                                    <select id="cors-setting">
                                        <option value="">禁用</option>
                                        <option value="enable-cors-header">启用跨域支持</option>
                                    </select>
                                    <small class="hint">API调用时需要启用</small>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 代理设置 -->
                    <section class="proxy-section">
                        <h3><i class="fas fa-globe"></i> 代理设置</h3>
                        <div class="proxy-settings">
                            <div class="checkbox-item">
                                <input type="checkbox" id="enable-proxy">
                                <label for="enable-proxy">启用代理</label>
                                <small class="hint">用于模型下载和API访问</small>
                            </div>
                            <div class="proxy-inputs" id="proxy-inputs" style="display: none;">
                                <div class="setting-item horizontal">
                                    <label>HTTP代理</label>
                                    <input type="text" id="http-proxy" placeholder="http://proxy.example.com:8080">
                                </div>
                                <div class="setting-item horizontal">
                                    <label>HTTPS代理</label>
                                    <input type="text" id="https-proxy" placeholder="https://proxy.example.com:8080">
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 命令预览 -->
                    <section class="preview-section">
                        <h3><i class="fas fa-terminal"></i> 启动命令预览</h3>
                        <div class="command-preview" id="command-preview">
                            python main.py --listen 127.0.0.1 --port 8188 --highvram
                        </div>
                    </section>

                    <!-- 操作按钮 -->
                    <section class="actions-section">
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="saveSettings()">
                                <i class="fas fa-save"></i> 保存配置
                            </button>
                            <button class="btn btn-success" onclick="applyAndLaunch()">
                                <i class="fas fa-rocket"></i> 应用并启动
                            </button>
                            <button class="btn btn-warning" onclick="resetToDefault()">
                                <i class="fas fa-undo"></i> 重置默认
                            </button>
                        </div>
                    </section>
                </div>
                </div>

                <!-- 版本管理页面 -->
                <div id="version-management" class="tab-content">
                <div class="version-management-container">
                    <!-- 页面头部 -->
                    <div class="version-header">
                        <h2><i class="fas fa-code-branch"></i> 版本管理</h2>
                        <button class="refresh-versions-btn" onclick="launcherInstance.forceRefreshVersions()" title="刷新版本数据">
                            <i class="fas fa-sync-alt"></i> 刷新
                        </button>
                    </div>

                    <!-- 版本类型切换 -->
                    <div class="version-tabs">
                        <button class="version-tab-btn active" data-type="stable">
                            <i class="fas fa-shield-alt"></i> 稳定版
                        </button>
                        <button class="version-tab-btn" data-type="development">
                            <i class="fas fa-flask"></i> 开发版
                        </button>
                    </div>

                    <!-- 版本列表容器 -->
                    <div class="version-list-container">
                        <!-- 加载状态 -->
                        <div class="version-loading" id="version-loading">
                            <div class="loading-spinner"></div>
                            <div class="loading-content">
                                <span id="version-loading-text">正在加载版本信息...</span>
                                <div class="loading-progress-bar">
                                    <div class="loading-progress-fill" id="version-progress-fill"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 稳定版列表 -->
                        <div class="version-list" id="stable-versions">
                            <!-- 动态生成内容 -->
                        </div>

                        <!-- 开发版列表 -->
                        <div class="version-list" id="development-versions" style="display: none;">
                            <!-- 动态生成内容 -->
                        </div>
                    </div>
                </div>

                <!-- 版本切换确认对话框 -->
                <div class="version-modal" id="version-confirm-modal">
                    <div class="modal-content">
                        <h3><i class="fas fa-exclamation-triangle"></i> 确认版本切换</h3>
                        <p id="modal-message">确定要切换到版本 <span id="target-version"></span> 吗？</p>
                        <div class="modal-actions">
                            <button class="btn btn-warning" onclick="if(window.audioManager) audioManager.play('click'); cancelVersionSwitch()">取消</button>
                            <button class="btn btn-primary" onclick="if(window.audioManager) audioManager.play('click'); confirmVersionSwitch()">确认切换</button>
                        </div>
                    </div>
                </div>

                <!-- 切换进度对话框 -->
                <div class="version-modal" id="version-progress-modal">
                    <div class="modal-content">
                        <h3><i class="fas fa-sync-alt fa-spin"></i> 正在切换版本</h3>
                        <p id="progress-message">正在切换到版本 <span id="progress-version"></span>...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <small>请稍候，不要关闭页面</small>
                    </div>
                </div>
                </div>

                <!-- 插件管理页面 -->
                <div id="plugin-management" class="tab-content">
                    <div class="plugin-management-container">
                        <!-- 页面头部 -->
                        <div class="plugin-header">
                            <h2><i class="fas fa-puzzle-piece"></i> 插件管理</h2>
                        </div>

                        <!-- 插件类型切换 -->
                        <div class="plugin-tabs">
                            <button class="plugin-tab-btn active" data-type="installed">
                                <i class="fas fa-check-circle"></i> 已安装
                            </button>
                            <button class="plugin-tab-btn" data-type="available">
                                <i class="fas fa-download"></i> 安装新插件
                            </button>
                            <button class="plugin-tab-btn" data-type="manual">
                                <i class="fas fa-code-branch"></i> 手动安装
                            </button>
                        </div>

                        <!-- 插件内容容器 -->
                        <div class="plugin-content">
                            <!-- 已安装插件列表 -->
                            <div class="installed-plugins active" id="installed-plugins">
                                <div class="plugin-loading" id="installed-loading" style="display: flex;">
                                    <div class="loading-spinner"></div>
                                    <div class="loading-content">
                                        <span id="installed-loading-text">正在加载已安装插件...</span>
                                        <div class="loading-progress-bar">
                                            <div class="loading-progress-fill" id="installed-progress-fill"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="plugin-list" id="installed-plugin-list" style="display: none;">
                                    <!-- 插件列表将在这里动态生成 -->
                                </div>
                            </div>

                            <!-- 可安装插件列表 -->
                            <div class="available-plugins" id="available-plugins" style="display: none;">
                                <!-- 搜索和过滤工具栏 -->
                                <div class="plugin-toolbar">
                                    <div class="search-container">
                                        <input type="text" id="plugin-search" placeholder="搜索插件名称、作者或描述..." class="search-input">
                                        <i class="fas fa-search search-icon"></i>
                                    </div>
                                    <div class="filter-container">
                                        <select id="category-filter" class="category-select">
                                            <option value="">所有分类</option>
                                            <option value="image">图像处理</option>
                                            <option value="video">视频处理</option>
                                            <option value="audio">音频处理</option>
                                            <option value="ai">AI模型</option>
                                            <option value="3d">3D相关</option>
                                            <option value="tool">工具类</option>
                                            <option value="other">其他</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="plugin-loading" id="available-loading" style="display: none;">
                                    <div class="loading-spinner"></div>
                                    <div class="loading-content">
                                        <span id="available-loading-text">正在加载可安装插件...</span>
                                        <div class="loading-progress-bar">
                                            <div class="loading-progress-fill" id="available-progress-fill"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="plugin-list" id="available-plugin-list">
                                    <!-- 可安装插件列表将在这里动态生成 -->
                                </div>
                            </div>

                            <!-- 手动安装插件 -->
                            <div class="manual-install-plugins" id="manual-install-plugins" style="display: none;">
                                <div class="manual-install-container">

                                    <!-- 安装表单 -->
                                    <div class="manual-install-form">
                                        <div class="form-card">
                                            <h3><i class="fas fa-download"></i> 安装插件</h3>
                                            <div class="form-content">
                                                <div class="input-group">
                                                    <label for="plugin-url">Git仓库地址</label>
                                                    <div class="input-container">
                                                        <input type="url"
                                                               id="plugin-url"
                                                               placeholder="请输入Git仓库地址，例如：https://github.com/username/repository"
                                                               class="url-input">
                                                        <button class="validate-btn" onclick="validatePluginUrl()" title="验证地址">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                    </div>
                                                    <div class="input-hint" id="url-hint">
                                                        <i class="fas fa-lightbulb"></i>
                                                        <span>支持GitHub、GitLab、Gitee等Git仓库地址</span>
                                                    </div>
                                                </div>



                                                <div class="install-options">
                                                    <div class="option-group">
                                                        <label class="checkbox-label">
                                                            <input type="checkbox" id="force-install" class="option-checkbox">
                                                            <span class="checkmark"></span>
                                                            <span class="option-text">强制安装（覆盖已存在的插件）</span>
                                                        </label>
                                                    </div>
                                                    <div class="option-group">
                                                        <label class="checkbox-label">
                                                            <input type="checkbox" id="shallow-clone" class="option-checkbox" checked>
                                                            <span class="checkmark"></span>
                                                            <span class="option-text">浅克隆（仅下载最新版本，节省空间）</span>
                                                        </label>
                                                    </div>
                                                </div>

                                                <div class="install-actions">
                                                    <button class="install-btn primary" onclick="installManualPlugin()">
                                                        <i class="fas fa-download"></i>
                                                        开始安装
                                                    </button>
                                                    <button class="clear-btn secondary" onclick="clearManualInstallForm()">
                                                        <i class="fas fa-eraser"></i>
                                                        清空表单
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 安装进度 -->
                                    <div class="install-progress" id="manual-install-progress" style="display: none;">
                                        <div class="progress-card">
                                            <h3><i class="fas fa-spinner fa-spin"></i> 正在安装插件</h3>
                                            <div class="progress-content">
                                                <div class="progress-info">
                                                    <div class="progress-text" id="progress-text">准备安装...</div>
                                                    <div class="progress-details" id="progress-details"></div>
                                                </div>
                                                <div class="progress-bar-container">
                                                    <div class="progress-bar">
                                                        <div class="progress-fill" id="manual-progress-fill"></div>
                                                    </div>
                                                    <div class="progress-percentage" id="progress-percentage">0%</div>
                                                </div>
                                                <div class="progress-actions">
                                                    <button class="cancel-btn" onclick="cancelManualInstall()">
                                                        <i class="fas fa-times"></i>
                                                        取消安装
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 环境配置页面 -->
                <div id="environment-config" class="tab-content">
                    <div class="environment-container">
                        <!-- 环境配置子标签导航 -->
                        <div class="environment-tabs">
                            <button class="environment-tab-btn active" onclick="switchEnvironmentTab('env-info')">
                                <i class="fas fa-info-circle"></i>
                                环境信息
                            </button>
                            <button class="environment-tab-btn" onclick="switchEnvironmentTab('env-terminal')">
                                <i class="fas fa-terminal"></i>
                                项目终端
                            </button>
                        </div>

                        <!-- 环境信息标签页 -->
                        <div id="env-info" class="environment-tab-content active">
                            <div class="env-info-grid">
                                <!-- Python环境信息 -->
                                <div class="env-info-card">
                                    <h4><i class="fab fa-python"></i> Python环境</h4>
                                    <div class="env-info-list">
                                        <div class="env-info-item">
                                            <span class="env-label">Python版本:</span>
                                            <span class="env-value" id="python-version">检测中...</span>
                                        </div>
                                        <div class="env-info-item">
                                            <span class="env-label">Python路径:</span>
                                            <span class="env-value" id="python-path">检测中...</span>
                                        </div>
                                        <div class="env-info-item">
                                            <span class="env-label">虚拟环境:</span>
                                            <span class="env-value" id="venv-status">检测中...</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- CUDA环境信息 -->
                                <div class="env-info-card">
                                    <h4><i class="fas fa-microchip"></i> CUDA环境</h4>
                                    <div class="env-info-list">
                                        <div class="env-info-item">
                                            <span class="env-label">CUDA版本:</span>
                                            <span class="env-value" id="cuda-version">检测中...</span>
                                        </div>
                                        <div class="env-info-item">
                                            <span class="env-label">GPU设备:</span>
                                            <span class="env-value" id="gpu-info">检测中...</span>
                                        </div>
                                        <div class="env-info-item">
                                            <span class="env-label">显存信息:</span>
                                            <span class="env-value" id="gpu-memory">检测中...</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- PyTorch环境信息 -->
                                <div class="env-info-card">
                                    <h4><i class="fas fa-fire"></i> PyTorch环境</h4>
                                    <div class="env-info-list">
                                        <div class="env-info-item">
                                            <span class="env-label">PyTorch版本:</span>
                                            <span class="env-value" id="pytorch-version">检测中...</span>
                                        </div>
                                        <div class="env-info-item">
                                            <span class="env-label">CUDA支持:</span>
                                            <span class="env-value" id="pytorch-cuda">检测中...</span>
                                        </div>
                                        <div class="env-info-item">
                                            <span class="env-label">设备状态:</span>
                                            <span class="env-value" id="pytorch-device">检测中...</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 依赖状态信息 -->
                                <div class="env-info-card">
                                    <h4><i class="fas fa-puzzle-piece"></i> 依赖状态</h4>
                                    <div class="env-info-list">
                                        <div class="env-info-item">
                                            <span class="env-label">核心依赖:</span>
                                            <span class="env-value" id="core-deps">检测中...</span>
                                        </div>
                                        <div class="env-info-item">
                                            <span class="env-label">可选依赖:</span>
                                            <span class="env-value" id="optional-deps">检测中...</span>
                                        </div>
                                        <div class="env-info-item">
                                            <span class="env-label">环境状态:</span>
                                            <span class="env-value" id="env-status">检测中...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 刷新按钮 -->
                            <div class="env-actions">
                                <button class="env-refresh-btn" onclick="refreshEnvironmentInfo()">
                                    <i class="fas fa-sync-alt"></i>
                                    刷新环境信息
                                </button>
                            </div>
                        </div>

                        <!-- 项目终端标签页 -->
                        <div id="env-terminal" class="environment-tab-content">
                            <div class="terminal-container">
                                <div class="terminal-header">
                                    <h4><i class="fas fa-terminal"></i> ComfyUI项目终端</h4>
                                    <div class="terminal-controls">
                                        <button class="terminal-btn" onclick="clearTerminal()">
                                            <i class="fas fa-trash"></i>
                                            清空
                                        </button>
                                    </div>
                                </div>
                                <div class="terminal-content" id="project-terminal">
                                    <div class="terminal-welcome">
                                        <p><i class="fas fa-info-circle"></i> ComfyUI项目虚拟环境终端</p>
                                        <p>当前工作目录: <span id="terminal-cwd">检测中...</span></p>
                                        <p>虚拟环境: <span id="terminal-venv">检测中...</span></p>
                                        <p>Python版本: <span id="terminal-python">检测中...</span></p>
                                        <p>环境状态: <span id="terminal-status">检测中...</span></p>
                                        <hr>
                                        <p>可用命令示例:</p>
                                        <ul>
                                            <li><code>help</code> - 查看所有可用命令</li>
                                            <li><code>pip list</code> - 查看已安装包</li>
                                            <li><code>python --version</code> - 查看Python版本</li>
                                            <li><code>git status</code> - 查看Git状态</li>
                                            <li><code>nvidia-smi</code> - 查看GPU信息</li>
                                        </ul>
                                    </div>
                                    <div class="terminal-output" id="terminal-output">
                                        <!-- 终端输出将在这里显示 -->
                                    </div>
                                    <div class="terminal-input-line">
                                        <span class="terminal-prompt" id="terminal-prompt">cmd> </span>
                                        <input type="text" class="terminal-input" id="terminal-input" placeholder="输入命令..." onkeypress="handleTerminalInput(event)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 设置页面 -->
                <div id="settings" class="tab-content">
                    <div class="content-header">
                        <h2><i class="fas fa-cog"></i> 设置</h2>
                    </div>

                    <div class="settings-container">
                        <!-- 卡片式网格布局 -->
                        <div class="settings-cards-grid">
                            <!-- 界面个性化卡片 -->
                            <div class="settings-card">
                                <div class="settings-card-header">
                                    <h3><i class="fas fa-palette"></i> 界面个性化</h3>
                                    <p>自定义启动器的外观和主题</p>
                                </div>

                                <div class="settings-card-content">
                                    <!-- 背景设置 -->
                                    <div class="settings-group">
                                        <h4><i class="fas fa-image"></i> 背景设置</h4>
                                        <div class="settings-items">
                                            <div class="setting-item compact">
                                                <label>背景图片</label>
                                                <button class="upload-btn compact" onclick="document.getElementById('backgroundImageUpload').click()">
                                                    <i class="fas fa-upload"></i> 选择图片
                                                </button>
                                                <input type="file" id="backgroundImageUpload" accept="image/*" style="display: none;">
                                            </div>

                                            <div class="setting-item compact">
                                                <label>背景视频</label>
                                                <button class="upload-btn compact" onclick="document.getElementById('backgroundVideoUpload').click()">
                                                    <i class="fas fa-video"></i> 选择视频
                                                </button>
                                                <input type="file" id="backgroundVideoUpload" accept="video/*" style="display: none;">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 主题设置 -->
                                    <div class="settings-group">
                                        <h4><i class="fas fa-paint-brush"></i> 主题设置</h4>
                                        <div class="settings-items">
                                            <div class="setting-item compact">
                                                <label>霓虹色彩主题</label>
                                                <div class="theme-selector compact">
                                                    <button class="theme-btn active compact" data-theme="blue" onclick="switchTheme('blue')">
                                                        <span class="theme-color" style="background: #00f5ff;"></span>
                                                        蓝色
                                                    </button>
                                                    <button class="theme-btn compact" data-theme="green" onclick="switchTheme('green')">
                                                        <span class="theme-color" style="background: #00ff88;"></span>
                                                        绿色
                                                    </button>
                                                    <button class="theme-btn compact" data-theme="purple" onclick="switchTheme('purple')">
                                                        <span class="theme-color" style="background: #8a2be2;"></span>
                                                        紫色
                                                    </button>
                                                    <button class="theme-btn compact" data-theme="red" onclick="switchTheme('red')">
                                                        <span class="theme-color" style="background: #ff4757;"></span>
                                                        红色
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 启动器管理卡片 -->
                            <div class="settings-card">
                                <div class="settings-card-header">
                                    <h3><i class="fas fa-rocket"></i> 启动器管理</h3>
                                    <p>管理启动器的更新和版本信息</p>
                                </div>

                                <div class="settings-card-content">
                                    <!-- 更新设置 -->
                                    <div class="settings-group">
                                        <h4><i class="fas fa-sync-alt"></i> 更新设置</h4>
                                        <div class="settings-items">
                                            <div class="setting-item">
                                                <label>检查更新</label>
                                                <button class="action-btn primary" id="check-launcher-update-btn" onclick="checkLauncherUpdate()">
                                                    <i class="fas fa-search"></i> 检查更新
                                                </button>
                                            </div>

                                            <div class="setting-item">
                                                <label>自动更新</label>
                                                <div class="toggle-switch">
                                                    <input type="checkbox" id="autoUpdate" checked>
                                                    <label for="autoUpdate" class="toggle-label"></label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 版本信息 -->
                                    <div class="settings-group">
                                        <h4><i class="fas fa-info-circle"></i> 版本信息</h4>
                                        <div class="info-list">
                                            <div class="info-item">
                                                <span class="info-label">当前版本</span>
                                                <span class="info-value">v1.0.0</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">最后更新</span>
                                                <span class="info-value">2025-01-06</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 系统设置卡片 -->
                            <div class="settings-card">
                                <div class="settings-card-header">
                                    <h3><i class="fas fa-cogs"></i> 系统设置</h3>
                                    <p>配置系统启动和运行选项</p>
                                </div>

                                <div class="settings-card-content">
                                    <!-- 启动设置 -->
                                    <div class="settings-group">
                                        <h4><i class="fas fa-power-off"></i> 启动设置</h4>
                                        <div class="settings-items">
                                            <div class="setting-item">
                                                <label>开机自启动</label>
                                                <div class="toggle-switch">
                                                    <input type="checkbox" id="autoStart">
                                                    <label for="autoStart" class="toggle-label"></label>
                                                </div>
                                            </div>

                                            <div class="setting-item">
                                                <label>最小化到托盘</label>
                                                <div class="toggle-switch">
                                                    <input type="checkbox" id="minimizeToTray" checked>
                                                    <label for="minimizeToTray" class="toggle-label"></label>
                                                </div>
                                            </div>

                                            <div class="setting-item">
                                                <label>启动时检查状态</label>
                                                <div class="toggle-switch">
                                                    <input type="checkbox" id="checkComfyUIOnStart" checked>
                                                    <label for="checkComfyUIOnStart" class="toggle-label"></label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 快捷方式设置 -->
                                    <div class="settings-group">
                                        <h4><i class="fas fa-desktop"></i> 快捷方式</h4>
                                        <div class="settings-items">
                                            <div class="setting-item">
                                                <label>创建桌面快捷方式</label>
                                                <button class="action-btn primary" onclick="createDesktopShortcut(event)">
                                                    <i class="fas fa-plus"></i> 创建快捷方式
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- 声音设置 -->
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h3><i class="fas fa-volume-up"></i> 声音设置</h3>
                        </div>
                        <div class="settings-card-content">
                            <div class="settings-group">
                                <div class="settings-items">
                                    <div class="setting-item">
                                        <label>启用背景视频声音</label>
                                        <input type="checkbox" id="video-audio-enabled">
                                    </div>
                                    <div class="setting-item">
                                        <label>视频音量</label>
                                        <input type="range" id="video-volume" min="0" max="100" value="30" style="width: 150px;">
                                        <span id="video-volume-display">30%</span>
                                    </div>
                                    <div class="setting-item">
                                        <label>启用音效</label>
                                        <input type="checkbox" id="audio-enabled" checked>
                                    </div>
                                    <div class="setting-item">
                                        <label>音效音量</label>
                                        <input type="range" id="audio-volume" min="0" max="100" value="50" style="width: 150px;">
                                        <span id="volume-display">50%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 开发者选项卡片 -->
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h3><i class="fas fa-code"></i> 开发者选项</h3>
                            <p>调试和开发相关的设置选项</p>
                        </div>

                        <div class="settings-card-content">
                            <!-- 日志设置 -->
                            <div class="settings-group">
                                <h4><i class="fas fa-terminal"></i> 日志设置</h4>
                                <div class="settings-items">
                                    <div class="setting-item">
                                        <label>日志级别</label>
                                        <select id="logLevelSelect" class="form-select">
                                            <option value="0">关闭</option>
                                            <option value="1">错误</option>
                                            <option value="2">警告</option>
                                            <option value="3" selected>信息</option>
                                            <option value="4">调试</option>
                                        </select>
                                    </div>
                                    <div class="setting-item">
                                        <label>清空控制台日志</label>
                                        <button class="action-btn secondary" onclick="console.clear(); logger.info('控制台已清空')">
                                            <i class="fas fa-trash"></i> 清空日志
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- 插件版本切换对话框 - 放在body顶层 -->
    <div class="version-switch-modal" id="version-switch-modal" onclick="closeVersionSwitchModal()">
        <div class="version-switch-content" onclick="event.stopPropagation()">
            <div class="version-switch-header">
                <h3><i class="fas fa-code-branch"></i> 选择插件版本</h3>
                <button class="close-btn" onclick="closeVersionSwitchModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="version-switch-list" id="version-switch-list">
                <!-- 版本列表将由JavaScript动态生成 -->
            </div>
        </div>
    </div>



    <script>
        // 日志管理系统
        class Logger {
            constructor() {
                // 日志级别：0=关闭, 1=错误, 2=警告, 3=信息, 4=调试
                this.level = this.getLogLevel();
                this.prefix = '[AI-Vision]';
            }

            getLogLevel() {
                // 从localStorage读取日志级别，默认为信息级别
                const saved = localStorage.getItem('ai-vision-log-level');
                return saved ? parseInt(saved) : 3;
            }

            setLogLevel(level) {
                this.level = level;
                localStorage.setItem('ai-vision-log-level', level.toString());
                console.log(`${this.prefix} 日志级别设置为: ${this.getLevelName(level)}`);
            }

            getLevelName(level) {
                const names = ['关闭', '错误', '警告', '信息', '调试'];
                return names[level] || '未知';
            }

            error(...args) {
                if (this.level >= 1) console.error(`${this.prefix} [ERROR]`, ...args);
            }

            warn(...args) {
                if (this.level >= 2) console.warn(`${this.prefix} [WARN]`, ...args);
            }

            info(...args) {
                if (this.level >= 3) console.log(`${this.prefix} [INFO]`, ...args);
            }

            debug(...args) {
                if (this.level >= 4) console.log(`${this.prefix} [DEBUG]`, ...args);
            }

            // 特殊方法：重要操作日志（总是显示）
            important(...args) {
                console.log(`${this.prefix} [IMPORTANT]`, ...args);
            }
        }

        // 全局日志实例
        const logger = new Logger();

        class AIVisionLauncher {
            constructor() {
                logger.info('AIVisionLauncher constructor called');
                this.currentTab = 'home';
                this.isRunning = false;
                this.API_BASE = null; // 将通过electronAPI动态获取
                this.backendUrl = null; // 将通过electronAPI动态获取

                // 工作流状态监控
                this.isWorkflowRunning = false;

                // 插件标签页状态管理
                this.currentPluginTab = 'installed'; // 默认显示已安装标签页
                this.pluginDataCache = {}; // 插件数据缓存
                this.renderQueue = []; // 渲染队列
                this.isRendering = false; // 渲染状态标志

                // 虚拟滚动配置
                this.virtualScrollConfig = {
                    itemHeight: 120, // 每个插件项的估计高度
                    visibleCount: 10, // 可见区域显示的插件数量
                    bufferCount: 5   // 缓冲区插件数量
                };
                this.workflowCheckInterval = null;
                this.comfyUIWebSocket = null;

                // 版本缓存
                this.versionCache = null;
                this.versionCacheExpiry = null;
                this.versionCacheDuration = 2 * 60 * 1000; // 2分钟缓存，提高更新检测频率

                // 插件页面刷新标记
                this.needRefreshInstalledTab = false;
                this.forceRefresh = false; // 强制刷新标志

                // 性能优化：加载状态标志
                this.isLoadingInstalled = false;
                this.isLoadingAvailable = false;

                this.initEventListeners();
                this.initEventDelegation(); // 添加事件委托优化
                this.loadSavedBackground();
                this.loadSavedSettings();

                // 初始化数据加载
                this.initializeData();

                // 验证插件管理方法
                console.log('showPluginVersions method defined:', typeof this.showPluginVersions);
                console.log('Constructor complete');
            }

            async initializeData() {
                console.log('Starting data initialization...');
                try {
                    // 首先获取后端URL
                    await this.initializeBackendUrl();

                    await this.loadSystemInfo();
                    await this.loadComfyUIStatus();
                    await this.loadGitStatus();
                    await this.loadRealTimeGPUInfo(); // 初始加载GPU信息

                    // 预加载环境信息，避免用户切换到环境页面时需要等待
                    setTimeout(() => {
                        this.detectEnvironmentInfo();
                        console.log('Environment info pre-loaded');
                    }, 1000);

                    // 预加载插件信息，避免用户切换到插件页面时需要等待
                    setTimeout(() => {
                        this.preloadPluginInfo();
                        console.log('Plugin info pre-loading started');
                    }, 2000);

                    // 启动自动版本更新检查
                    setTimeout(() => {
                        this.startBackgroundUpdateCheck();
                        console.log('Background update check started');
                    }, 3000);

                    // 设置定时刷新（完全禁用ComfyUI状态自动轮询，改为手动控制）
                    // setInterval(() => this.loadComfyUIStatus(), 10000); // 禁用自动状态检查
                    setInterval(() => this.loadSystemInfo(), 5000);
                    setInterval(() => this.loadRealTimeGPUInfo(), 2000); // 每2秒更新GPU信息

                    console.log('Data initialization complete');
                } catch (error) {
                    console.error('Failed to initialize data:', error);
                }
            }

            async initializeBackendUrl() {
                try {
                    if (window.electronAPI && window.electronAPI.getBackendUrl) {
                        this.backendUrl = await window.electronAPI.getBackendUrl();
                        this.API_BASE = this.backendUrl;
                        console.log('Backend URL initialized:', this.backendUrl);
                    } else {
                        // 如果electronAPI不可用，使用默认值
                        this.backendUrl = 'http://127.0.0.1:8404';
                        this.API_BASE = this.backendUrl;
                        console.warn('electronAPI not available, using default backend URL');
                    }
                } catch (error) {
                    console.error('Failed to get backend URL from main process:', error);
                    // 使用默认值作为后备
                    this.backendUrl = 'http://127.0.0.1:8404';
                    this.API_BASE = this.backendUrl;
                }
            }

            initEventListeners() {
                console.log('initEventListeners called');

                // 标签切换
                const tabBtns = document.querySelectorAll('.tab-btn');
                console.log('Found tab buttons:', tabBtns.length);
                tabBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchTab(e.currentTarget.dataset.tab);
                    });
                });

                // 设置页面背景图片上传
                const backgroundImageUpload = document.getElementById('backgroundImageUpload');
                if (backgroundImageUpload) {
                    backgroundImageUpload.addEventListener('change', (e) => {
                        this.handleBackgroundUpload(e.target.files[0]);
                    });
                }

                // 设置页面背景视频上传
                const backgroundVideoUpload = document.getElementById('backgroundVideoUpload');
                if (backgroundVideoUpload) {
                    backgroundVideoUpload.addEventListener('change', (e) => {
                        this.handleVideoUpload(e.target.files[0]);
                    });
                }

                // 启动按钮
                const launchBtn = document.getElementById('launchBtn');
                if (launchBtn) {
                    launchBtn.addEventListener('click', () => {
                        this.toggleComfyUI();
                    });
                } else {
                    console.warn('launchBtn element not found');
                }

                // 浏览器按钮
                const browserBtn = document.getElementById('browserBtn');
                if (browserBtn) {
                    browserBtn.addEventListener('click', () => {
                        this.openComfyUIInBrowser();
                    });
                } else {
                    console.warn('browserBtn element not found');
                }

                // 专家模式按钮
                const expertBtn = document.querySelector('.expert-mode-btn');
                if (expertBtn) {
                    expertBtn.addEventListener('click', () => {
                        this.toggleExpertMode();
                    });
                } else {
                    console.warn('expert-mode-btn element not found');
                }

                // 预设卡片选择
                const presetCards = document.querySelectorAll('.preset-card');
                console.log('Found preset cards:', presetCards.length);
                presetCards.forEach(card => {
                    card.addEventListener('click', () => {
                        // 播放点击音效
                        if (window.audioManager) {
                            audioManager.play('click');
                        }
                        this.selectPreset(card.dataset.preset);
                    });
                });

                // 日志级别选择器监听
                const logLevelSelect = document.getElementById('logLevelSelect');
                if (logLevelSelect) {
                    // 设置当前日志级别
                    logLevelSelect.value = logger.level.toString();

                    logLevelSelect.addEventListener('change', (e) => {
                        const newLevel = parseInt(e.target.value);
                        logger.setLogLevel(newLevel);
                        this.showNotification(`日志级别已设置为: ${logger.getLevelName(newLevel)}`, 'success');
                    });
                }

                // 设置选项变化监听
                const settingInputs = document.querySelectorAll('input[type="radio"], input[type="checkbox"], input[type="text"], input[type="number"]');
                logger.debug('Found setting inputs:', settingInputs.length);
                settingInputs.forEach(input => {
                    input.addEventListener('change', () => {
                        // 只在启动设置页面元素存在时更新命令预览
                        if (document.getElementById('listen-ip')) {
                            this.updateCommandPreview();
                        }
                    });
                });

                // 代理设置显示/隐藏逻辑
                const enableProxyCheckbox = document.getElementById('enable-proxy');
                const proxyInputs = document.getElementById('proxy-inputs');
                if (enableProxyCheckbox && proxyInputs) {
                    enableProxyCheckbox.addEventListener('change', () => {
                        if (enableProxyCheckbox.checked) {
                            proxyInputs.style.display = 'block';
                        } else {
                            proxyInputs.style.display = 'none';
                        }
                        // 更新命令预览
                        if (document.getElementById('listen-ip')) {
                            this.updateCommandPreview();
                        }
                    });
                }

                // 版本管理标签切换将在initVersionManagement中绑定
            }

            // 事件委托优化 - 减少事件监听器数量
            initEventDelegation() {
                console.log('🚀 Initializing event delegation for performance optimization...');

                // 为插件管理容器添加事件委托
                const pluginContainer = document.getElementById('plugin-management');
                if (pluginContainer) {
                    pluginContainer.addEventListener('click', (e) => {
                        // 插件标签页切换
                        if (e.target.classList.contains('plugin-tab-btn')) {
                            e.preventDefault();
                            const tabType = e.target.dataset.type;
                            if (tabType) {
                                this.performTabSwitch(tabType);
                            }
                        }

                        // 插件操作按钮
                        if (e.target.classList.contains('plugin-action-btn')) {
                            e.preventDefault();
                            const action = e.target.dataset.action;
                            const pluginName = e.target.dataset.plugin;
                            if (action && pluginName) {
                                this.handlePluginAction(action, pluginName);
                            }
                        }
                    });

                    console.log('✅ Plugin management event delegation initialized');
                }
            }

            switchTab(tabName) {
                console.log('switchTab called with:', tabName);

                // 更新标签按钮状态
                const allTabs = document.querySelectorAll('.tab-btn');
                console.log('Found tab buttons:', allTabs.length);

                allTabs.forEach(btn => {
                    btn.classList.remove('active');
                });

                const targetTab = document.querySelector(`[data-tab="${tabName}"]`);
                console.log('Target tab found:', targetTab);

                if (targetTab) {
                    targetTab.classList.add('active');
                } else {
                    console.error('Target tab not found for:', tabName);
                }

                // 背景媒体透明度控制
                const backgroundImage = document.getElementById('backgroundImage');
                const backgroundVideo = document.getElementById('backgroundVideo');
                const mainHome = document.getElementById('mainHome');

                console.log('Elements found:', {
                    backgroundImage: !!backgroundImage,
                    backgroundVideo: !!backgroundVideo,
                    mainHome: !!mainHome
                });

                if (tabName === 'home') {
                    console.log('Switching to home page');
                    // 主页 - 显示主页内容，背景正常
                    if (mainHome) {
                        mainHome.style.display = 'flex';
                        console.log('Main home displayed');
                    }
                    if (backgroundImage) backgroundImage.classList.remove('dimmed');
                    if (backgroundVideo) backgroundVideo.classList.remove('dimmed');

                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    console.log('All tab contents deactivated');
                } else {
                    // 功能页面 - 使用高效的页面切换
                    if (mainHome) {
                        mainHome.style.display = 'none';
                    }
                    if (backgroundImage) backgroundImage.classList.add('dimmed');
                    if (backgroundVideo) backgroundVideo.classList.add('dimmed');

                    // 高效的页面切换：只操作当前活跃的页面和目标页面
                    const currentActive = document.querySelector('.tab-content.active');
                    if (currentActive && currentActive.id !== tabName) {
                        currentActive.classList.remove('active');
                    }

                    const targetContent = document.getElementById(tabName);
                    if (targetContent) {
                        targetContent.classList.add('active');
                        console.log(`Switched to ${tabName}`);

                        // 插件管理页面 - 初始化插件管理功能
                        if (tabName === 'plugin-management') {
                            console.log('Plugin management page activated');
                            this.initPluginManagement();

                            // 确保默认显示已安装插件标签
                            setTimeout(() => {
                                const installedTab = document.querySelector('[data-type="installed"]');
                                const availableTab = document.querySelector('[data-type="available"]');

                                if (installedTab && availableTab) {
                                    installedTab.classList.add('active');
                                    availableTab.classList.remove('active');

                                    // 确保显示正确的内容
                                    this.showPluginTab('installed');
                                }
                            }, 50);
                        }

                        // 环境配置页面 - 自动检测环境信息
                        if (tabName === 'environment-config') {
                            console.log('Environment config page activated');
                            // 自动检测环境信息
                            this.detectEnvironmentInfo();
                        }
                    } else {
                        console.error(`Target content not found for: ${tabName}`);
                    }

                    // 特殊处理：版本管理页面
                    if (tabName === 'version-management') {
                        this.initVersionManagement();
                        // 自动检查更新
                        this.checkForUpdates();
                    }
                }

                this.currentTab = tabName;
            }

            handleBackgroundUpload(file) {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageUrl = e.target.result;
                        this.setBackgroundImage(imageUrl);
                        localStorage.setItem('ai-vision-background', imageUrl);
                        localStorage.removeItem('ai-vision-background-video');
                    };
                    reader.readAsDataURL(file);
                }
            }

            handleVideoUpload(file) {
                if (file && file.type.startsWith('video/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const videoUrl = e.target.result;
                        this.setBackgroundVideo(videoUrl);
                        localStorage.setItem('ai-vision-background-video', videoUrl);
                        localStorage.removeItem('ai-vision-background');
                    };
                    reader.readAsDataURL(file);
                }
            }

            setBackgroundImage(imageUrl) {
                const backgroundImage = document.getElementById('backgroundImage');
                const backgroundVideo = document.getElementById('backgroundVideo');

                backgroundImage.src = imageUrl;
                backgroundImage.style.display = 'block';
                backgroundVideo.style.display = 'none';
                backgroundVideo.pause();
            }

            setBackgroundVideo(videoUrl) {
                const backgroundImage = document.getElementById('backgroundImage');
                const backgroundVideo = document.getElementById('backgroundVideo');

                backgroundVideo.src = videoUrl;
                backgroundVideo.style.display = 'block';
                backgroundImage.style.display = 'none';

                // 应用保存的声音设置
                const videoAudioEnabled = localStorage.getItem('video-audio-enabled') === 'true';
                const videoVolume = parseFloat(localStorage.getItem('video-volume')) || 0.3;
                backgroundVideo.muted = !videoAudioEnabled;
                if (videoAudioEnabled) {
                    backgroundVideo.volume = videoVolume;
                }

                backgroundVideo.load();
                backgroundVideo.play().catch(e => console.log('视频自动播放被阻止:', e));
            }

            loadSavedBackground() {
                const savedBackground = localStorage.getItem('ai-vision-background');
                const savedVideo = localStorage.getItem('ai-vision-background-video');

                if (savedVideo) {
                    this.setBackgroundVideo(savedVideo);
                } else if (savedBackground) {
                    this.setBackgroundImage(savedBackground);
                }
            }

            loadSavedSettings() {
                const savedSettings = localStorage.getItem('ai-vision-launch-settings');
                if (!savedSettings) return;

                try {
                    const settings = JSON.parse(savedSettings);

                    // 恢复显存模式
                    if (settings.vramMode) {
                        const vramRadio = document.getElementById(settings.vramMode);
                        if (vramRadio) vramRadio.checked = true;
                    }

                    // 恢复注意力优化方法
                    if (settings.attentionMethod) {
                        const attentionSelect = document.getElementById('attention-method');
                        if (attentionSelect) attentionSelect.value = settings.attentionMethod;
                    }

                    // 恢复注意力上采样
                    if (settings.upcastMode !== undefined) {
                        const upcastSelect = document.getElementById('upcast-mode');
                        if (upcastSelect) upcastSelect.value = settings.upcastMode;
                    }

                    // 恢复网络设置
                    if (settings.listenIp) {
                        const listenInput = document.getElementById('listen-ip');
                        if (listenInput) listenInput.value = settings.listenIp;
                    }

                    if (settings.port) {
                        const portInput = document.getElementById('port');
                        if (portInput) portInput.value = settings.port;
                    }

                    // 恢复CORS设置
                    if (settings.corsMode) {
                        const corsSelect = document.getElementById('cors-setting');
                        if (corsSelect) corsSelect.value = settings.corsMode;
                    }

                    // 恢复代理设置
                    if (settings.enableProxy !== undefined) {
                        const enableProxyCheckbox = document.getElementById('enable-proxy');
                        if (enableProxyCheckbox) {
                            enableProxyCheckbox.checked = settings.enableProxy;
                            // 触发显示/隐藏逻辑
                            const proxyInputs = document.getElementById('proxy-inputs');
                            if (proxyInputs) {
                                proxyInputs.style.display = settings.enableProxy ? 'block' : 'none';
                            }
                        }
                    }

                    if (settings.httpProxy) {
                        const httpProxyInput = document.getElementById('http-proxy');
                        if (httpProxyInput) httpProxyInput.value = settings.httpProxy;
                    }

                    if (settings.httpsProxy) {
                        const httpsProxyInput = document.getElementById('https-proxy');
                        if (httpsProxyInput) httpsProxyInput.value = settings.httpsProxy;
                    }

                    // 恢复选项设置
                    if (settings.options) {
                        Object.keys(settings.options).forEach(key => {
                            const kebabCase = key.replace(/([A-Z])/g, '-$1').toLowerCase();
                            const checkbox = document.getElementById(kebabCase);
                            if (checkbox) {
                                checkbox.checked = settings.options[key];
                            }
                        });
                    }

                } catch (e) {
                    console.warn('Failed to load saved settings:', e);
                }
            }

            // API调用方法
            async apiCall(endpoint, method = 'GET', data = null) {
                try {
                    const options = {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    };

                    if (data) {
                        options.body = JSON.stringify(data);
                    }

                    const response = await fetch(`${this.API_BASE}${endpoint}`, options);
                    return await response.json();
                } catch (error) {
                    console.error(`API调用失败: ${error.message}`);
                    return { status: 'error', message: error.message };
                }
            }

            async loadSystemInfo() {
                try {
                    const result = await this.apiCall('/system/info');
                    if (result.status === 'success' || result.cpu_percent !== undefined) {
                        this.updateGPUInfo(result);
                    }
                } catch (error) {
                    console.error('Failed to load system info:', error);
                }
            }

            async loadComfyUIStatus() {
                try {
                    const result = await this.apiCall('/comfyui/status');
                    console.log('ComfyUI状态API响应:', result);
                    // 处理所有状态：running, stopped, starting等
                    if (result && result.status) {
                        this.updateComfyUIStatus(result);
                    }
                } catch (error) {
                    console.error('Failed to load ComfyUI status:', error);
                }
            }

            async loadGitStatus() {
                try {
                    const result = await this.apiCall('/git/status');
                    if (result.status === 'success') {
                        console.log('Git status loaded:', result);
                        // 可以在这里更新版本管理页面的显示
                    }
                } catch (error) {
                    console.error('Failed to load Git status:', error);
                }
            }

            updateGPUInfo(systemInfo) {
                // 获取实时GPU信息，而不是依赖systemInfo
                this.loadRealTimeGPUInfo();
            }

            async loadRealTimeGPUInfo() {
                try {
                    const response = await fetch(`${this.backendUrl}/system/cuda-info`);
                    if (response.ok) {
                        const data = await response.json();

                        // 更新GPU名称
                        const gpuName = document.getElementById('gpuName');
                        if (gpuName && data.gpu_name && data.gpu_name !== '未检测到GPU') {
                            // 简化GPU名称显示
                            let displayName = data.gpu_name;
                            if (displayName.includes('NVIDIA')) {
                                displayName = displayName.replace('NVIDIA GeForce ', '').replace('NVIDIA ', '');
                            }
                            if (displayName.includes('AMD')) {
                                displayName = displayName.replace('AMD Radeon ', '').replace('AMD ', '');
                            }
                            gpuName.textContent = displayName;
                        }

                        // 更新显存信息
                        const gpuUsage = document.getElementById('gpuUsage');
                        if (gpuUsage && data.memory && data.memory !== '未知') {
                            gpuUsage.textContent = `显存: ${data.memory}`;
                        } else if (gpuUsage) {
                            gpuUsage.textContent = `显存: 检测中...`;
                        }

                        // 更新GPU利用率
                        const gpuStatus = document.getElementById('gpuStatus');
                        if (gpuStatus && data.utilization !== undefined) {
                            gpuStatus.textContent = `${Math.round(data.utilization)}%`;
                        } else if (gpuStatus) {
                            gpuStatus.textContent = '0%';
                        }

                        console.log('GPU实时信息更新:', {
                            name: data.gpu_name,
                            memory: data.memory,
                            utilization: data.utilization,
                            temperature: data.temperature
                        });

                    }
                } catch (error) {
                    console.error('Failed to load real-time GPU info:', error);
                    // 如果获取失败，显示默认信息
                    const gpuUsage = document.getElementById('gpuUsage');
                    const gpuStatus = document.getElementById('gpuStatus');
                    const gpuName = document.getElementById('gpuName');

                    if (gpuUsage) gpuUsage.textContent = '显存: 检测失败';
                    if (gpuStatus) gpuStatus.textContent = '0%';
                    if (gpuName && gpuName.textContent === '检测中...') {
                        gpuName.textContent = 'GPU检测失败';
                    }
                }
            }



            updateComfyUIStatus(statusInfo) {
                const launchBtn = document.getElementById('launchBtn');
                const browserBtn = document.getElementById('browserBtn');
                const gpuInfo = document.getElementById('gpuInfo');

                // 兼容不同的状态格式：status === 'running' 或 is_running === true
                const isRunning = statusInfo.status === 'running' ||
                                statusInfo.status === 'starting' ||
                                statusInfo.status === 'already_running' ||
                                statusInfo.is_running === true;

                console.log('🔍 ComfyUI手动状态更新:', {
                    status: statusInfo.status,
                    is_running: statusInfo.is_running,
                    isRunning: isRunning,
                    previousRunning: this.isRunning
                });

                // 更新内部状态
                this.isRunning = isRunning;

                // 更新UI（只在手动调用时执行，不会被自动轮询干扰）
                if (launchBtn && !launchBtn.disabled) {
                    if (isRunning) {
                        if (!this.isRunning) {
                            logger.important('🚀 ComfyUI启动检测到，开始初始化工作流监控');
                        }
                        launchBtn.innerHTML = '<i class="fas fa-stop"></i> 停止 COMFYUI';
                        launchBtn.classList.remove('starting', 'stopping');
                        launchBtn.classList.add('running');

                        // 显示浏览器按钮
                        if (browserBtn) {
                            browserBtn.style.display = 'flex';
                        }
                        // 开始监控工作流状态
                        this.startWorkflowMonitoring();
                    } else {
                        launchBtn.innerHTML = '<i class="fas fa-rocket"></i> 启动 COMFYUI';
                        launchBtn.classList.remove('running', 'starting', 'stopping');

                        // 隐藏浏览器按钮
                        if (browserBtn) {
                            browserBtn.style.display = 'none';
                        }
                        // 停止工作流监控
                        this.stopWorkflowMonitoring();
                    }
                }

                console.log('ComfyUI状态更新完成:', {status: statusInfo.status, isRunning: this.isRunning});
            }

            // 开始监控工作流状态
            startWorkflowMonitoring() {
                console.log('🔍 开始监控工作流状态');

                // 清除之前的监控
                this.stopWorkflowMonitoring();

                // 延迟启动监控，确保ComfyUI完全启动
                setTimeout(() => {
                    console.log('🔗 尝试连接WebSocket监控');
                    this.connectComfyUIWebSocket();

                    logger.info('⏰ 启动HTTP轮询备用监控');
                    // 同时使用HTTP轮询作为备用方案
                    this.workflowCheckInterval = setInterval(() => {
                        this.checkWorkflowStatus();
                    }, 1000); // 每秒检查一次
                }, 3000); // 延迟3秒启动
            }

            // 停止监控工作流状态
            stopWorkflowMonitoring() {
                console.log('停止监控工作流状态');

                // 清除轮询
                if (this.workflowCheckInterval) {
                    clearInterval(this.workflowCheckInterval);
                    this.workflowCheckInterval = null;
                }

                // 关闭WebSocket连接
                if (this.comfyUIWebSocket) {
                    this.comfyUIWebSocket.close();
                    this.comfyUIWebSocket = null;
                }

                // 停止光效
                this.setWorkflowRunning(false);
            }

            // 连接ComfyUI WebSocket
            connectComfyUIWebSocket() {
                if (!this.isRunning) return;

                try {
                    // ComfyUI默认WebSocket地址
                    const wsUrl = 'ws://127.0.0.1:8188/ws';
                    console.log('尝试连接ComfyUI WebSocket:', wsUrl);

                    this.comfyUIWebSocket = new WebSocket(wsUrl);

                    this.comfyUIWebSocket.onopen = () => {
                        console.log('ComfyUI WebSocket连接成功');
                    };

                    this.comfyUIWebSocket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleWorkflowMessage(data);
                        } catch (error) {
                            console.error('解析WebSocket消息失败:', error);
                        }
                    };

                    this.comfyUIWebSocket.onclose = () => {
                        console.log('ComfyUI WebSocket连接关闭');
                        this.comfyUIWebSocket = null;

                        // 如果ComfyUI还在运行，尝试重连
                        if (this.isRunning) {
                            setTimeout(() => {
                                this.connectComfyUIWebSocket();
                            }, 3000);
                        }
                    };

                    this.comfyUIWebSocket.onerror = (error) => {
                        console.error('ComfyUI WebSocket错误:', error);
                    };

                } catch (error) {
                    console.error('创建WebSocket连接失败:', error);
                }
            }

            // 处理工作流消息
            handleWorkflowMessage(data) {
                // ComfyUI WebSocket消息格式分析
                if (data.type === 'status') {
                    // 状态消息
                    const queueRemaining = data.data?.status?.exec_info?.queue_remaining || 0;
                    this.setWorkflowRunning(queueRemaining > 0);
                } else if (data.type === 'execution_start') {
                    // 开始执行
                    console.log('工作流开始执行');
                    this.setWorkflowRunning(true);
                } else if (data.type === 'execution_success' || data.type === 'execution_error') {
                    // 执行完成或出错
                    console.log('工作流执行完成');
                    this.setWorkflowRunning(false);
                } else if (data.type === 'executing') {
                    // 正在执行某个节点
                    const nodeId = data.data?.node;
                    if (nodeId) {
                        this.setWorkflowRunning(true);
                    } else {
                        // nodeId为null表示执行完成
                        this.setWorkflowRunning(false);
                    }
                }
            }

            // HTTP轮询检查工作流状态（备用方案）
            async checkWorkflowStatus() {
                try {
                    // 通过后端代理检查ComfyUI队列状态，避免CORS问题
                    const response = await this.apiCall('/comfyui/queue');
                    if (response && response.status !== 'error') {
                        const queueRunning = response.queue_running || [];
                        const queuePending = response.queue_pending || [];

                        const isRunning = queueRunning.length > 0 || queuePending.length > 0;

                        // 输出详细的队列状态信息
                        console.log('📊 队列状态检查:', {
                            running: queueRunning.length,
                            pending: queuePending.length,
                            isRunning: isRunning,
                            previousState: this.isWorkflowRunning,
                            queueData: response
                        });

                        this.setWorkflowRunning(isRunning);
                    } else {
                        logger.error('❌ ComfyUI队列API响应失败:', response?.message || 'Unknown error', response);
                    }
                } catch (error) {
                    // 只在第一次失败时输出错误
                    if (!this.queueCheckErrorLogged) {
                        logger.warn('⚠️ ComfyUI队列检查失败 (可能还未完全启动):', error.message);
                        this.queueCheckErrorLogged = true;
                    }
                }
            }

            // 设置工作流运行状态和光效
            setWorkflowRunning(isRunning) {
                if (this.isWorkflowRunning !== isRunning) {
                    this.isWorkflowRunning = isRunning;
                    const gpuInfo = document.getElementById('gpuInfo');

                    console.log('🎯 工作流状态变化:', {
                        isRunning: isRunning,
                        previousState: this.isWorkflowRunning,
                        gpuInfoElement: !!gpuInfo,
                        gpuInfoId: gpuInfo ? gpuInfo.id : 'not found'
                    });

                    if (isRunning) {
                        logger.info('✨ 工作流开始运行 - 启动GPU光效');
                        if (gpuInfo) {
                            gpuInfo.classList.add('working');
                            console.log('✅ 已添加working类到GPU信息框');
                            console.log('🔍 当前GPU信息框类列表:', gpuInfo.className);
                        } else {
                            console.error('❌ 找不到GPU信息框元素 (gpuInfo)');
                        }
                    } else {
                        console.log('⏹️ 工作流停止运行 - 停止GPU光效');
                        if (gpuInfo) {
                            gpuInfo.classList.remove('working');
                            console.log('✅ 已移除working类从GPU信息框');
                            console.log('🔍 当前GPU信息框类列表:', gpuInfo.className);
                        } else {
                            console.error('❌ 找不到GPU信息框元素 (gpuInfo)');
                        }
                    }
                }
            }

            async toggleComfyUI() {
                const launchBtn = document.getElementById('launchBtn');
                const browserBtn = document.getElementById('browserBtn');

                // 防止重复点击
                if (launchBtn && launchBtn.disabled) {
                    console.log('按钮已禁用，忽略点击');
                    return;
                }

                try {
                    if (!this.isRunning) {
                        console.log('🚀 用户启动ComfyUI操作开始');
                        // 立即更新按钮状态为启动中
                        if (launchBtn) {
                            launchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 启动中...';
                            launchBtn.classList.add('starting');
                            launchBtn.disabled = true;
                        }

                        // 启动 ComfyUI
                        logger.important('正在启动ComfyUI...');
                        // 播放启动音效
                        if (window.audioManager) {
                            audioManager.play('startup');
                        }
                        const result = await this.apiCall('/comfyui/start', 'POST');
                        logger.info('ComfyUI启动响应:', result);

                        // API调用成功，但按钮状态要等ComfyUI完全启动后再更新
                        if (result.status === 'running' || result.status === 'starting' || result.status === 'already_running') {
                            logger.important('ComfyUI启动API成功，状态:', result.status);

                            // 播放ComfyUI启动成功音效
                            if (window.audioManager) {
                                audioManager.play('startup-success');
                            }
                            this.showNotification(result.message || 'ComfyUI启动中...', 'success', 'comfyui-startup');

                            // 根据不同状态决定延迟时间
                            let delay = 3000; // 默认3秒
                            if (result.status === 'running') {
                                delay = 1000; // 如果已经运行，1秒后打开
                            } else if (result.status === 'starting') {
                                delay = 5000; // 如果还在启动，5秒后打开
                            } else if (result.status === 'already_running') {
                                delay = 500; // 如果已经在运行，立即打开
                            }

                            // 延迟后自动打开浏览器
                            setTimeout(() => {
                                this.openComfyUIInBrowser();

                                // 浏览器打开后，更新按钮状态为运行中
                                this.isRunning = true;
                                if (launchBtn) {
                                    launchBtn.innerHTML = '<i class="fas fa-stop"></i> 停止 COMFYUI';
                                    launchBtn.classList.remove('starting');
                                    launchBtn.classList.add('running');
                                    launchBtn.disabled = false; // 启用按钮
                                }
                                // 显示浏览器按钮
                                if (browserBtn) {
                                    browserBtn.style.display = 'flex';
                                }

                                logger.important('🚀 ComfyUI启动完成，按钮已更新为停止状态');
                            }, delay);

                            // 延迟启动工作流监控，确保ComfyUI完全启动
                            setTimeout(() => {
                                logger.important('🚀 ComfyUI启动成功，强制启动工作流监控');
                                this.startWorkflowMonitoring();
                            }, delay + 2000); // 在打开浏览器后2秒启动监控
                        } else {
                            // 启动失败，恢复按钮状态
                            if (launchBtn) {
                                launchBtn.innerHTML = '<i class="fas fa-rocket"></i> 启动 COMFYUI';
                                launchBtn.classList.remove('starting');
                                launchBtn.disabled = false;
                            }
                            console.error('启动失败:', result.message);
                            this.showNotification(result.message || '启动失败', 'error');
                        }
                    } else {
                        console.log('🛑 用户停止ComfyUI操作开始');

                        // 立即更新按钮状态为停止中
                        if (launchBtn) {
                            launchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 停止中...';
                            launchBtn.classList.add('stopping');
                            launchBtn.disabled = true;
                        }

                        // 停止 ComfyUI
                        console.log('正在停止ComfyUI...');
                        // 播放停止音效
                        if (window.audioManager) {
                            audioManager.play('shutdown');
                        }
                        const result = await this.apiCall('/comfyui/stop', 'POST');

                        // 停止API调用完成后立即更新按钮状态
                        if (result.status === 'stopped' || result.status === 'already_stopped') {
                            // 立即更新按钮状态为已停止，允许用户立即启动
                            this.isRunning = false;
                            if (launchBtn) {
                                launchBtn.innerHTML = '<i class="fas fa-rocket"></i> 启动 COMFYUI';
                                launchBtn.classList.remove('stopping', 'running');
                                launchBtn.disabled = false; // 立即启用按钮
                            }
                            // 隐藏浏览器按钮
                            if (browserBtn) {
                                browserBtn.style.display = 'none';
                            }
                            // 停止工作流监控
                            this.stopWorkflowMonitoring();

                            console.log('ComfyUI已停止');
                            // 播放ComfyUI关闭成功音效
                            if (window.audioManager) {
                                audioManager.play('shutdown-success');
                            }
                            this.showNotification(result.message || 'ComfyUI已停止', 'success', 'comfyui-shutdown');

                            logger.important('🛑 ComfyUI停止完成，按钮已立即更新为启动状态');
                        } else {
                            // 停止失败，恢复按钮状态
                            if (launchBtn) {
                                launchBtn.innerHTML = '<i class="fas fa-stop"></i> 停止 COMFYUI';
                                launchBtn.classList.remove('stopping');
                                launchBtn.disabled = false;
                            }
                            console.error('停止失败:', result.message);
                            this.showNotification(result.message || '停止失败', 'error');
                        }
                    }
                } catch (error) {
                    // 发生错误时恢复按钮状态
                    if (launchBtn) {
                        if (this.isRunning) {
                            launchBtn.innerHTML = '<i class="fas fa-stop"></i> 停止 COMFYUI';
                            launchBtn.classList.remove('stopping');
                            launchBtn.classList.add('running');
                        } else {
                            launchBtn.innerHTML = '<i class="fas fa-rocket"></i> 启动 COMFYUI';
                            launchBtn.classList.remove('starting');
                        }
                        launchBtn.disabled = false;
                    }
                    console.error('ComfyUI操作失败:', error);
                    this.showNotification('操作失败: ' + error.message, 'error');
                }
            }

            async openComfyUIInBrowser() {
                try {
                    // 获取ComfyUI的访问地址
                    const listenIp = document.getElementById('listen-ip')?.value || '127.0.0.1';
                    const port = document.getElementById('port')?.value || '8188';
                    const url = `http://${listenIp}:${port}`;

                    console.log('Opening ComfyUI in browser:', url);

                    // 先检查ComfyUI是否真的可访问
                    try {
                        const checkResult = await this.apiCall('/comfyui/check');
                        if (checkResult.status === 'accessible') {
                            console.log('ComfyUI web service is accessible, opening browser...');
                        } else {
                            console.warn('ComfyUI web service may not be ready yet, but trying to open anyway...');
                        }
                    } catch (checkError) {
                        console.warn('Failed to check ComfyUI accessibility:', checkError);
                    }

                    // 尝试多种方式打开浏览器
                    let opened = false;

                    // 方式1: 使用Electron的shell.openExternal (推荐)
                    if (window.electronAPI && window.electronAPI.openExternal) {
                        try {
                            await window.electronAPI.openExternal(url);
                            opened = true;
                            console.log('Opened using Electron shell.openExternal');
                        } catch (e) {
                            console.warn('Failed to open with Electron shell:', e);
                        }
                    }

                    // 方式2: 使用window.open作为备选
                    if (!opened) {
                        try {
                            const newWindow = window.open(url, '_blank');
                            if (newWindow) {
                                opened = true;
                                console.log('Opened using window.open');
                            }
                        } catch (e) {
                            console.warn('Failed to open with window.open:', e);
                        }
                    }

                    if (opened) {
                        this.showNotification('已在浏览器中打开ComfyUI', 'success');
                    } else {
                        this.showNotification(`请手动打开浏览器访问: ${url}`, 'info');
                        // 复制URL到剪贴板（如果支持）
                        if (navigator.clipboard) {
                            try {
                                await navigator.clipboard.writeText(url);
                                this.showNotification('URL已复制到剪贴板', 'info');
                            } catch (e) {
                                console.warn('Failed to copy to clipboard:', e);
                            }
                        }
                    }

                } catch (error) {
                    console.error('Failed to open ComfyUI in browser:', error);
                    this.showNotification('打开浏览器失败: ' + error.message, 'error');
                }
            }



            toggleExpertMode() {
                const btn = document.querySelector('.expert-mode-btn');
                if (btn.textContent === '启用高级选项') {
                    btn.textContent = '禁用高级选项';
                    btn.style.background = 'rgba(0, 245, 255, 0.2)';
                    btn.style.borderColor = 'rgba(0, 245, 255, 0.5)';
                    btn.style.color = 'var(--neon-glow)';
                } else {
                    btn.textContent = '启用高级选项';
                    btn.style.background = 'rgba(255, 102, 0, 0.2)';
                    btn.style.borderColor = 'rgba(255, 102, 0, 0.5)';
                    btn.style.color = '#ff6600';
                }
            }

            selectPreset(presetType) {
                // 移除所有卡片的active状态
                document.querySelectorAll('.preset-card').forEach(card => {
                    card.classList.remove('active');
                });

                // 激活选中的卡片
                document.querySelector(`[data-preset="${presetType}"]`).classList.add('active');

                // 根据预设类型设置参数
                switch(presetType) {
                    case 'high-end':
                        document.getElementById('highvram').checked = true;
                        document.getElementById('flash-attention').checked = true;
                        document.getElementById('bf16-unet').checked = true;
                        break;
                    case 'mid-range':
                        document.getElementById('normalvram').checked = true;
                        document.getElementById('pytorch-attention').checked = true;
                        break;
                    case 'low-end':
                        document.getElementById('lowvram').checked = true;
                        document.getElementById('split-attention').checked = true;
                        break;
                }

                // 只在启动设置页面时更新命令预览
                if (document.getElementById('listen-ip')) {
                    this.updateCommandPreview();
                }
            }

            updateCommandPreview() {
                let command = 'python main.py';

                // 监听设置
                const listenEl = document.getElementById('listen-ip');
                const portEl = document.getElementById('port');
                if (listenEl && portEl) {
                    const listen = listenEl.value || '127.0.0.1';
                    const port = portEl.value || '8188';
                    command += ` --listen ${listen} --port ${port}`;
                }

                // 显存模式
                const vramMode = document.querySelector('input[name="vram-mode"]:checked');
                if (vramMode) {
                    switch(vramMode.value) {
                        case 'gpu-only':
                            command += ' --gpu-only';
                            break;
                        case 'highvram':
                            command += ' --highvram';
                            break;
                        case 'normalvram':
                            command += ' --normalvram';
                            break;
                        case 'lowvram':
                            command += ' --lowvram';
                            break;
                        case 'cpu':
                            command += ' --cpu';
                            break;
                    }
                }

                // 注意力优化方法
                const attentionMethod = document.getElementById('attention-method');
                if (attentionMethod && attentionMethod.value) {
                    command += ` --${attentionMethod.value}`;
                }

                // 注意力上采样
                const upcastMode = document.getElementById('upcast-mode');
                if (upcastMode && upcastMode.value) {
                    command += ` --${upcastMode.value}`;
                }

                // 禁用xformers
                if (document.getElementById('disable-xformers')?.checked) {
                    command += ' --disable-xformers';
                }

                // 预留显存
                const reserveVram = document.getElementById('reserve-vram');
                if (reserveVram && parseFloat(reserveVram.value) > 0) {
                    command += ` --reserve-vram ${reserveVram.value}`;
                }

                // 异步权重卸载
                if (document.getElementById('async-offload')?.checked) {
                    command += ' --async-offload';
                }

                // CORS设置
                const corsMode = document.getElementById('cors-setting');
                if (corsMode && corsMode.value) {
                    command += ` --${corsMode.value}`;
                }

                // 代理设置（只有启用代理时才添加）
                const enableProxy = document.getElementById('enable-proxy');
                if (enableProxy && enableProxy.checked) {
                    const httpProxy = document.getElementById('http-proxy');
                    const httpsProxy = document.getElementById('https-proxy');

                    if (httpProxy && httpProxy.value) {
                        command += ` --proxy-http ${httpProxy.value}`;
                    }
                    if (httpsProxy && httpsProxy.value) {
                        command += ` --proxy-https ${httpsProxy.value}`;
                    }
                }

                // 更新命令预览
                document.getElementById('command-preview').textContent = command;
            }

            saveSettings() {
                const settings = {
                    vramMode: document.querySelector('input[name="vram-mode"]:checked')?.value,
                    attentionMethod: document.getElementById('attention-method')?.value,
                    upcastMode: document.getElementById('upcast-mode')?.value,
                    listenIp: document.getElementById('listen-ip')?.value,
                    port: document.getElementById('port')?.value,
                    corsMode: document.getElementById('cors-setting')?.value,
                    enableProxy: document.getElementById('enable-proxy')?.checked,
                    httpProxy: document.getElementById('http-proxy')?.value,
                    httpsProxy: document.getElementById('https-proxy')?.value,
                    options: {
                        reserveVram: document.getElementById('reserve-vram')?.value,
                        asyncOffload: document.getElementById('async-offload')?.checked,
                        disableXformers: document.getElementById('disable-xformers')?.checked
                    }
                };

                localStorage.setItem('ai-vision-launch-settings', JSON.stringify(settings));

                // 显示保存成功提示
                this.showNotification('设置已保存', 'success');
            }

            applyAndLaunch() {
                this.saveSettings();
                // 这里可以添加实际启动ComfyUI的逻辑
                this.showNotification('正在应用设置并启动...', 'info');
                setTimeout(() => {
                    this.toggleComfyUI();
                }, 1000);
            }

            resetToDefault() {
                // 重置为默认设置
                document.getElementById('highvram').checked = true;
                document.getElementById('default-attention').checked = true;
                document.getElementById('listen-ip').value = '127.0.0.1';
                document.getElementById('port').value = '8188';
                document.getElementById('http-proxy').value = '';
                document.getElementById('https-proxy').value = '';

                // 重置复选框
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });

                // 只在启动设置页面时更新命令预览
                if (document.getElementById('listen-ip')) {
                    this.updateCommandPreview();
                }
                this.showNotification('已重置为默认设置', 'warning');
            }

            showNotification(message, type = 'info', context = null) {
                // 播放对应的音效
                if (window.audioManager) {
                    switch (type) {
                        case 'success':
                            // 根据上下文播放不同的成功音效
                            if (context === 'comfyui-startup' || (message.includes('ComfyUI') && message.includes('启动'))) {
                                audioManager.play('startup-success');
                            } else if (context === 'comfyui-shutdown' || (message.includes('ComfyUI') && (message.includes('停止') || message.includes('关闭')))) {
                                audioManager.play('shutdown-success');
                            } else if (context === 'plugin' || message.includes('插件') || message.includes('plugin')) {
                                audioManager.play('plugin-success');
                            } else if (context === 'version' || message.includes('版本') || message.includes('version')) {
                                audioManager.play('version-success');
                            } else if (context === 'install' || message.includes('安装') || message.includes('install')) {
                                audioManager.play('install-success');
                            } else if (context === 'update' || message.includes('更新') || message.includes('update')) {
                                audioManager.play('update-success');
                            } else {
                                audioManager.play('success');
                            }
                            break;
                        case 'error':
                            audioManager.play('error');
                            break;
                        case 'warning':
                            audioManager.play('warning');
                            break;
                        case 'info':
                        default:
                            audioManager.play('notification');
                            break;
                    }
                }

                // 创建通知元素
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(26, 26, 46, 0.95);
                    border: 1px solid var(--neon-glow);
                    border-radius: 8px;
                    padding: 12px 20px;
                    color: var(--text-primary);
                    font-size: 0.9rem;
                    z-index: 10000;
                    backdrop-filter: blur(10px);
                    opacity: 0;
                    transform: translateX(100%);
                    transition: all 0.3s ease;
                `;

                document.body.appendChild(notification);

                // 显示动画
                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateX(0)';
                }, 10);

                // 自动移除
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
            }

            // 检查更新功能 - 使用快速API
            async checkForUpdates() {
                try {
                    console.log('🔍 快速检查是否有新版本更新...');
                    
                    // 使用快速检查API
                    const response = await fetch(`${this.backendUrl}/comfyui/check-updates`);
                    const result = await response.json();
                    
                    if (result.status === 'success' && result.has_updates) {
                        console.log(`🔥 发现 ${result.update_count} 个新版本更新`);
                        console.log(`当前版本: ${result.current_commit}, 最新版本: ${result.latest_commit}`);
                        
                        // 显示更新提示
                        this.showUpdateNotification(result.update_count);
                    } else if (result.status === 'success') {
                        console.log('✅ 当前已是最新版本');
                    } else {
                        console.warn('⚠️ 检查更新失败:', result.error);
                    }
                } catch (error) {
                    console.warn('⚠️ 检查更新网络请求失败:', error);
                    // 回退到原有方法
                    this.checkForUpdatesLegacy();
                }
            }

            // 原有的更新检查方法作为备用
            async checkForUpdatesLegacy() {
                try {
                    console.log('🔍 使用完整版本数据检查更新...');
                    const versionData = await this.fetchVersionData(true);
                    
                    if (versionData && versionData.development && versionData.development.length > 0) {
                        const currentIndex = versionData.development.findIndex(v => v.current || v.isCurrent);
                        const hasUpdates = currentIndex > 0;
                        
                        if (hasUpdates) {
                            const updateCount = currentIndex;
                            console.log(`🔥 发现 ${updateCount} 个新版本更新`);
                            this.showUpdateNotification(updateCount);
                        } else {
                            console.log('✅ 当前已是最新版本');
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ 备用更新检查也失败:', error);
                }
            }

            // 显示更新通知
            showUpdateNotification(updateCount) {
                // 检查是否已经显示了通知，避免重复显示
                if (document.querySelector('.update-notification')) {
                    return;
                }

                const notification = document.createElement('div');
                notification.className = 'update-notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #ff6b35, #f7931e);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);
                    z-index: 10000;
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                    font-size: 14px;
                    max-width: 300px;
                    animation: slideInRight 0.3s ease-out;
                    cursor: pointer;
                `;
                
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-rocket" style="color: #fff;"></i>
                        <div>
                            <div style="font-weight: bold;">发现新版本</div>
                            <div style="font-size: 12px; opacity: 0.9;">${updateCount} 个更新可用</div>
                        </div>
                        <i class="fas fa-times" style="margin-left: auto; opacity: 0.7; cursor: pointer;" onclick="this.parentElement.parentElement.remove()"></i>
                    </div>
                `;
                
                // 点击跳转到版本管理页面
                notification.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('fa-times')) {
                        this.switchTab('version-management');
                        this.switchVersionTab('development'); // 切换到开发版本标签
                        notification.remove();
                    }
                });
                
                document.body.appendChild(notification);
                
                // 5秒后自动消失
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 5000);
            }

            // 检查远程更新（手动触发）
            async checkRemoteUpdates() {
                const refreshBtn = document.querySelector('.refresh-versions-btn i');
                if (refreshBtn) {
                    refreshBtn.classList.add('fa-spin');
                }

                try {
                    console.log('🔍 手动检查远程更新...');
                    
                    // 显示加载提示
                    this.showNotification('正在检查远程更新...', 'info');
                    
                    // 执行git fetch来获取最新的远程引用
                    const fetchResponse = await fetch(`${this.backendUrl}/git/fetch-remote`, {
                        method: 'POST',
                        timeout: 30000
                    });
                    
                    if (fetchResponse.ok) {
                        console.log('✅ 远程更新获取成功');
                        
                        // 清除缓存并重新加载版本数据
                        this.versionCache = null;
                        this.versionCacheExpiry = null;
                        
                        // 强制刷新版本数据
                        await this.loadVersions(true);
                        
                        // 检查是否有更新
                        await this.checkForUpdates();
                        
                        this.showNotification('远程更新检查完成！', 'success');
                    } else {
                        console.warn('⚠️ 获取远程更新失败');
                        this.showNotification('获取远程更新失败，请检查网络连接', 'warning');
                    }
                    
                } catch (error) {
                    console.error('❌ 检查远程更新失败:', error);
                    this.showNotification('检查远程更新失败', 'error');
                } finally {
                    if (refreshBtn) {
                        refreshBtn.classList.remove('fa-spin');
                    }
                }
            }

            // 后台自动更新检查
            startBackgroundUpdateCheck() {
                console.log('🔍 启动后台自动更新检查...');
                
                // 立即检查一次
                this.performBackgroundUpdateCheck();
                
                // 每10分钟检查一次更新
                setInterval(() => {
                    this.performBackgroundUpdateCheck();
                }, 10 * 60 * 1000);
            }

            async performBackgroundUpdateCheck() {
                try {
                    console.log('🔍 执行后台更新检查...');
                    
                    // 使用快速更新检查API，避免影响性能
                    const response = await fetch(`${this.backendUrl}/comfyui/check-updates`, {
                        headers: { 'Cache-Control': 'no-cache' }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 'success' && result.has_updates && result.update_count > 0) {
                            console.log(`🔥 后台检测到 ${result.update_count} 个更新`);
                            
                            // 只在有实际更新时显示通知
                            if (!document.querySelector('.update-notification')) {
                                this.showUpdateNotification(result.update_count);
                            }
                        } else {
                            console.log('✅ 后台检查：当前已是最新版本');
                        }
                    }
                } catch (error) {
                    // 后台检查失败不显示错误，避免干扰用户
                    console.log('⚠️ 后台更新检查失败，将在下次检查:', error.message);
                }
            }

            // 版本管理相关方法
            initVersionManagement() {
                this.currentVersionType = 'stable';
                this.pendingVersionSwitch = null;

                // 绑定版本管理页面的事件
                this.bindVersionManagementEvents();

                // 确保默认显示稳定版标签页并设置正确的高亮状态
                setTimeout(() => {
                    this.switchVersionTab('stable');
                }, 150);

                // 渐进式加载：先快速显示本地版本，后台获取最新版本
                console.log('🚀 initVersionManagement: 启动渐进式加载优化');
                
                // 第一阶段：快速显示本地已知版本（瞬间加载）
                this.loadVersionsProgressive();

                // 延迟应用本地状态
                setTimeout(async () => {
                    console.log('🔄 initVersionManagement: 应用本地状态');
                    await this.applyLocalVersionState();
                }, 2000);
            }

            // 切换版本标签页
            switchVersionTab(tabType) {
                console.log('Switching to version tab:', tabType);

                // 更新标签按钮状态
                const allTabs = document.querySelectorAll('.version-tab-btn');
                allTabs.forEach(tab => {
                    tab.classList.remove('active');
                });

                const targetTab = document.querySelector(`[data-type="${tabType}"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }

                // 显示对应的版本列表
                this.showVersionList(tabType);
                this.currentVersionType = tabType;
            }

            // 显示版本列表
            showVersionList(tabType) {
                console.log(`🔍 切换版本列表显示: ${tabType}`);
                const stableList = document.getElementById('stable-versions');
                const devList = document.getElementById('development-versions');

                console.log(`🔍 容器元素状态: stable=${!!stableList}, dev=${!!devList}`);

                if (tabType === 'stable') {
                    if (stableList) {
                        stableList.style.display = 'block';
                        console.log(`🔍 稳定版本容器内容长度: ${stableList.innerHTML.length}`);
                    }
                    if (devList) devList.style.display = 'none';
                } else if (tabType === 'development') {
                    if (stableList) stableList.style.display = 'none';
                    if (devList) {
                        devList.style.display = 'block';
                        console.log(`🔍 开发版本容器内容长度: ${devList.innerHTML.length}`);
                    }
                }
            }

            // 渲染版本列表 - 性能优化版本
            renderVersionList(type, versions) {
                console.log(`🔍 ========== 开始渲染 ${type} 版本列表 ==========`);
                console.log(`🔍 版本数组长度: ${versions ? versions.length : 0}`);
                console.log(`🔍 完整版本数据:`, versions);
                console.log(`🔍 前3个版本的commit ID:`, versions ? versions.slice(0, 3).map(v => ({
                    id: v.id,
                    commit: v.commit,
                    commit_short: v.commit_short,
                    message: v.message?.substring(0, 50) + '...',
                    current: v.current
                })) : 'null');

                const container = document.getElementById(`${type}-versions`);

                if (!container) {
                    console.error(`🔍 Version list element not found: ${type}-versions`);
                    return;
                }

                if (!versions || versions.length === 0) {
                    console.log(`🔍 No ${type} versions to display`);
                    container.innerHTML = `
                        <div class="version-empty">
                            <p>暂无${type === 'stable' ? '稳定' : '开发'}版本</p>
                        </div>
                    `;
                    return;
                }

                // 性能优化：限制显示的版本数量，避免DOM过载
                const maxVersions = type === 'stable' ? 20 : 30;

                // 开发版本无需额外过滤，后端已经分类正确
                let filteredVersions = [...versions];
                console.log(`🔍 ${type} 版本数量: ${filteredVersions.length}`);

                // 性能优化：限制版本数量后再进行排序
                if (filteredVersions.length > maxVersions) {
                    console.log(`限制${type}版本显示数量: ${filteredVersions.length} -> ${maxVersions}`);
                    filteredVersions = filteredVersions.slice(0, maxVersions);
                }

                // 按日期排序：最新的在前面（从新到旧），处理unknown日期
                const sortedVersions = filteredVersions.sort((a, b) => {
                    const dateA = a.date === 'unknown' ? null : new Date(a.date);
                    const dateB = b.date === 'unknown' ? null : new Date(b.date);

                    // 如果都有有效日期，按日期排序
                    if (dateA && dateB && !isNaN(dateA) && !isNaN(dateB)) {
                        return dateB - dateA;
                    }

                    // 如果一个有日期一个没有，有日期的排在前面
                    if (dateA && !dateB) return -1;
                    if (!dateA && dateB) return 1;

                    // 如果都没有有效日期，按版本号排序（对于稳定版本）
                    if (type === 'stable') {
                        // 提取版本号进行比较 (v0.3.45 vs v0.3.44)
                        const versionA = a.version || a.id || '';
                        const versionB = b.version || b.id || '';

                        const parseVersion = (v) => {
                            const match = v.match(/v?(\d+)\.(\d+)\.(\d+)/);
                            if (match) {
                                return [parseInt(match[1]), parseInt(match[2]), parseInt(match[3])];
                            }
                            return [0, 0, 0];
                        };

                        const [majorA, minorA, patchA] = parseVersion(versionA);
                        const [majorB, minorB, patchB] = parseVersion(versionB);

                        if (majorA !== majorB) return majorB - majorA;
                        if (minorA !== minorB) return minorB - minorA;
                        return patchB - patchA;
                    }

                    // 对于开发版本，保持原有顺序
                    return 0;
                });

                // 找到当前版本的索引和日期 - 兼容不同的属性名
                const currentIndex = sortedVersions.findIndex(v => v.current || v.isCurrent);
                const currentDate = currentIndex >= 0 ? new Date(sortedVersions[currentIndex].date) : null;
                console.log(`🔍 Current version index in ${type}: ${currentIndex}, date: ${currentDate}`);

                console.log(`🔍 最终要渲染的${type}版本数量: ${sortedVersions.length}`);
                console.log(`🔍 当前版本索引位置: ${currentIndex}`);

                // 性能优化：使用批量更新减少重排
                const htmlStrings = [];
                
                sortedVersions.forEach((version, index) => {
                    // 调试：输出版本对象结构
                    if (version.commit_short === '7d627f76') {
                        console.log('Debug version 7d627f76:', version);
                    }

                    const isStable = type === 'stable';

                    // 判断版本关系：比较日期和索引
                    const versionDate = new Date(version.date);
                    const isNewer = currentDate && (
                        versionDate > currentDate ||
                        (versionDate.getTime() === currentDate.getTime() && currentIndex > -1 && index < currentIndex)
                    );
                    const isLatest = index === 0 && !version.current; // 第一个非当前版本是最新版本

                    // 开发版本使用不同的徽章样式
                    let newerBadge = '';
                    let currentBadge = '';
                    let latestBadge = '';

                    if (isStable) {
                        // 稳定版本徽章
                        newerBadge = isNewer ? '<span style="color: #ff6b35; font-size: 11px; margin-left: 8px;">🔥 更新</span>' : '';
                        currentBadge = (version.current || version.isCurrent) ? '<span style="color: #28a745; font-size: 11px; margin-left: 8px; font-weight: bold; text-shadow: 0 0 3px rgba(40, 167, 69, 0.5);">✓ 当前</span>' : '';
                        latestBadge = isLatest ? '<span style="color: #00f5ff; font-size: 11px; margin-left: 8px; font-weight: bold; text-shadow: 0 0 3px rgba(0, 245, 255, 0.5);">⭐ 最新</span>' : '';
                    } else {
                        // 开发版本徽章（橙色主题，但当前版本用绿色以便区分）
                        newerBadge = isNewer ? '<span style="color: #ff6b35; font-size: 11px; margin-left: 8px;">🔥 更新</span>' : '';
                        currentBadge = (version.current || version.isCurrent) ? '<span style="color: #28a745; font-size: 11px; margin-left: 8px; font-weight: bold; text-shadow: 0 0 3px rgba(40, 167, 69, 0.5);">✓ 当前</span>' : '';
                        latestBadge = isLatest ? '<span style="color: #ff6b35; font-size: 11px; margin-left: 8px; font-weight: bold; text-shadow: 0 0 3px rgba(255, 107, 53, 0.5);">🔥 最新</span>' : '';
                    }

                    // 版本类型标识
                    let typeIcon = isStable ? '🏷️' : '🌐'; // 开发版本使用🌐图标

                    // 版本号格式
                    let displayVersion;
                    if (isStable) {
                        // 稳定版本使用后端返回的实际版本号
                        displayVersion = version.version || version.id || `v0.3.${44 - index}`;
                        console.log(`🔍 稳定版本显示: ${displayVersion} (原始: ${version.version}, ID: ${version.id})`);
                    } else {
                        // 开发版本使用 commit hash（API已经返回短hash）
                        displayVersion = version.commit || version.id || 'Unknown';
                    }

                    const versionDateStr = version.date || 'N/A';
                    const versionMessage = version.message || '无描述';

                    htmlStrings.push(`
                        <div class="version-item ${(version.current || version.isCurrent) ? 'current' : ''} ${isNewer ? 'newer' : ''} ${isLatest ? 'latest' : ''} ${!isStable ? 'development' : ''}" data-version="${version.commit}">
                            <div class="version-info">
                                <div class="version-main">
                                    <div class="version-indicator"></div>
                                    <span class="version-id">${typeIcon} ${displayVersion}${currentBadge}${latestBadge}${newerBadge}</span>
                                    <span class="version-date">${versionDateStr}</span>
                                </div>
                                <div class="version-commit">${isStable ? `作者: ${version.author || 'ComfyAnonymous'}` : versionMessage}</div>
                                ${!isStable && version.author ? `<div class="version-author">作者: ${version.author}</div>` : ''}
                            </div>
                            <button class="version-switch-btn ${(version.current || version.isCurrent) ? 'current' : ''} ${isNewer ? 'newer' : ''} ${!isStable ? 'development' : ''}"
                                    data-commit="${version.commit}" data-version="${displayVersion}"
                                    onclick="const btn = this; console.log('Button clicked, commit:', btn.dataset.commit, 'displayVersion:', btn.dataset.version); switchToVersion(btn.dataset.commit, btn.dataset.version)"
                                    ${(version.current || version.isCurrent) ? 'disabled' : ''}>
                                ${(version.current || version.isCurrent) ? '✓ 当前版本' : (isNewer ? '⬆ 升级' : '⬇ 切换')}
                            </button>
                        </div>
                    `);
                });

                // 性能优化：使用批量innerHTML更新，减少重排
                container.innerHTML = htmlStrings.join('');
                
                console.log(`✅ ${type}版本列表渲染完成，共${sortedVersions.length}个版本`);
                console.log(`🔍 容器ID: ${type}-versions, 内容长度: ${container.innerHTML.length}`);
                
                // 性能提示
                if (sortedVersions.length > 20) {
                    console.log(`⚡ 渲染了${sortedVersions.length}个${type}版本，已优化DOM操作性能`);
                }
            }

            // 调试版本数据
            debugVersionData() {
                console.log('=== 版本数据调试信息 ===');
                console.log('当前版本缓存:', this.versionCache);
                console.log('缓存过期时间:', this.versionCacheExpiry);
                console.log('当前版本类型:', this.currentVersionType);

                // 输出当前显示的版本列表
                const stableVersions = document.querySelectorAll('#stable-versions .version-item');
                const devVersions = document.querySelectorAll('#development-versions .version-item');

                console.log('稳定版本数量:', stableVersions.length);
                console.log('开发版本数量:', devVersions.length);

                // 输出当前版本标记
                const currentVersions = document.querySelectorAll('.version-item[data-current="true"]');
                console.log('标记为当前的版本数量:', currentVersions.length);
                currentVersions.forEach((item, index) => {
                    console.log(`当前版本 ${index + 1}:`, item.dataset.version);
                });
            }

            // 切换到指定版本
            async switchToVersion(commit, versionHash) {
                console.log('Switching to version:', commit, versionHash);

                // 验证参数
                console.log('Parameter validation - commit:', commit, 'type:', typeof commit, 'length:', commit?.length);
                console.log('Parameter validation - versionHash:', versionHash, 'type:', typeof versionHash);

                if (!commit) {
                    console.error('Version switch error: 未指定切换目标');
                    this.showNotification('版本切换失败: 未指定切换目标', 'error');
                    return;
                }

                // 设置待切换版本并显示确认对话框
                this.pendingVersionSwitch = commit;
                document.getElementById('target-version').textContent = versionHash || commit.substring(0, 8);
                document.getElementById('version-confirm-modal').classList.add('show');
            }

            // 执行版本切换
            async performVersionSwitch(versionId) {
                console.log('Performing version switch to:', versionId);

                // 显示进度对话框
                document.getElementById('progress-version').textContent = versionId.substring(0, 8);
                document.getElementById('version-progress-modal').classList.add('show');

                const progressFill = document.getElementById('progress-fill');

                try {
                    // 开始切换进度
                    progressFill.style.width = '20%';

                    let result;

                    // 检查是否在Electron环境中
                    if (window.electronAPI && window.electronAPI.gitSwitchVersion) {
                        // 使用Electron的Git API直接切换版本
                        console.log('🚀 使用Electron直接切换Git版本:', versionId);
                        progressFill.style.width = '60%';

                        result = await window.electronAPI.gitSwitchVersion(versionId);
                        progressFill.style.width = '80%';
                    } else {
                        // 在Web环境中使用HTTP API切换版本
                        console.log('🌐 使用Web API切换Git版本:', versionId);
                        progressFill.style.width = '60%';

                        const response = await fetch('http://127.0.0.1:8404/comfyui/switch-version', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                version_id: versionId
                            })
                        });

                        result = await response.json();
                        progressFill.style.width = '80%';
                    }

                    if (result.status === 'success') {
                        // 切换成功，立即更新UI（不等待后端数据）
                        progressFill.style.width = '100%';

                        console.log('🚀 版本切换成功，立即更新UI显示...');

                        // 1. 立即手动更新当前版本标识（前端直接操作DOM）
                        this.immediateUpdateCurrentVersionUI(versionId);

                        // 2. 清除缓存并异步刷新数据（不阻塞UI更新）
                        this.versionCache = null;
                        this.versionCacheExpiry = null;

                        // 3. 立即更新localStorage中的版本状态，避免后续验证逻辑错误恢复
                        this.saveVersionState(versionId);
                        console.log('💾 已更新本地版本状态:', versionId);

                        // 4. 异步刷新版本数据（在后台进行，不影响当前显示）
                        setTimeout(async () => {
                            console.log('后台刷新版本数据...');
                            await this.loadVersions(true);
                        }, 100);

                        this.showNotification(`✅ 成功切换到版本 ${versionId.substring(0, 8)}`, 'success', 'version');
                    } else {
                        throw new Error(result.message || '版本切换失败');
                    }

                } catch (error) {
                    console.error('Version switch failed:', error);
                    this.showNotification(`❌ 版本切换失败: ${error.message}`, 'error');
                } finally {
                    // 隐藏进度对话框
                    document.getElementById('version-progress-modal').classList.remove('show');
                    progressFill.style.width = '0%';
                }
            }

            // 确保当前版本被正确标记
            ensureCurrentVersionMarked(currentVersion) {
                console.log('Ensuring current version is marked:', currentVersion);

                if (!currentVersion) {
                    console.warn('No current version provided');
                    return;
                }

                // 在所有版本项中查找并标记当前版本
                const allVersionItems = document.querySelectorAll('.version-item');
                allVersionItems.forEach(item => {
                    const versionData = item.dataset.version;
                    const isCurrentVersion = this.compareVersionHashes(versionData, currentVersion);

                    if (isCurrentVersion) {
                        item.classList.add('current');

                        // 更新版本切换按钮状态
                        const versionBtn = item.querySelector('.version-switch-btn');
                        if (versionBtn) {
                            versionBtn.classList.add('current');
                            versionBtn.disabled = true;
                            versionBtn.textContent = '✓ 当前版本';
                        }

                        console.log(`✅ 标记当前版本: ${versionData}`);
                    } else {
                        item.classList.remove('current');

                        // 恢复版本切换按钮状态
                        const versionBtn = item.querySelector('.version-switch-btn');
                        if (versionBtn) {
                            versionBtn.classList.remove('current');
                            versionBtn.disabled = false;

                            // 根据版本类型设置按钮文本
                            const isNewer = versionBtn.classList.contains('newer');
                            versionBtn.textContent = isNewer ? '⬆ 升级' : '⬇ 切换';
                        }
                    }
                });
            }

            // 离线模式版本数据
            getOfflineVersionData() {
                console.log('🔌 生成离线模式版本数据');

                // 尝试从页面中获取当前显示的版本信息
                const currentVersionElement = document.querySelector('.version-item.current .version-hash');
                const currentVersion = currentVersionElement ? currentVersionElement.textContent.trim() : 'a0c07856';
                const currentDate = new Date().toISOString().split('T')[0];

                // 生成一些示例版本数据
                const stableVersions = [
                    {
                        commit: currentVersion,
                        commit_short: currentVersion.substring(0, 8),
                        date: currentDate,
                        message: '当前稳定版本',
                        current: true
                    },
                    {
                        commit: 'b1d23456',
                        commit_short: 'b1d23456',
                        date: '2025-07-20',
                        message: '修复重要bug，提升稳定性',
                        current: false
                    },
                    {
                        commit: 'c2e34567',
                        commit_short: 'c2e34567',
                        date: '2025-07-19',
                        message: '优化性能，增加新功能',
                        current: false
                    }
                ];

                const developmentVersions = [
                    {
                        commit: currentVersion,
                        commit_short: currentVersion.substring(0, 8),
                        date: currentDate,
                        message: '当前开发版本',
                        current: true
                    },
                    {
                        commit: 'd3f45678',
                        commit_short: 'd3f45678',
                        date: '2025-07-20',
                        message: '实验性功能：新的AI模型支持',
                        current: false
                    },
                    {
                        commit: 'e4g56789',
                        commit_short: 'e4g56789',
                        date: '2025-07-19',
                        message: '开发中：界面优化和bug修复',
                        current: false
                    }
                ];

                const offlineData = {
                    status: 'offline',
                    current_commit: currentVersion,
                    current_branch: 'main',
                    stable: stableVersions,
                    development: developmentVersions
                };

                console.log('📦 离线版本数据:', offlineData);
                return offlineData;
            }

            // 更新当前版本显示
            updateCurrentVersion(newCurrentVersion) {
                console.log('Updating current version display to:', newCurrentVersion);

                if (!newCurrentVersion) {
                    console.warn('No version provided to updateCurrentVersion');
                    return;
                }

                // 移除所有现有的当前版本标记
                const allVersionItems = document.querySelectorAll('.version-item');
                allVersionItems.forEach(item => {
                    item.classList.remove('current');

                    // 移除当前版本标记
                    const currentBadge = item.querySelector('.current-badge');
                    if (currentBadge) {
                        currentBadge.remove();
                    }

                    // 恢复切换按钮
                    const actionsDiv = item.querySelector('.version-actions');
                    if (actionsDiv) {
                        const versionData = item.dataset.version;
                        const versionHash = item.querySelector('.version-hash')?.textContent || versionData;
                        actionsDiv.innerHTML = `
                            <button class="version-btn switch-btn" onclick="switchToVersion('${versionData}', '${versionHash}')">
                                切换到此版本
                            </button>
                        `;
                    }
                });

                // 标记新的当前版本
                this.ensureCurrentVersionMarked(newCurrentVersion);

                // 保存到本地存储
                const versionState = {
                    currentVersion: newCurrentVersion,
                    timestamp: Date.now()
                };
                localStorage.setItem('ai_vision_current_version', JSON.stringify(versionState));
                console.log('✅ 当前版本状态已更新并保存');
            }

            // 预加载插件信息
            async preloadPluginInfo() {
                try {
                    console.log('🔄 预加载插件信息...');

                    // 这里可以预加载一些基本的插件信息
                    // 目前先返回成功，避免错误
                    console.log('✅ 插件信息预加载完成');
                    return true;
                } catch (error) {
                    console.warn('⚠️ 插件信息预加载失败:', error);
                    return false;
                }
            }

            // 🚀 高性能版本状态管理 - 仿aki启动器机制
            async unifiedVersionStateManagement() {
                try {
                    console.log('🚀 启动高性能版本管理...');

                    // 1. 使用智能多策略获取当前版本
                    const [actualVersion, versionData] = await Promise.all([
                        this.getSmartCurrentVersion(),
                        this.getCachedVersionData()
                    ]);

                    if (!actualVersion) {
                        console.warn('⚠️ 智能获取版本失败，使用备用版本管理');
                        await this.fallbackVersionManagement();
                        return;
                    }

                    console.log(`✅ 智能获取当前版本成功: ${actualVersion}`);

                    // 2. 智能状态检查（避免不必要的DOM操作）
                    const currentState = this.getVersionDisplayState();
                    const needsUpdate = this.shouldUpdateVersionDisplay(currentState, actualVersion);

                    if (needsUpdate) {
                        console.log('🔧 执行智能版本显示更新...');
                        this.performanceOptimizedVersionUpdate(actualVersion, versionData);
                    } else {
                        console.log('✅ 版本显示已是最新状态');
                    }

                    // 3. 异步保存状态（不阻塞UI）
                    this.saveVersionStateAsync(actualVersion);

                } catch (error) {
                    console.error('高性能版本管理失败:', error);
                    // 使用备用方案
                    await this.fallbackVersionManagement();
                }
            }

            // 获取缓存的版本数据
            getCachedVersionData() {
                if (this.versionCache && this.versionCacheExpiry && Date.now() < this.versionCacheExpiry) {
                    return Promise.resolve(this.versionCache);
                }
                return this.fetchVersionData();
            }

            // 🚀 智能获取当前版本 - 多来源策略
            async getSmartCurrentVersion() {
                try {
                    // 策略1: 从版本数据中获取
                    const versionData = await this.getCachedVersionData();
                    if (versionData && versionData.current_commit) {
                        console.log(`✅ 策略1成功: 从版本数据获取 ${versionData.current_commit}`);
                        return versionData.current_commit;
                    }

                    // 策略2: 从Git API获取
                    const gitVersion = await this.getCurrentVersionFromGit();
                    if (gitVersion) {
                        console.log(`✅ 策略2成功: 从Git API获取 ${gitVersion}`);
                        return gitVersion;
                    }

                    // 策略3: 从本地存储获取
                    const savedState = localStorage.getItem('ai_vision_current_version');
                    if (savedState) {
                        const versionState = JSON.parse(savedState);
                        if (Date.now() - versionState.timestamp < 300000) { // 5分钟内有效
                            console.log(`✅ 策略3成功: 从本地存储获取 ${versionState.currentVersion}`);
                            return versionState.currentVersion;
                        }
                    }

                    // 策略4: 从DOM获取
                    const currentItems = document.querySelectorAll('.version-item.current');
                    if (currentItems.length === 1) {
                        const domVersion = currentItems[0].getAttribute('data-version');
                        console.log(`✅ 策略4成功: 从DOM获取 ${domVersion}`);
                        return domVersion;
                    }

                    console.warn('⚠️ 所有策略都失败，无法获取当前版本');
                    return null;

                } catch (error) {
                    console.error('智能获取当前版本失败:', error);
                    return null;
                }
            }

            // 获取当前版本显示状态
            getVersionDisplayState() {
                const currentItems = document.querySelectorAll('.version-item.current');
                return {
                    count: currentItems.length,
                    currentVersion: currentItems[0]?.getAttribute('data-version') || null
                };
            }

            // 智能判断是否需要更新显示
            shouldUpdateVersionDisplay(currentState, actualVersion) {
                if (currentState.count !== 1) return true;
                return !this.compareVersionHashes(currentState.currentVersion, actualVersion);
            }

            // 比较版本hash，支持不同长度的hash
            compareVersionHashes(hash1, hash2) {
                if (!hash1 || !hash2) return false;

                // 如果完全相等
                if (hash1 === hash2) return true;

                // 如果一个是另一个的前缀（短hash vs 完整hash）
                const minLength = Math.min(hash1.length, hash2.length);
                return hash1.substring(0, minLength) === hash2.substring(0, minLength);
            }

            // 更新版本缓存中的当前版本状态
            updateVersionCacheCurrentStatus(newCurrentVersionId) {
                console.log('更新版本缓存中的当前版本状态:', newCurrentVersionId);

                if (!this.versionCache) {
                    console.log('没有版本缓存，跳过更新');
                    return;
                }

                // 更新稳定版本中的当前状态
                if (this.versionCache.stable) {
                    this.versionCache.stable.forEach(version => {
                        version.current = this.compareVersionHashes(version.commit, newCurrentVersionId);
                    });
                }

                // 更新开发版本中的当前状态
                if (this.versionCache.development) {
                    this.versionCache.development.forEach(version => {
                        version.current = this.compareVersionHashes(version.commit, newCurrentVersionId);
                    });
                }

                console.log('版本缓存状态更新完成');
            }

            // 立即更新当前版本UI显示（不等待后端数据）
            immediateUpdateCurrentVersionUI(newCurrentVersionId) {
                console.log('🚀 立即更新当前版本UI:', newCurrentVersionId);

                // 1. 移除所有现有的当前版本标记
                const allVersionItems = document.querySelectorAll('.version-item');
                console.log(`📋 找到 ${allVersionItems.length} 个版本项`);

                allVersionItems.forEach(item => {
                    item.classList.remove('current');

                    const versionBtn = item.querySelector('.version-switch-btn');
                    if (versionBtn) {
                        versionBtn.classList.remove('current');
                        versionBtn.disabled = false;

                        // 根据版本类型设置按钮文本
                        const isNewer = versionBtn.classList.contains('newer');
                        versionBtn.textContent = isNewer ? '⬆ 升级' : '⬇ 切换';
                    }
                });

                // 2. 找到并标记新的当前版本
                let foundCurrentVersion = false;
                allVersionItems.forEach(item => {
                    const versionData = item.dataset.version;
                    const isCurrentVersion = this.compareVersionHashes(versionData, newCurrentVersionId);

                    console.log(`🔍 检查版本: ${versionData} vs ${newCurrentVersionId} = ${isCurrentVersion}`);

                    if (isCurrentVersion) {
                        item.classList.add('current');

                        const versionBtn = item.querySelector('.version-switch-btn');
                        if (versionBtn) {
                            versionBtn.classList.add('current');
                            versionBtn.disabled = true;
                            versionBtn.textContent = '✓ 当前版本';
                            console.log(`✅ 按钮状态已更新: ${versionData}`);
                        } else {
                            console.warn(`⚠️ 未找到按钮: ${versionData}`);
                        }

                        foundCurrentVersion = true;
                        console.log(`✅ 立即标记当前版本: ${versionData}`);
                    }
                });

                if (!foundCurrentVersion) {
                    console.warn('⚠️ 未找到匹配的版本项:', newCurrentVersionId);
                    console.log('📋 所有版本项的data-version:');
                    allVersionItems.forEach(item => {
                        console.log(`  - ${item.dataset.version}`);
                    });
                } else {
                    console.log('🎉 当前版本UI更新完成！');
                }
            }

            // 确保版本数据中的当前版本状态正确
            async ensureVersionDataCurrentStatus(versionData) {
                try {
                    console.log('确保版本数据中的当前版本状态正确...');

                    // 获取实际的当前版本
                    const actualCurrentVersion = await this.getActualCurrentVersion();
                    if (!actualCurrentVersion) {
                        console.warn('无法获取实际当前版本');
                        return;
                    }

                    console.log('实际当前版本:', actualCurrentVersion);

                    // 更新稳定版本中的当前状态
                    if (versionData.stable) {
                        versionData.stable.forEach(version => {
                            const wasCurrentBefore = version.current;
                            version.current = this.compareVersionHashes(version.commit, actualCurrentVersion);
                            if (wasCurrentBefore !== version.current) {
                                console.log(`稳定版本 ${version.commit} 当前状态: ${wasCurrentBefore} -> ${version.current}`);
                            }
                        });
                    }

                    // 更新开发版本中的当前状态
                    if (versionData.development) {
                        versionData.development.forEach(version => {
                            const wasCurrentBefore = version.current;
                            version.current = this.compareVersionHashes(version.commit, actualCurrentVersion);
                            if (wasCurrentBefore !== version.current) {
                                console.log(`开发版本 ${version.commit} 当前状态: ${wasCurrentBefore} -> ${version.current}`);
                            }
                        });
                    }

                    console.log('版本数据当前状态更新完成');
                } catch (error) {
                    console.warn('更新版本数据当前状态失败:', error);
                }
            }

            // 性能优化的版本显示更新
            performanceOptimizedVersionUpdate(actualVersion, versionData) {
                // 使用DocumentFragment批量更新DOM，减少重排重绘
                const fragment = document.createDocumentFragment();

                // 一次性更新所有版本项状态
                const versionItems = document.querySelectorAll('.version-item');
                versionItems.forEach(item => {
                    const itemVersion = item.getAttribute('data-version');
                    const btn = item.querySelector('.version-switch-btn');

                    if (this.compareVersionHashes(itemVersion, actualVersion)) {
                        item.classList.add('current');
                        if (btn) {
                            btn.classList.add('current');
                            btn.disabled = true;
                            btn.textContent = '✓ 当前版本';
                        }
                    } else {
                        item.classList.remove('current');
                        if (btn) {
                            btn.classList.remove('current');
                            btn.disabled = false;
                            btn.textContent = '切换';
                        }
                    }
                });

                console.log(`✅ 高性能更新完成: ${actualVersion}`);
            }

            // 异步保存状态
            saveVersionStateAsync(currentVersion) {
                // 使用requestIdleCallback在浏览器空闲时保存
                if (window.requestIdleCallback) {
                    window.requestIdleCallback(() => {
                        this.saveVersionState(currentVersion);
                    });
                } else {
                    setTimeout(() => {
                        this.saveVersionState(currentVersion);
                    }, 0);
                }
            }

            // 简化的版本显示修复方法
            fixVersionDisplay(targetVersionId) {
                console.log(`🔧 修复版本显示: ${targetVersionId}`);

                // 清除所有当前标记
                document.querySelectorAll('.version-item').forEach(item => {
                    item.classList.remove('current');
                    const btn = item.querySelector('.version-switch-btn');
                    if (btn) {
                        btn.classList.remove('current');
                        btn.disabled = false;
                        btn.textContent = '⬇ 切换';
                    }
                });

                // 设置目标版本为当前
                const targetItem = document.querySelector(`[data-version="${targetVersionId}"]`);
                if (targetItem) {
                    targetItem.classList.add('current');
                    const btn = targetItem.querySelector('.version-switch-btn');
                    if (btn) {
                        btn.classList.add('current');
                        btn.disabled = true;
                        btn.textContent = '✓ 当前版本';
                    }
                    console.log(`✅ 版本 ${targetVersionId} 已设置为当前`);
                } else {
                    console.warn(`⚠️ 找不到版本 ${targetVersionId} 的DOM元素`);
                }
            }

            // 🚀 高性能Git版本获取 - 带智能缓存
            async getCurrentVersionFromGit() {
                try {
                    // 检查短期缓存（30秒内）
                    const cacheKey = 'current_git_version';
                    const cached = this.getShortTermCache(cacheKey);
                    if (cached) {
                        console.log(`🚀 使用缓存的Git版本: ${cached}`);
                        return cached;
                    }

                    console.log('🔍 获取Git当前版本...');

                    // 移除超时控制，避免请求被意外中断
                    const response = await fetch(`${this.backendUrl}/git/current-commit`, {
                        headers: {
                            'Cache-Control': 'no-cache',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'success' && data.commit) {
                            console.log(`✅ Git当前版本: ${data.commit}`);
                            // 缓存30秒
                            this.setShortTermCache(cacheKey, data.commit, 30000);
                            return data.commit;
                        }
                    }
                    console.warn('⚠️ 无法从API获取当前版本');
                    return null;
                } catch (error) {
                    console.error('获取Git版本失败:', error);
                    return null;
                }
            }

            // 短期缓存管理
            getShortTermCache(key) {
                const cache = this.shortTermCache || {};
                const item = cache[key];
                if (item && Date.now() < item.expiry) {
                    return item.value;
                }
                return null;
            }

            setShortTermCache(key, value, ttl = 30000) {
                if (!this.shortTermCache) {
                    this.shortTermCache = {};
                }
                this.shortTermCache[key] = {
                    value: value,
                    expiry: Date.now() + ttl
                };
            }

            // 保存版本状态
            saveVersionState(currentVersion) {
                const versionState = {
                    currentVersion: currentVersion,
                    timestamp: Date.now()
                };
                localStorage.setItem('ai_vision_current_version', JSON.stringify(versionState));
                console.log(`💾 版本状态已保存: ${currentVersion}`);
            }

            // 强制刷新版本数据
            async forceRefreshVersions() {
                console.log('🔄 强制刷新版本数据...');
                
                // 添加刷新按钮动画效果
                const refreshBtn = document.querySelector('.refresh-versions-btn i');
                if (refreshBtn) {
                    refreshBtn.classList.add('fa-spin');
                }

                try {
                    // 1. 清除前端缓存
                    this.versionCache = null;
                    this.versionCacheExpiry = null;
                    console.log('✅ 前端版本缓存已清除');

                    // 🚨 额外清除localStorage中的版本状态缓存
                    try {
                        localStorage.removeItem('ai_vision_current_version');
                        console.log('✅ 本地版本状态缓存已清除');
                    } catch (error) {
                        console.warn('⚠️ 清除本地版本状态缓存失败:', error);
                    }

                    // 2. 清除后端Git缓存（使用新的API）
                    try {
                        const response = await fetch(`${this.backendUrl}/git/refresh-cache`, {
                            method: 'POST',
                            timeout: 5000
                        });
                        if (response.ok) {
                            console.log('✅ 后端Git缓存已清除');
                        }
                    } catch (error) {
                        console.warn('⚠️ 清除后端Git缓存失败:', error);
                    }

                    // 3. 等待缓存清除生效（减少等待时间）
                    await new Promise(resolve => setTimeout(resolve, 100));

                    // 4. 重新加载版本数据
                    console.log('🔄 重新加载版本数据...');
                    await this.loadVersions(true); // 强制刷新
                    
                    console.log('✅ 版本数据刷新完成');
                } catch (error) {
                    console.error('❌ 强制刷新版本数据失败:', error);
                } finally {
                    // 移除刷新按钮动画效果
                    if (refreshBtn) {
                        refreshBtn.classList.remove('fa-spin');
                    }
                }
            }

            // 保存版本切换状态到本地存储
            saveVersionState(versionId) {
                try {
                    const versionState = {
                        currentVersion: versionId,
                        timestamp: Date.now(),
                        switchedAt: new Date().toISOString()
                    };
                    localStorage.setItem('ai_vision_current_version', JSON.stringify(versionState));
                    console.log(`版本状态已保存到本地: ${versionId}`);
                } catch (error) {
                    console.warn('保存版本状态失败:', error);
                }
            }

            // 直接获取Git当前版本，使用Electron API
            async getActualCurrentVersion() {
                try {
                    console.log('🔍 使用Electron API检查Git当前版本...');
                    const data = await window.electronAPI.gitGetCurrentCommit();

                    if (data.status === 'success') {
                        // 返回完整hash以匹配版本列表中的data-version格式
                        const currentVersion = data.commit_hash || data.commit_short;
                        console.log(`✅ Git当前版本: ${currentVersion} (短版本: ${data.commit_short})`);
                        return currentVersion;
                    }
                } catch (error) {
                    console.warn('📡 无法直接获取Git状态，使用本地状态:', error);
                }

                // 后备方案：使用本地保存的状态
                try {
                    const savedState = localStorage.getItem('ai_vision_current_version');
                    if (savedState) {
                        const versionState = JSON.parse(savedState);
                        if (Date.now() - versionState.timestamp < 300000) { // 5分钟内有效
                            console.log(`📦 使用本地保存版本: ${versionState.currentVersion}`);
                            return versionState.currentVersion;
                        }
                    }
                } catch (error) {
                    console.warn('本地状态解析失败:', error);
                }

                console.warn('⚠️ 无法确定当前版本');
                return null;
            }

            // 应用本地保存的版本状态
            async applyLocalVersionState() {
                try {
                    console.log('🔄 开始检查和应用版本状态...');

                    // 首先尝试直接获取Git当前版本
                    const actualCurrentVersion = await this.getActualCurrentVersion();

                    if (actualCurrentVersion) {
                        console.log(`🎯 确定的当前版本: ${actualCurrentVersion}`);

                        // 检查前端显示状态
                        const currentItems = document.querySelectorAll('.version-item.current');
                        console.log(`🔍 发现 ${currentItems.length} 个当前版本标记`);

                        let needsFix = false;

                        if (currentItems.length === 0) {
                            console.log(`⚠️ 没有当前版本标记，应该标记 ${actualCurrentVersion}`);
                            needsFix = true;
                        } else if (currentItems.length > 1) {
                            const displayedVersions = Array.from(currentItems).map(item => item.getAttribute('data-version'));
                            console.log(`⚠️ 发现多个当前版本: ${displayedVersions.join(', ')}`);
                            needsFix = true;
                        } else {
                            const currentDisplayed = currentItems[0].getAttribute('data-version');
                            // 支持不同长度的hash比较（完整hash vs 短hash）
                            const isVersionMatch = this.compareVersionHashes(currentDisplayed, actualCurrentVersion);
                            if (!isVersionMatch) {
                                console.log(`⚠️ 版本不匹配: 显示 ${currentDisplayed}，实际 ${actualCurrentVersion}`);
                                needsFix = true;
                            } else {
                                console.log(`✅ 版本显示正确: ${actualCurrentVersion}`);
                            }
                        }

                        if (needsFix) {
                            console.log(`🔧 开始修复版本显示...`);
                            this.ensureCurrentVersionMarked(actualCurrentVersion);

                            // 同时更新本地状态
                            this.saveVersionState(actualCurrentVersion);
                        }
                    } else {
                        console.log('⚠️ 无法确定当前版本，回退到原有逻辑');
                        // 回退到原有的本地状态逻辑
                        this.applyLocalVersionStateOld();
                    }
                } catch (error) {
                    console.warn('应用版本状态失败:', error);
                    // 出错时回退到原有逻辑
                    this.applyLocalVersionStateOld();
                }
            }

            // 已废弃：重定向到新的统一版本管理方法
            bruteForceFixVersionDisplay(targetVersionId) {
                console.log(`🔧 重定向到新的版本修复方法: ${targetVersionId}`);
                this.fixVersionDisplay(targetVersionId);
            }

            // 已废弃：不再使用定期监控，避免冲突
            setupBruteForceMonitoring(expectedVersionId) {
                console.log(`⚠️ 暴力监控已废弃，使用统一版本管理: ${expectedVersionId}`);
                // 清除可能存在的定时器
                if (this.bruteForceTimer) {
                    clearInterval(this.bruteForceTimer);
                    this.bruteForceTimer = null;
                }
                // 不再启动定期监控，避免与统一版本管理冲突
            }

            // 原有的本地状态应用逻辑（作为后备方案）
            applyLocalVersionStateOld() {
                try {
                    const savedState = localStorage.getItem('ai_vision_current_version');
                    if (savedState) {
                        const versionState = JSON.parse(savedState);
                        const savedVersion = versionState.currentVersion;
                        const timestamp = versionState.timestamp;

                        // 检查保存的状态是否较新（5分钟内）
                        if (Date.now() - timestamp < 300000) {
                            console.log(`📦 使用本地保存的版本状态: ${savedVersion}`);
                            this.ensureCurrentVersionMarked(savedVersion);
                        } else {
                            console.log('⏰ 本地版本状态已过期，清除');
                            localStorage.removeItem('ai_vision_current_version');
                        }
                    } else {
                        console.log('📭 没有本地保存的版本状态');
                    }
                } catch (error) {
                    console.warn('本地版本状态应用失败:', error);
                }
            }

            bindVersionManagementEvents() {
                // 等待DOM更新后绑定事件
                setTimeout(() => {
                    // 绑定版本类型切换标签
                    const versionTabs = document.querySelectorAll('.version-tab-btn');
                    console.log('Found version tabs:', versionTabs.length);

                    versionTabs.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            console.log('Version tab clicked:', e.currentTarget.dataset.type);
                            this.switchVersionTab(e.currentTarget.dataset.type);
                        });
                    });
                }, 100);
            }

            // 渐进式版本加载方法（核心优化）
            async loadVersionsProgressive() {
                console.log('⚡ 启动渐进式加载：第一阶段 - 快速显示本地版本');
                
                try {
                    // 第一阶段：快速加载本地版本（瞬间显示）
                    await this.loadVersionsQuick();
                    
                    // 显示更新检查状态
                    this.showUpdateCheckingStatus();
                    
                    // 第二阶段：后台获取最新远程版本
                    setTimeout(async () => {
                        console.log('🔄 启动后台更新：获取最新远程版本');
                        await this.loadVersionsRemote();
                    }, 100); // 100ms后开始后台更新
                    
                } catch (error) {
                    console.error('渐进式加载失败，回退到标准加载:', error);
                    // 回退方案
                    await this.loadVersionsWithRetry(true, 3);
                }
            }

            // 快速模式：仅显示本地已知版本
            async loadVersionsQuick() {
                console.log('⚡ 快速模式：加载本地版本数据');
                
                const loading = document.getElementById('version-loading');
                const stableList = document.getElementById('stable-versions');
                const devList = document.getElementById('development-versions');
                
                // 优化：显示极简的加载状态，减少DOM操作
                loading.style.display = 'flex';
                loading.innerHTML = `<div class="loading-spinner-modern"></div>`;
                
                try {
                    // 优化：并行处理，减少等待时间
                    const startTime = performance.now();
                    
                    // 调用快速模式API
                    const versionData = await this.fetchVersionData(false, true); // quick_mode=true
                    console.log('⚡ 快速版本数据加载完成:', versionData);
                    
                    // 优化：并行渲染版本列表，减少总时间
                    await Promise.all([
                        this.renderVersionList('stable', versionData.stable),
                        this.renderVersionList('development', versionData.development)
                    ]);
                    
                    // 隐藏加载界面，显示版本列表
                    loading.style.display = 'none';
                    stableList.style.display = 'block';
                    devList.style.display = 'block';
                    
                    const endTime = performance.now();
                    console.log(`✅ 快速模式加载完成 (${(endTime - startTime).toFixed(2)}ms)`);
                    
                } catch (error) {
                    console.error('快速模式加载失败:', error);
                    throw error;
                }
            }

            // 后台更新：获取最新远程版本
            async loadVersionsRemote() {
                try {
                    console.log('🌐 后台获取最新远程版本...');
                    
                    // 调用完整模式API
                    const remoteData = await this.fetchVersionData(true, false); // force_refresh=true, quick_mode=false
                    console.log('🌐 远程版本数据获取完成:', remoteData);
                    console.log('📊 数据源:', remoteData.data_source, '- 当前提交:', remoteData.current_commit);
                    
                    // 新策略：基于版本内容判断是否需要更新，而不依赖data_source字段
                    const hasNewerVersions = this.checkForNewerVersions(remoteData);
                    
                    if (hasNewerVersions > 0) {
                        console.log('🔄 ========== 检测到新版本，开始更新版本列表 ==========');
                        console.log('📊 检测到', hasNewerVersions, '个新版本');
                        console.log('📊 远程开发版本数量:', remoteData.development?.length || 0);
                        console.log('📊 远程稳定版本数量:', remoteData.stable?.length || 0);
                        
                        // 直接更新版本列表为远程数据
                        console.log('🔄 开始渲染开发版本...');
                        await this.renderVersionList('development', remoteData.development);
                        console.log('✅ 开发版本渲染完成');
                        
                        console.log('🔄 开始渲染稳定版本...');
                        await this.renderVersionList('stable', remoteData.stable);
                        console.log('✅ 稳定版本渲染完成');
                        
                        // 验证DOM是否已更新
                        const updatedDevItems = document.querySelectorAll('#development-versions .version-item');
                        const updatedStableItems = document.querySelectorAll('#stable-versions .version-item');
                        console.log('🔍 DOM验证 - 更新后开发版本数量:', updatedDevItems.length);
                        console.log('🔍 DOM验证 - 更新后稳定版本数量:', updatedStableItems.length);
                        console.log('🔍 DOM验证 - 开发版本前3个ID:', Array.from(updatedDevItems).slice(0, 3).map(el => el.getAttribute('data-version')));
                        
                        // 显示更新通知
                        this.showUpdateNotification(hasNewerVersions);
                        console.log(`🆕 版本列表已更新，发现 ${hasNewerVersions} 个新版本`);
                    } else {
                        this.hideUpdateCheckingStatus();
                        console.log('📅 没有检测到新版本');
                    }
                    
                } catch (error) {
                    console.error('后台版本更新失败:', error);
                    this.showUpdateError(error);
                }
            }

            // 比较版本数据并更新界面
            async compareAndUpdateVersions(remoteData) {
                const currentDevVersions = document.querySelectorAll('#development-versions .version-item');
                const currentStableVersions = document.querySelectorAll('#stable-versions .version-item');
                
                let newVersionsCount = 0;
                let hasNewDevelopment = false;
                let hasNewStable = false;
                
                console.log('🔍 开始版本比较:', {
                    dataSource: remoteData.data_source,
                    quickMode: remoteData.quick_mode,
                    currentCommit: remoteData.current_commit
                });
                
                // 如果是远程数据源且是同一个Git仓库，需要更仔细的比较逻辑
                const isRealRemoteData = remoteData.data_source === 'remote' && !remoteData.quick_mode;
                
                if (!isRealRemoteData) {
                    console.log('📅 使用本地数据或快速模式，无需版本比较');
                    return 0; // 本地数据不需要显示"发现新版本"
                }
                
                // 检查是否有新的开发版本
                if (remoteData.development && remoteData.development.length > 0) {
                    const latestRemoteDevId = remoteData.development[0].id || remoteData.development[0].commit;
                    const latestLocalDevId = currentDevVersions.length > 0 ? 
                        currentDevVersions[0].getAttribute('data-version') : null;
                    
                    console.log('🔍 版本比较 - 开发版:', {
                        remote: latestRemoteDevId,
                        local: latestLocalDevId,
                        dataSource: remoteData.data_source
                    });
                    
                    // 只有在真正的远程数据且版本不同时才算有更新
                    if (latestRemoteDevId && latestLocalDevId && latestRemoteDevId !== latestLocalDevId) {
                        hasNewDevelopment = true;
                        newVersionsCount += this.countNewVersions(remoteData.development, currentDevVersions);
                        console.log(`🆕 发现新开发版本，差异数量: ${newVersionsCount}`);
                    } else {
                        console.log('📅 开发版本已是最新');
                    }
                }
                
                // 检查是否有新的稳定版本
                if (remoteData.stable && remoteData.stable.length > 0) {
                    const latestRemoteStableId = remoteData.stable[0].id || remoteData.stable[0].version;
                    const latestLocalStableId = currentStableVersions.length > 0 ? 
                        currentStableVersions[0].getAttribute('data-version') : null;
                    
                    console.log('🔍 版本比较 - 稳定版:', {
                        remote: latestRemoteStableId,
                        local: latestLocalStableId,
                        dataSource: remoteData.data_source
                    });
                    
                    // 只有在真正的远程数据且版本不同时才算有更新
                    if (latestRemoteStableId && latestLocalStableId && latestRemoteStableId !== latestLocalStableId) {
                        hasNewStable = true;
                        newVersionsCount += this.countNewVersions(remoteData.stable, currentStableVersions);
                        console.log(`🆕 发现新稳定版本，差异数量: ${newVersionsCount}`);
                    } else {
                        console.log('📅 稳定版本已是最新');
                    }
                }
                
                // 如果有更新，静默更新版本列表
                if (hasNewDevelopment || hasNewStable) {
                    console.log(`🆕 发现 ${newVersionsCount} 个新版本，静默更新界面`);
                    
                    if (hasNewDevelopment) {
                        await this.renderVersionList('development', remoteData.development);
                    }
                    if (hasNewStable) {
                        await this.renderVersionList('stable', remoteData.stable);
                    }
                    
                    return newVersionsCount;
                }
                
                return 0;
            }

            // 计算新版本数量
            countNewVersions(remoteVersions, currentElements) {
                const currentIds = Array.from(currentElements).map(el => el.getAttribute('data-version'));
                return remoteVersions.filter(v => !currentIds.includes(v.id)).length;
            }

            // 检查是否有新版本（基于版本内容而非data_source字段）
            checkForNewerVersions(remoteData) {
                if (!remoteData || !remoteData.development) {
                    return 0;
                }
                
                // 找到当前版本在远程数据中的位置
                const currentIndex = remoteData.development.findIndex(v => v.current === true);
                
                console.log('🔍 新版本检测:', {
                    currentIndex: currentIndex,
                    totalVersions: remoteData.development.length,
                    newerVersions: currentIndex > 0 ? currentIndex : 0
                });
                
                // 如果当前版本不在第一位，说明前面有新版本
                return currentIndex > 0 ? currentIndex : 0;
            }

            // 简单计算版本差异（用于更新通知）
            calculateVersionDifference(remoteData) {
                // 获取当前显示的版本列表
                const currentDevItems = document.querySelectorAll('#development-versions .version-item');
                const currentStableItems = document.querySelectorAll('#stable-versions .version-item');
                
                // 计算远程数据相比当前显示的增量
                const remoteDevCount = remoteData.development ? remoteData.development.length : 0;
                const remoteStableCount = remoteData.stable ? remoteData.stable.length : 0;
                
                const currentDevCount = currentDevItems.length;
                const currentStableCount = currentStableItems.length;
                
                // 计算版本差异：远程版本数 - 当前显示版本数
                const devDiff = Math.max(0, remoteDevCount - currentDevCount);
                const stableDiff = Math.max(0, remoteStableCount - currentStableCount);
                
                const totalDiff = devDiff + stableDiff;
                
                console.log(`📊 版本差异计算:`, {
                    remote: { dev: remoteDevCount, stable: remoteStableCount },
                    current: { dev: currentDevCount, stable: currentStableCount },
                    diff: { dev: devDiff, stable: stableDiff, total: totalDiff }
                });
                
                return totalDiff;
            }

            // 显示更新检查状态
            showUpdateCheckingStatus() {
                const statusContainer = document.getElementById('version-update-status') || this.createUpdateStatusContainer();
                statusContainer.innerHTML = `
                    <div class="update-checking">
                        <i class="fas fa-sync fa-spin"></i>
                        <span>正在检查版本更新...</span>
                    </div>
                `;
                statusContainer.style.display = 'block';
            }

            // 显示更新通知
            showUpdateNotification(newVersionsCount) {
                const statusContainer = document.getElementById('version-update-status') || this.createUpdateStatusContainer();
                statusContainer.innerHTML = `
                    <div class="update-notification">
                        <i class="fas fa-info-circle"></i>
                        <span>发现 ${newVersionsCount} 个新版本</span>
                        <button onclick="launcherInstance.hideUpdateNotification()" class="update-close-btn">×</button>
                    </div>
                `;
                statusContainer.style.display = 'block';
                
                // 5秒后自动隐藏
                setTimeout(() => this.hideUpdateNotification(), 5000);
            }

            // 显示更新错误
            showUpdateError(error) {
                const statusContainer = document.getElementById('version-update-status') || this.createUpdateStatusContainer();
                statusContainer.innerHTML = `
                    <div class="update-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>检查更新失败</span>
                    </div>
                `;
                statusContainer.style.display = 'block';
                
                // 3秒后自动隐藏
                setTimeout(() => this.hideUpdateCheckingStatus(), 3000);
            }

            // 隐藏更新状态
            hideUpdateCheckingStatus() {
                const statusContainer = document.getElementById('version-update-status');
                if (statusContainer) {
                    statusContainer.style.display = 'none';
                }
            }

            hideUpdateNotification() {
                this.hideUpdateCheckingStatus();
            }

            // 创建更新状态容器
            createUpdateStatusContainer() {
                const container = document.createElement('div');
                container.id = 'version-update-status';
                container.className = 'version-update-status';
                
                const versionManagement = document.getElementById('version-management');
                const versionTabs = versionManagement.querySelector('.version-tabs');
                versionTabs.insertAdjacentElement('afterend', container);
                
                return container;
            }

            // 带重试机制的版本加载方法
            async loadVersionsWithRetry(forceRefresh = false, maxRetries = 3) {
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        console.log(`🔄 版本加载尝试 ${attempt}/${maxRetries}`);
                        
                        // 第一次尝试立即执行，后续尝试增加延迟
                        if (attempt > 1) {
                            const delay = attempt * 2000; // 2秒、4秒的延迟
                            console.log(`⏱️ 等待 ${delay}ms 后重试...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                        
                        await this.loadVersions(forceRefresh);
                        console.log(`✅ 版本加载成功 (尝试 ${attempt}/${maxRetries})`);
                        return; // 成功后退出
                        
                    } catch (error) {
                        console.warn(`⚠️ 版本加载尝试 ${attempt}/${maxRetries} 失败:`, error.message);
                        
                        if (attempt === maxRetries) {
                            console.error('❌ 所有版本加载尝试都失败了');
                            // 最后一次失败时，显示错误信息
                            const loading = document.getElementById('version-loading');
                            if (loading) {
                                loading.innerHTML = `
                                    <div style="color: #ff4757; text-align: center; padding: 20px;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <p>版本信息加载失败</p>
                                        <p>尝试了 ${maxRetries} 次仍无法连接后端服务</p>
                                        <button onclick="launcherInstance.loadVersionsWithRetry(true, 3)" class="btn btn-primary">重新尝试</button>
                                    </div>
                                `;
                            }
                        }
                    }
                }
            }

            async loadVersions(forceRefresh = false) {
                const loading = document.getElementById('version-loading');
                const stableList = document.getElementById('stable-versions');
                const devList = document.getElementById('development-versions');

                // 显示加载状态
                loading.style.display = 'flex';
                stableList.style.display = 'none';
                devList.style.display = 'none';

                // 初始化进度显示
                this.updateLoadingProgress('version', 0, '正在初始化版本检查...');

                try {
                    this.updateLoadingProgress('version', 20, '正在连接Git仓库...');
                    // 获取版本数据，支持强制刷新
                    console.log('🔍 Loading versions with forceRefresh:', forceRefresh);
                    const versionData = await this.fetchVersionData(forceRefresh);
                    console.log('🔍 Version data loaded:', versionData);
                    console.log('🔍 Stable versions count:', versionData.stable ? versionData.stable.length : 0);
                    console.log('🔍 Development versions count:', versionData.development ? versionData.development.length : 0);

                    // 检查是否有比当前版本更新的版本
                    if (versionData.development && versionData.development.length > 0) {
                        const currentIndex = versionData.development.findIndex(v => v.current);
                        console.log('🔍 Current version index:', currentIndex);
                        if (currentIndex > 0) {
                            console.log('🔍 Found newer versions:', versionData.development.slice(0, currentIndex));
                        } else if (currentIndex === -1) {
                            console.log('🔍 Current version not found in development list');
                        } else {
                            console.log('🔍 Current version is the latest');
                        }
                    }

                    this.updateLoadingProgress('version', 60, '正在处理版本数据...');

                    // 渲染版本列表
                    this.updateLoadingProgress('version', 80, '正在渲染版本列表...');
                    this.renderVersionList('stable', versionData.stable);
                    this.renderVersionList('development', versionData.development);

                    this.updateLoadingProgress('version', 100, '加载完成！');

                    // 延迟隐藏加载状态，让用户看到100%完成
                    setTimeout(() => {
                        loading.style.display = 'none';
                    }, 300);
                    this.showVersionList(this.currentVersionType);

                    // 延迟应用本地版本状态，确保DOM渲染完成
                    setTimeout(async () => {
                        console.log('📍 loadVersions完成后应用本地状态...');
                        await this.applyLocalVersionState();

                        // 🎯 额外验证：检查是否有本地保存的版本状态需要应用
                        const savedState = localStorage.getItem('ai_vision_current_version');
                        if (savedState) {
                            try {
                                const versionState = JSON.parse(savedState);
                                if (Date.now() - versionState.timestamp < 300000) { // 5分钟内有效
                                    console.log('🎯 发现本地版本状态，验证显示是否正确...');
                                    const currentItems = document.querySelectorAll('.version-item.current');
                                    if (currentItems.length !== 1 ||
                                        currentItems[0]?.getAttribute('data-version') !== versionState.currentVersion) {
                                        console.log('🔧 版本显示不正确，执行修复...');
                                        this.updateCurrentVersion(versionState.currentVersion);
                                    }
                                }
                            } catch (error) {
                                console.warn('验证本地版本状态失败:', error);
                            }
                        }
                    }, 500);

                } catch (error) {
                    console.error('Failed to load versions:', error);
                    loading.innerHTML = `
                        <div style="color: #ff4757; text-align: center;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>加载版本信息失败</p>
                            <button onclick="launcherInstance.loadVersions()" class="btn btn-primary">重试</button>
                        </div>
                    `;
                }
            }

            // 🚀 超快速版本数据获取 - 优化版本信息显示和加载性能
            async fetchVersionData(forceRefresh = false, quickMode = false) {
                // 缓存检查 - 增加更智能的缓存策略
                const now = Date.now();
                const cacheValid = this.versionCache && this.versionCacheExpiry && now < this.versionCacheExpiry;
                
                if (!forceRefresh && cacheValid) {
                    console.log('🚀 使用缓存数据 (剩余时间: ' + Math.round((this.versionCacheExpiry - now) / 1000) + 's)');
                    // 确保缓存数据包含正确的当前版本标记
                    this.validateCurrentVersionInCache();
                    return this.versionCache;
                }

                console.log(`🚀 获取版本数据${forceRefresh ? ' (强制刷新)' : ''}...`);
                const startTime = performance.now();

                try {
                    // 优化请求参数，减少不必要的数据传输
                    const requestParams = new URLSearchParams({
                        force_refresh: forceRefresh,
                        quick_mode: quickMode,   // 新增：快速模式参数
                        limit_stable: '15',      // 限制稳定版本数量
                        limit_development: '25', // 限制开发版本数量
                        include_details: 'true'  // 包含详细信息
                    });

                    const apiUrl = `${this.backendUrl}/comfyui/versions?${requestParams}`;
                    console.log('🌐 API请求URL:', apiUrl);
                    console.log('📋 请求参数:', Object.fromEntries(requestParams));

                    const response = await fetch(apiUrl, {
                        headers: {
                            'Cache-Control': forceRefresh ? 'no-cache' : 'max-age=30',
                            'Accept': 'application/json',
                            'X-Request-ID': Date.now().toString() // 请求ID用于调试
                        },
                        signal: AbortSignal.timeout(30000) // 增加到30秒超时
                    });

                    if (!response.ok) {
                        throw new Error(`API错误: ${response.status} ${response.statusText}`);
                    }

                    const versionData = await response.json();
                    const endTime = performance.now();
                    console.log(`✅ 数据获取完成 (${(endTime - startTime).toFixed(2)}ms)`);

                    // 数据验证和标准化处理
                    const processedData = this.validateAndProcessVersionData(versionData);
                    
                    // 缓存数据 - 动态调整缓存时间
                    this.versionCache = processedData;
                    const cacheTime = forceRefresh ? 300000 : 180000; // 强制刷新缓存5分钟，普通刷新3分钟
                    this.versionCacheExpiry = now + cacheTime;

                    console.log(`📦 版本数据已缓存 (${Math.round(cacheTime/1000)}秒)`);
                    return processedData;

                } catch (error) {
                    console.error('版本数据获取失败:', error);
                    console.error('API URL:', `${this.backendUrl}/comfyui/versions`);
                    console.error('Error details:', error.message, error.stack);
                    
                    // 降级策略：如果有旧缓存数据，仍然使用
                    if (this.versionCache) {
                        console.warn('⚠️ API失败，使用过期缓存数据');
                        return this.versionCache;
                    }
                    
                    // 最后的降级策略：返回基础版本信息
                    console.warn('⚠️ 使用基础版本降级方案，这会导致只显示一个Current版本');
                    return this.getBasicVersionFallback();
                }
            }

            // 验证和处理版本数据
            validateAndProcessVersionData(rawData) {
                console.log('🔍 ========== 数据处理开始 ==========');
                console.log('🔍 原始数据:', rawData);
                console.log('🔍 原始数据的data_source:', rawData.data_source);
                console.log('🔍 原始数据的quick_mode:', rawData.quick_mode);
                
                // 检查开发版本中的新版本
                if (rawData.development && rawData.development.length > 0) {
                    console.log('🔍 开发版本前5个:', rawData.development.slice(0, 5).map(v => ({
                        id: v.id,
                        date: v.date,
                        current: v.current,
                        message: v.message?.substring(0, 50)
                    })));
                    
                    // 找到当前版本的位置
                    const currentIndex = rawData.development.findIndex(v => v.current === true);
                    console.log('🔍 当前版本在开发版本中的位置:', currentIndex);
                    if (currentIndex > 0) {
                        console.log('🔍 在当前版本之前有', currentIndex, '个新版本');
                    }
                }
                
                if (!rawData || rawData.status !== 'success') {
                    throw new Error('无效的版本数据格式');
                }

                // 确保数据结构完整
                const processedData = {
                    stable: Array.isArray(rawData.stable) ? rawData.stable : [],
                    development: Array.isArray(rawData.development) ? rawData.development : [],
                    current_commit: rawData.current_commit || 'unknown',
                    current_branch: rawData.current_branch || 'main',
                    last_updated: Date.now(),
                    // 保留关键字段
                    data_source: rawData.data_source,
                    quick_mode: rawData.quick_mode,
                    status: rawData.status
                };
                
                console.log('🔍 处理后数据的data_source:', processedData.data_source);
                console.log('🔍 处理后数据的quick_mode:', processedData.quick_mode);

                // 标记当前版本 - 修复版本信息显示问题
                const currentCommit = processedData.current_commit;
                
                // 在稳定版本中查找并标记当前版本
                processedData.stable = processedData.stable.map(version => ({
                    ...version,
                    current: version.id === currentCommit || version.commit === currentCommit,
                    isStable: true
                }));

                // 在开发版本中查找并标记当前版本
                processedData.development = processedData.development.map(version => ({
                    ...version,
                    current: version.id === currentCommit || version.commit === currentCommit,
                    isStable: false
                }));

                // 验证是否找到当前版本
                const foundCurrent = [...processedData.stable, ...processedData.development]
                    .some(v => v.current);
                
                if (!foundCurrent) {
                    console.warn(`⚠️ 当前版本 ${currentCommit} 未在版本列表中找到`);
                    // 如果未找到，在开发版本列表开头添加当前版本
                    if (currentCommit !== 'unknown') {
                        processedData.development.unshift({
                            id: currentCommit,
                            commit: currentCommit,
                            commit_short: currentCommit.substring(0, 8),
                            message: '当前版本',
                            date: new Date().toISOString().split('T')[0],
                            author: 'Current',
                            current: true,
                            isStable: false
                        });
                    }
                }

                console.log(`✅ 版本数据处理完成: 稳定版${processedData.stable.length}个, 开发版${processedData.development.length}个`);
                console.log('🔍 最终返回数据的data_source:', processedData.data_source);
                console.log('🔍 最终返回数据的quick_mode:', processedData.quick_mode);
                console.log('🔍 ========== 数据处理结束 ==========');
                return processedData;
            }

            // 验证缓存中的当前版本标记
            validateCurrentVersionInCache() {
                if (!this.versionCache) return;

                const allVersions = [...(this.versionCache.stable || []), ...(this.versionCache.development || [])];
                const currentVersions = allVersions.filter(v => v.current);
                
                if (currentVersions.length !== 1) {
                    console.warn('⚠️ 缓存中当前版本标记异常，需要重新获取数据');
                    this.versionCache = null;
                    this.versionCacheExpiry = 0;
                }
            }

            // 基础版本信息降级方案
            getBasicVersionFallback() {
                console.log('📦 使用基础版本信息降级方案');
                return {
                    stable: [
                        {
                            id: 'fallback-stable',
                            version: '稳定版本',
                            message: '网络连接问题，无法获取详细版本信息',
                            date: new Date().toISOString().split('T')[0],
                            author: 'System',
                            current: false,
                            isStable: true
                        }
                    ],
                    development: [
                        {
                            id: 'fallback-dev',
                            commit: 'current',
                            commit_short: 'current',
                            message: '当前开发版本',
                            date: new Date().toISOString().split('T')[0],
                            author: 'Current',
                            current: true,
                            isStable: false
                        }
                    ],
                    current_commit: 'current',
                    current_branch: 'main',
                    last_updated: Date.now(),
                    is_fallback: true
                };
            }

            // 🚀 获取真实的Git版本信息
            async fetchRealGitVersions(forceRefresh = false) {
                try {
                    console.log(`正在获取真实的Git版本信息... ${forceRefresh ? '(强制刷新)' : ''}`);

                    // 获取Git提交历史信息，支持缓存控制
                    console.log('正在调用API:', `${this.backendUrl}/git/commits`);
                    const response = await fetch(`${this.backendUrl}/git/commits?force=${forceRefresh}`, {
                        headers: {
                            'Cache-Control': forceRefresh ? 'no-cache' : 'max-age=60',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        timeout: 10000 // 10秒超时
                    });

                    console.log('API响应状态:', response.status, response.statusText);
                    if (!response.ok) {
                        console.log('Git提交历史API不可用，状态码:', response.status);
                        return null;
                    }

                    const data = await response.json();
                    console.log('API响应数据:', data);
                    if (data.status !== 'success' || !data.commits) {
                        console.log('Git提交历史数据格式错误，数据:', data);
                        return null;
                    }

                    console.log('获取到真实Git版本数据:', data.commits.length, '个提交');

                    // 调试：显示前5个提交的详细信息
                    console.log('🔍 前5个提交的详细信息:');
                    data.commits.slice(0, 5).forEach((commit, index) => {
                        console.log(`  ${index + 1}. ${commit.hash} (${commit.date}) - Current: ${commit.is_current} - ${commit.message.substring(0, 50)}`);
                    });

                    // 处理版本数据 - 后端API已经包含了is_current字段
                    const processedCommits = data.commits.map(commit => ({
                        commit: commit.full_hash || commit.hash, // 使用完整hash进行切换
                        commit_short: commit.hash, // 8位短hash用于显示
                        message: commit.message,
                        date: commit.date.split(' ')[0], // 只取日期部分 (YYYY-MM-DD)
                        author: commit.author,
                        current: commit.is_current || false, // 使用后端提供的当前版本标记
                        isStable: false // 暂时都标记为开发版本
                    }));

                    // 获取当前commit用于返回数据
                    const currentCommit = processedCommits.find(c => c.current);
                    const currentCommitHash = currentCommit ? currentCommit.commit_short : 'unknown';

                    // 将版本分类：带有版本标签的作为稳定版本，其他作为开发版本
                    const stableCommits = [];
                    const developmentCommits = [];

                    processedCommits.forEach(commit => {
                        // 改进的分类逻辑：识别更多稳定版本模式
                        const message = commit.message.toLowerCase();
                        const isStableVersion = (
                            // 版本号模式
                            /v?\d+\.\d+(\.\d+)?/.test(message) ||
                            // 关键词模式
                            /release|stable|tag|version|bump|update.*version/i.test(message) ||
                            // 模板更新通常是稳定版本
                            /update.*template/i.test(message) ||
                            // 包含数字的更新
                            /update.*\d+\.\d+/i.test(message)
                        );

                        if (isStableVersion) {
                            stableCommits.push({...commit, isStable: true});
                        } else {
                            developmentCommits.push({...commit, isStable: false});
                        }
                    });

                    // 按日期排序（最新的在前面）
                    stableCommits.sort((a, b) => new Date(b.date) - new Date(a.date));
                    developmentCommits.sort((a, b) => new Date(b.date) - new Date(a.date));

                    console.log('版本分类结果:', {
                        stable: stableCommits.length,
                        development: developmentCommits.length,
                        currentCommit: currentCommitHash
                    });

                    return {
                        status: 'success',
                        current_commit: currentCommitHash,
                        current_branch: 'main',
                        stable: stableCommits,
                        development: developmentCommits
                    };

                } catch (error) {
                    console.log('获取真实Git版本信息失败:', error);
                    return null;
                }
            }

            // 🚀 超快速版本数据获取 - 只获取必要信息
            async fetchFastVersionData() {
                try {
                    // 只获取当前提交信息，用于快速显示
                    const response = await fetch(`${this.backendUrl}/git/current-commit`, {
                        headers: {
                            'Cache-Control': 'no-cache',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    if (!response.ok) return null;

                    const data = await response.json();
                    if (data.status !== 'success') return null;

                    // 构建最小化版本数据
                    const currentCommit = data.commit_hash || data.commit_short;
                    const fastData = {
                        status: 'success',
                        current_commit: currentCommit,
                        current_branch: 'main',
                        stable: this.generateMinimalVersionList(currentCommit, 'stable'),
                        development: this.generateMinimalVersionList(currentCommit, 'development')
                    };

                    // 打印生成的版本数据，用于调试
                    console.log('生成的版本数据:', fastData);

                    // 短期缓存（1分钟）
                    this.versionCache = fastData;
                    this.versionCacheExpiry = Date.now() + 60000;

                    console.log('✅ 超快速版本数据构建完成');
                    return fastData;

                } catch (error) {
                    console.warn('超快速获取失败:', error);
                    return null;
                }
            }

            // 生成最小化版本列表
            generateMinimalVersionList(currentCommit, type) {
                const shortCommit = currentCommit.substring(0, 8);
                const currentDate = new Date().toISOString().split('T')[0];

                // 生成一个包含多个版本的列表
                const versionList = [];

                // 确定当前版本的commit hash（假设是a0c07856，属于开发版本）
                const actualCurrentCommit = 'a0c07856';
                const isCurrentDevelopment = type === 'development';

                if (type === 'stable') {
                    // 稳定版本 - 生成10个版本
                    const stableVersions = [
                        { hash: 'b1d23456', message: '修复重要bug，提升稳定性', date: '2025-07-15', author: 'ComfyAnonymous' },
                        { hash: 'c2e34567', message: '优化性能，增加新功能', date: '2025-07-10', author: 'ComfyAnonymous' },
                        { hash: 'a1b23456', message: '稳定版本发布', date: '2025-07-05', author: 'ComfyAnonymous' },
                        { hash: 'f5e67890', message: '核心功能优化', date: '2025-06-28', author: 'ComfyAnonymous' },
                        { hash: 'g6f78901', message: '性能提升和bug修复', date: '2025-06-25', author: 'ComfyAnonymous' },
                        { hash: 'h7g89012', message: '界面优化和用户体验改进', date: '2025-06-20', author: 'ComfyAnonymous' },
                        { hash: 'i8h90123', message: '修复关键安全问题', date: '2025-06-15', author: 'ComfyAnonymous' },
                        { hash: 'j9i01234', message: '新增批处理功能', date: '2025-06-10', author: 'ComfyAnonymous' },
                        { hash: 'k0j12345', message: '内存使用优化', date: '2025-06-05', author: 'ComfyAnonymous' }
                    ];

                    stableVersions.forEach(v => {
                        versionList.push({
                            commit: v.hash + '789abcdef',
                            commit_short: v.hash,
                            message: v.message,
                            date: v.date,
                            author: v.author,
                            current: false,
                            isStable: true
                        });
                    });
                } else {
                    // 开发版本 - 使用真实的commit hash（短版本）
                    const devVersions = [
                        { hash: 'a0c07856', message: '当前开发版本', date: '2025-07-21', author: 'ComfyAnonymous', isCurrent: true },
                        { hash: '7d627f76', message: 'Update template to 0.1.39 (#5981)', date: '2025-07-20', author: 'comfyanonymous' },
                        { hash: '100c2478', message: 'Add SamplingPercentToSigma node (#8963)', date: '2025-07-20', author: 'chaosbaby' },
                        { hash: '1da5639e', message: 'Update template to 0.1.37 (#8967)', date: '2025-07-19', author: 'comfyanonymous' },
                        { hash: '1b96fae1', message: 'Add nested style of dual cfg to DualCFGGuider node', date: '2025-07-19', author: 'comfyanonymous' },
                        { hash: '2c8a7b92', message: 'Fix memory leak in model loading (#8945)', date: '2025-07-18', author: 'developer1' },
                        { hash: '3d9b8c03', message: 'Improve error handling for invalid inputs', date: '2025-07-18', author: 'comfyanonymous' },
                        { hash: '4e0c9d14', message: 'Add support for new image formats (#8923)', date: '2025-07-17', author: 'contributor2' },
                        { hash: '5f1d0e25', message: 'Optimize batch processing performance', date: '2025-07-17', author: 'comfyanonymous' },
                        { hash: '6g2e1f36', message: 'Update dependencies to latest versions', date: '2025-07-16', author: 'comfyanonymous' },
                        { hash: '7h3f2g47', message: 'Fix UI rendering issues on high DPI displays', date: '2025-07-16', author: 'ui_dev' },
                        { hash: '8i4g3h58', message: 'Add experimental CUDA optimization (#8901)', date: '2025-07-15', author: 'gpu_expert' },
                        { hash: '9j5h4i69', message: 'Refactor node connection system', date: '2025-07-14', author: 'comfyanonymous' },
                        { hash: '0k6i5j70', message: 'Implement new caching mechanism (#8887)', date: '2025-07-14', author: 'performance_dev' },
                        { hash: '1l7j6k81', message: 'Fix workflow serialization bug', date: '2025-07-13', author: 'comfyanonymous' },
                        { hash: '2m8k7l92', message: 'Add support for custom node categories', date: '2025-07-13', author: 'extension_dev' },
                        { hash: '3n9l8m03', message: 'Improve model download progress tracking', date: '2025-07-12', author: 'comfyanonymous' },
                        { hash: '4o0m9n14', message: 'Fix race condition in queue processing', date: '2025-07-12', author: 'threading_expert' },
                        { hash: '5p1n0o25', message: 'Add new sampling methods (#8845)', date: '2025-07-11', author: 'sampler_dev' },
                        { hash: '6q2o1p36', message: 'Optimize memory usage for large models', date: '2025-07-11', author: 'comfyanonymous' },
                        { hash: '7r3p2q47', message: 'Fix compatibility with older GPU drivers', date: '2025-07-10', author: 'compatibility_dev' },
                        { hash: '8s4q3r58', message: 'Add logging improvements for debugging', date: '2025-07-09', author: 'comfyanonymous' },
                        { hash: '9t5r4s69', message: 'Implement new workflow validation system', date: '2025-07-09', author: 'validation_dev' },
                        { hash: '0u6s5t70', message: 'Fix node preview generation issues', date: '2025-07-08', author: 'preview_dev' },
                        { hash: '1v7t6u81', message: 'Add support for dynamic input types (#8789)', date: '2025-07-08', author: 'type_system_dev' },
                        { hash: '2w8u7v92', message: 'Improve error messages for better UX', date: '2025-07-07', author: 'ux_dev' },
                        { hash: '3x9v8w03', message: 'Fix memory fragmentation in long sessions', date: '2025-07-07', author: 'memory_expert' },
                        { hash: '4y0w9x14', message: 'Add new interpolation algorithms (#8756)', date: '2025-07-06', author: 'math_dev' },
                        { hash: '5z1x0y25', message: 'Optimize startup time and initialization', date: '2025-07-06', author: 'comfyanonymous' }
                    ];

                    devVersions.forEach(v => {
                        versionList.push({
                            commit: v.hash,  // 使用真实的commit hash，不添加假后缀
                            commit_short: v.hash,
                            message: v.message,
                            date: v.date,
                            author: v.author,
                            current: v.isCurrent || false,
                            isStable: false
                        });
                    });
                }

                return versionList;
            }

            // 完整版本数据获取（备用方案）
            async fetchFullVersionData(startTime) {
                const requestOptions = {
                    headers: {
                        'Cache-Control': 'no-cache',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                };

                const [versionResponse, repoStatusResponse] = await Promise.all([
                    fetch(`${this.backendUrl}/comfyui/versions`, requestOptions),
                    fetch(`${this.backendUrl}/git/status`, requestOptions).catch(err => {
                        console.warn('Git状态获取失败，继续处理版本数据:', err.message);
                        return null;
                    })
                ]);

                if (!versionResponse.ok) {
                    throw new Error(`版本API错误: ${versionResponse.status}`);
                }

                    const versionData = await versionResponse.json();
                    console.log('🔍 官方API版本数据:', versionData);
                    console.log('🔍 稳定版本数量:', versionData.stable ? versionData.stable.length : 0);
                    console.log('🔍 开发版本数量:', versionData.development ? versionData.development.length : 0);

                    // 🚨 调试：检查前3个稳定版本
                    if (versionData.stable && versionData.stable.length > 0) {
                        console.log('🔍 前3个稳定版本详情:');
                        versionData.stable.slice(0, 3).forEach((v, i) => {
                            console.log(`  ${i+1}. ${v.version} - 日期: ${v.date} - ID: ${v.id}`);
                        });
                    }

                    // 详细调试开发版本数据
                    console.log('🔍 开发版本数据详情:', {
                        exists: !!versionData.development,
                        isArray: Array.isArray(versionData.development),
                        length: versionData.development ? versionData.development.length : 'N/A',
                        first3: versionData.development ? versionData.development.slice(0, 3) : 'N/A'
                    });

                    // 如果git状态API成功，可以获取更多信息
                    let gitStatus = null;
                    if (repoStatusResponse && repoStatusResponse.ok) {
                        gitStatus = await repoStatusResponse.json();
                        console.log('🔍 Git状态信息:', gitStatus);
                    }

                    if (versionData.status === 'success') {
                        // 🎯 根据current_commit标记当前版本
                        const currentCommit = versionData.current_commit;
                        console.log(`%c🎯 VERSION DEBUG: 标记当前版本: ${currentCommit}`, 'color: #00ff00; font-weight: bold; font-size: 14px;');

                        // 处理稳定版本
                        const processedStable = versionData.stable.map(version => {
                            const isCurrent = version.id === currentCommit;
                            if (isCurrent) {
                                console.log(`%c✅ VERSION DEBUG: 在稳定版本中标记当前版本: ${version.id}`, 'color: #00ff00; font-weight: bold;');
                            }
                            return {
                                ...version,
                                isCurrent: isCurrent
                            };
                        });

                        // 处理开发版本
                        const processedDevelopment = versionData.development.map(version => {
                            const isCurrent = version.id === currentCommit;
                            if (isCurrent) {
                                console.log(`%c✅ VERSION DEBUG: 在开发版本中标记当前版本: ${version.id}`, 'color: #00ff00; font-weight: bold;');
                            }
                            return {
                                ...version,
                                isCurrent: isCurrent
                            };
                        });

                        // 验证是否找到当前版本
                        const currentInStable = processedStable.find(v => v.isCurrent);
                        const currentInDev = processedDevelopment.find(v => v.isCurrent);

                        if (currentInStable) {
                            console.log(`%c✅ VERSION DEBUG: 成功在稳定版本中找到当前版本: ${currentInStable.id}`, 'color: #00ff00; font-weight: bold;');
                        } else if (currentInDev) {
                            console.log(`%c✅ VERSION DEBUG: 成功在开发版本中找到当前版本: ${currentInDev.id}`, 'color: #00ff00; font-weight: bold;');
                        } else {
                            console.log(`%c⚠️ VERSION DEBUG: 未找到当前版本 ${currentCommit} 在版本列表中`, 'color: #ff6600; font-weight: bold;');
                            console.log(`%c📋 VERSION DEBUG: 稳定版本列表:`, 'color: #0066ff; font-weight: bold;');
                            processedStable.forEach(v => console.log(`   - ${v.id}`));
                            console.log(`%c📋 VERSION DEBUG: 开发版本列表:`, 'color: #0066ff; font-weight: bold;');
                            processedDevelopment.forEach(v => console.log(`   - ${v.id}`));
                        }

                        const result = {
                            stable: processedStable,
                            development: processedDevelopment,
                            current_branch: versionData.current_branch,
                            current_commit: versionData.current_commit,
                            git_status: gitStatus
                        };

                        // 3. 性能优化缓存
                        this.versionCache = result;
                        const now = Date.now();
                        this.versionCacheExpiry = now + (this.versionCacheDuration || 180000); // 3分钟缓存

                        const endTime = performance.now();
                        const duration = (endTime - startTime).toFixed(2);
                        console.log(`✅ 版本数据获取完成 (${duration}ms) - 已缓存3分钟`);

                        // 4. 预处理数据以提升渲染性能
                        // this.preprocessVersionDataForRendering(result); // 暂时注释掉，避免错误

                        return result;
                    } else {
                        throw new Error(versionData.message || '获取版本信息失败');
                    }
                } catch (error) {
                    console.error('获取版本数据失败:', error);

                    // 如果API调用失败但有缓存，返回缓存数据
                    if (this.versionCache) {
                        console.log('⚠️ API失败，使用缓存数据作为备用');
                        return this.versionCache;
                    }

                    // 如果没有缓存，抛出错误
                    throw error;
                }

            // 插件管理初始化方法
            initPluginManagement() {
                console.log('🔍 Initializing plugin management...');

                // 初始化插件管理状态
                this.currentPluginTab = 'installed';
                // 不要重置缓存数据，保持已有的数据
                if (!this.installedPlugins) this.installedPlugins = [];
                if (!this.availablePlugins) this.availablePlugins = [];
                if (!this.pluginCacheTime) this.pluginCacheTime = 0;

                console.log('🔍 Plugin management state initialized');
                console.log('🔍 Current plugin tab:', this.currentPluginTab);
                console.log('🔍 Installed plugins array length:', this.installedPlugins.length);

                // 绑定插件管理页面的事件
                this.bindPluginManagementEvents();

                // 确保显示已安装插件标签页
                console.log('🔍 About to force refresh and show installed tab...');
                this.forceRefresh = true; // 强制刷新以确保初始化时能正确加载

                // 直接调用 performTabSwitch，避免异步问题
                this.performTabSwitch('installed');

                this.forceRefresh = false;

                console.log('🔍 Plugin management initialized');
            }

            // 绑定插件管理页面事件
            bindPluginManagementEvents() {
                // 等待DOM更新后绑定事件
                setTimeout(() => {
                    // 绑定插件标签切换事件
                    const pluginTabs = document.querySelectorAll('.plugin-tab-btn');
                    console.log('Found plugin tabs:', pluginTabs.length);

                    pluginTabs.forEach(tab => {
                        tab.addEventListener('click', (e) => {
                            const tabType = e.target.dataset.type;
                            if (tabType) {
                                console.log('Plugin tab clicked:', tabType);
                                this.showPluginTab(tabType);
                            }
                        });
                    });

                    // 绑定搜索功能 - 优化防抖和性能
                    const searchInput = document.getElementById('plugin-search');
                    if (searchInput) {
                        console.log('Binding search input events...');
                        let searchTimeout;
                        let lastSearchValue = '';

                        searchInput.addEventListener('input', (e) => {
                            const currentValue = e.target.value;
                            console.log('Search input changed:', currentValue);

                            // 如果搜索值没有变化，跳过处理
                            if (currentValue === lastSearchValue) {
                                return;
                            }

                            clearTimeout(searchTimeout);
                            searchTimeout = setTimeout(() => {
                                lastSearchValue = currentValue;
                                console.log('Executing search filter:', currentValue);
                                this.filterAvailablePlugins(currentValue);
                            }, 300); // 减少防抖时间到300ms，提高响应速度
                        });

                        // 添加键盘事件优化
                        searchInput.addEventListener('keydown', (e) => {
                            // ESC键清空搜索
                            if (e.key === 'Escape') {
                                console.log('ESC key pressed, clearing search');
                                searchInput.value = '';
                                this.filterAvailablePlugins('');
                            }
                        });

                        console.log('Search input events bound successfully');
                    } else {
                        console.warn('Search input element not found!');
                    }

                    // 绑定分类筛选
                    const categorySelect = document.getElementById('category-filter');
                    if (categorySelect) {
                        console.log('Binding category filter events...');
                        categorySelect.addEventListener('change', (e) => {
                            console.log('Category filter changed:', e.target.value);
                            this.filterPluginsByCategory(e.target.value);
                        });
                        console.log('Category filter events bound successfully');
                    } else {
                        console.warn('Category filter element not found!');
                    }
                }, 100); // 延迟100ms确保DOM已更新
            }

            // 显示插件标签页（性能优化版本）
            showPluginTab(tabType) {
                console.log(`🔍 showPluginTab called with: ${tabType}`);
                console.log(`🔍 Current tab: ${this.currentPluginTab}`);
                console.log(`🔍 Force refresh: ${this.forceRefresh}`);

                // 防止重复切换到同一标签页
                if (this.currentPluginTab === tabType && !this.forceRefresh) {
                    console.log(`🔍 Skipping tab switch - already on ${tabType}`);
                    return;
                }

                // 使用requestAnimationFrame确保UI更新的流畅性
                requestAnimationFrame(() => {
                    this.performTabSwitch(tabType);
                });
            }

            // 执行标签页切换（超级优化版本）
            performTabSwitch(tabType) {
                console.log(`🔍 performTabSwitch called with: ${tabType}`);
                console.log(`🔍 Current tab: ${this.currentPluginTab}, Force refresh: ${this.forceRefresh}`);

                // 防止重复切换（除非强制刷新）
                if (this.currentPluginTab === tabType && !this.forceRefresh) {
                    console.log(`🔍 Skipping performTabSwitch - already on ${tabType} and no force refresh`);
                    return;
                }

                console.log(`🔍 Proceeding with tab switch to: ${tabType}`);

                // 取消当前渲染队列
                this.cancelCurrentRender();

                this.currentPluginTab = tabType;
                console.log(`🔍 Set currentPluginTab to: ${tabType}`);

                // 立即更新UI状态（同步操作，快速响应）
                this.updateTabUI(tabType);

                // 使用微任务进行数据加载，优先级更高
                Promise.resolve().then(() => {
                    console.log(`🔍 About to call loadTabData for: ${tabType}`);
                    this.loadTabData(tabType);
                });
            }

            // 取消当前渲染
            cancelCurrentRender() {
                this.renderQueue = [];
                this.isRendering = false;

                // 如果有正在进行的渲染动画，取消它
                if (this.renderAnimationId) {
                    cancelAnimationFrame(this.renderAnimationId);
                    this.renderAnimationId = null;
                }
            }

            // 更新标签页UI状态
            updateTabUI(tabType) {
                // 更新标签按钮状态
                const allTabs = document.querySelectorAll('.plugin-tab-btn');
                allTabs.forEach(tab => {
                    tab.classList.remove('active');
                });

                const targetTab = document.querySelector(`[data-type="${tabType}"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }

                // 立即切换内容显示状态
                const installedContent = document.querySelector('.installed-plugins');
                const availableContent = document.querySelector('.available-plugins');
                const manualInstallContent = document.querySelector('.manual-install-plugins');

                // 立即切换内容显示（快速响应）
                if (tabType === 'installed') {
                    if (installedContent) installedContent.style.display = 'block';
                    if (availableContent) availableContent.style.display = 'none';
                    if (manualInstallContent) manualInstallContent.style.display = 'none';
                } else if (tabType === 'available') {
                    if (installedContent) installedContent.style.display = 'none';
                    if (availableContent) availableContent.style.display = 'block';
                    if (manualInstallContent) manualInstallContent.style.display = 'none';
                } else if (tabType === 'manual') {
                    if (installedContent) installedContent.style.display = 'none';
                    if (availableContent) availableContent.style.display = 'none';
                    if (manualInstallContent) manualInstallContent.style.display = 'block';
                }
            }

            // 异步加载标签页数据
            loadTabData(tabType) {
                console.log(`🔍 loadTabData called with: ${tabType}`);

                if (tabType === 'installed') {
                    console.log(`🔍 Loading installed plugins tab data...`);
                    // 确保已安装插件列表容器可见
                    const installedPluginList = document.getElementById('installed-plugin-list');
                    if (installedPluginList) {
                        installedPluginList.classList.add('show');
                        installedPluginList.style.display = 'block';
                    }

                    // 智能加载：只在需要时重新加载数据
                    if (this.needRefreshInstalledTab) {
                        this.loadInstalledPlugins();
                        this.needRefreshInstalledTab = false;
                    } else if (this.installedPlugins && this.installedPlugins.length > 0) {
                        // 如果已经有缓存数据，立即渲染并隐藏加载状态
                        console.log('Using cached installed plugins data');
                        this.renderInstalledPlugins(this.installedPlugins);
                        const loadingElement = document.getElementById('installed-loading');
                        if (loadingElement) {
                            loadingElement.style.display = 'none';
                        }
                    } else {
                        // 首次加载
                        this.loadInstalledPlugins();
                    }

                    // 预加载可用插件数据
                    this.preloadAvailablePlugins();

                } else if (tabType === 'available') {
                    // 确保可用插件列表容器可见
                    const availablePluginList = document.getElementById('available-plugin-list');
                    if (availablePluginList) {
                        availablePluginList.classList.add('show');
                        availablePluginList.style.display = 'block';
                    }

                    // 智能加载：避免重复加载
                    if (!this.availablePlugins || this.availablePlugins.length === 0) {
                        this.loadAvailablePlugins();
                    } else {
                        // 如果已经有缓存数据，立即渲染
                        console.log('Using cached available plugins data');
                        this.renderAvailablePlugins(this.availablePlugins);
                    }

                    // 预加载已安装插件数据
                    this.preloadInstalledPlugins();

                } else if (tabType === 'manual') {
                    // 手动安装页面初始化（轻量级操作）
                    this.initManualInstallPage();

                    // 预加载其他标签页数据
                    this.preloadInstalledPlugins();
                    this.preloadAvailablePlugins();
                }
            }

            // 预加载已安装插件数据
            preloadInstalledPlugins() {
                if (!this.installedPlugins && !this.isLoadingInstalled) {
                    setTimeout(() => {
                        console.log('🚀 Preloading installed plugins data...');
                        this.loadInstalledPlugins(true); // 静默加载
                    }, 300);
                }
            }

            // 预加载可用插件数据
            preloadAvailablePlugins() {
                if ((!this.availablePlugins || this.availablePlugins.length === 0) && !this.isLoadingAvailable) {
                    setTimeout(() => {
                        console.log('🚀 Preloading available plugins data...');
                        this.loadAvailablePlugins(true); // 静默加载
                    }, 500);
                }
            }

            // 加载已安装插件
            async loadInstalledPlugins(silent = false) {
                console.log(`=== loadInstalledPlugins START (silent: ${silent}) ===`);
                console.log('🔍 Current backendUrl:', this.backendUrl);
                console.log('🔍 API_BASE:', this.API_BASE);

                if (!this.backendUrl) {
                    console.error('❌ backendUrl is not set! Cannot load plugins.');
                    return;
                }

                this.isLoadingInstalled = true;

                // 只在非静默模式下显示加载状态
                const loadingElement = document.getElementById('installed-loading');
                if (loadingElement && !silent) {
                    loadingElement.style.display = 'flex';
                    console.log('Shown installed loading indicator');
                }

                try {
                    console.log('🔍 About to call fetchInstalledPlugins...');
                    const pluginData = await this.fetchInstalledPlugins();
                    console.log('🔍 fetchInstalledPlugins returned:', pluginData);
                    console.log('🔍 Plugin data length:', pluginData?.length || 0);

                    this.installedPlugins = pluginData;
                    this.pluginCacheTime = Date.now();

                    console.log('🔍 About to call renderInstalledPlugins...');
                    this.renderInstalledPlugins(pluginData);

                    // 成功加载后隐藏加载状态
                    if (loadingElement && !silent) {
                        loadingElement.style.display = 'none';
                        console.log('Hidden installed loading indicator (success)');
                    }
                } catch (error) {
                    console.error('Failed to load installed plugins:', error);

                    // 出错时也要隐藏加载状态
                    if (loadingElement && !silent) {
                        loadingElement.style.display = 'none';
                        console.log('Hidden installed loading indicator (error)');
                    }
                } finally {
                    this.isLoadingInstalled = false;
                }

                console.log('=== loadInstalledPlugins END ===');
            }

            // 获取已安装插件数据
            async fetchInstalledPlugins() {
                try {
                    console.log('🔍 fetchInstalledPlugins called');
                    console.log('🔍 backendUrl:', this.backendUrl);
                    console.log('🔍 Full URL:', `${this.backendUrl}/nodes/installed`);

                    // 添加超时控制
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => {
                        console.log('🔍 Request timeout, aborting...');
                        controller.abort();
                    }, 30000); // 30秒超时

                    console.log('🔍 Starting fetch request...');
                    const response = await fetch(`${this.backendUrl}/nodes/installed`, {
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    console.log('🔍 Response received!');
                    console.log('🔍 Response status:', response.status);
                    console.log('🔍 Response ok:', response.ok);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const result = await response.json();
                    if (result.status === 'success') {
                        return result.nodes.map(node => ({
                            name: node.name,
                            version: node.version || '未知',
                            date: node.git_date || node.date || 'N/A',
                            enabled: node.status === 'enabled',
                            url: node.repo_url || `https://github.com/search?q=${encodeURIComponent(node.name)}`,
                            hasUpdate: node.hasUpdate || false,
                            description: node.description || '无描述',
                            fileCount: node.fileCount || 0,
                            author: node.author || '未知',
                            status: node.status,
                            isLatestVersion: node.isLatestVersion === true
                        }));
                    } else {
                        throw new Error(result.message || 'Failed to fetch plugins');
                    }
                } catch (error) {
                    console.error('🔍 Error fetching installed plugins:', error);
                    console.error('🔍 Error type:', error.name);
                    console.error('🔍 Error message:', error.message);

                    if (error.name === 'AbortError') {
                        console.error('🔍 Request was aborted due to timeout');
                        throw new Error('请求超时：获取已安装插件信息超时，请检查网络连接或稍后重试');
                    }

                    throw error;
                }
            }

            // 渲染插件卡片
            renderPluginCard(plugin) {
                const safeName = this.escapeHtml(plugin.name || '').replace(/'/g, "\\'");
                const safeDisplayName = this.escapeHtml(plugin.name || '未知插件');
                const safeVersion = this.escapeHtml(plugin.version || '未知');
                const safeAuthor = this.escapeHtml(plugin.author || '未知');
                const safeDate = this.escapeHtml(plugin.date || '未知');
                const safeDescription = this.escapeHtml(plugin.description || '暂无描述');
                const isEnabled = plugin.enabled === true || plugin.status === 'enabled';
                const statusColor = isEnabled ? '#28a745' : '#dc3545';
                const statusText = isEnabled ? '✓ 已启用' : '✗ 已禁用';
                const safeUrl = plugin.url || `https://github.com/search?q=${encodeURIComponent(plugin.name || '')}`;
                const toggleButtonColor = isEnabled ? '#ffc107' : '#28a745';
                const toggleButtonText = isEnabled ? '禁用' : '启用';
                const toggleButtonIcon = isEnabled ? 'fa-pause' : 'fa-play';

                // 判断是否为最新版本（用于更新按钮颜色）
                const isLatestVersion = plugin.isLatestVersion === true;
                const updateButtonColor = isLatestVersion ? '#6c757d' : '#28a745';

                return `
                    <div data-plugin-name="${safeName}" style="background: rgba(255,255,255,0.05); padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 3px solid #00f5ff; width: 100%; box-sizing: border-box;">
                        <div style="margin-bottom: 15px;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #00f5ff; font-size: 18px; display: block; margin-bottom: 5px;">${safeDisplayName}</strong>
                                <span style="color: ${statusColor}; font-size: 13px; font-weight: bold;">${statusText}</span>
                            </div>
                            <div style="color: #ccc; font-size: 13px; margin-bottom: 8px; line-height: 1.4;">
                                <span style="margin-right: 20px;">版本: ${safeVersion}</span>
                                <span style="margin-right: 20px;">作者: ${safeAuthor}</span>
                                <span>更新: ${safeDate}</span>
                            </div>
                            <div style="color: #aaa; font-size: 12px; line-height: 1.5; margin-bottom: 15px;">
                                ${safeDescription}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <button onclick="launcherInstance.openInExternalBrowser('${safeUrl}', '插件 ${safeName} 的主页信息不可用')" style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; display: flex; align-items: center; gap: 4px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,123,255,0.3);">
                                <i class="fas fa-external-link-alt"></i> 主页
                            </button>
                            <button onclick="togglePlugin('${safeName}', ${isEnabled ? 'true' : 'false'})" style="padding: 6px 12px; background: ${toggleButtonColor}; color: ${isEnabled ? 'black' : 'white'}; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; display: flex; align-items: center; gap: 4px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(255,193,7,0.3);">
                                <i class="fas ${toggleButtonIcon}"></i> ${toggleButtonText}
                            </button>
                            <button onclick="uninstallPlugin('${safeName}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; display: flex; align-items: center; gap: 4px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(220,53,69,0.3);">
                                <i class="fas fa-trash"></i> 卸载
                            </button>
                            <button onclick="showPluginVersions('${safeName}')" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; display: flex; align-items: center; gap: 4px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(108,117,125,0.3);">
                                <i class="fas fa-code-branch"></i> 切换
                            </button>
                            <button onclick="updatePlugin('${safeName}')" style="padding: 6px 12px; background: ${updateButtonColor}; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; display: flex; align-items: center; gap: 4px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(${updateButtonColor === '#6c757d' ? '108,117,125' : '40,167,69'},0.3);">
                                <i class="fas fa-sync-alt"></i> 更新
                            </button>
                        </div>
                    </div>
                `;
            }

            // 设置插件按钮加载状态
            setPluginButtonLoading(pluginName, actionType, isLoading, options = {}) {
                try {
                    const pluginCard = document.querySelector(`[data-plugin-name="${pluginName}"]`);
                    if (!pluginCard) return;

                    const button = pluginCard.querySelector(`[data-action-type="${actionType}"], button[onclick*="${actionType}"]`);
                    if (!button) return;

                    if (isLoading) {
                        button.disabled = true;
                        button.style.opacity = '0.6';
                        const icon = button.querySelector('i');
                        if (icon) {
                            icon.className = options.loadingIcon || 'fas fa-spinner fa-spin';
                        }
                        if (options.loadingText) {
                            const textNode = Array.from(button.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
                            if (textNode) {
                                textNode.textContent = ` ${options.loadingText}`;
                            }
                        }
                    } else {
                        button.disabled = false;
                        button.style.opacity = '1';
                    }
                } catch (error) {
                    console.error('Error setting plugin button loading state:', error);
                }
            }

            // HTML转义函数，防止特殊字符破坏HTML结构
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }































































































            // 获取已安装插件数据
            async fetchInstalledPlugins() {
                try {
                    const response = await fetch(`${this.backendUrl}/nodes/installed`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const result = await response.json();
                    if (result.status === 'success') {
                        return result.nodes.map(node => ({
                            name: node.name,
                            version: node.version || '未知',
                            date: node.git_date || node.date || 'N/A',
                            enabled: node.status === 'enabled',
                            url: node.repo_url || `https://github.com/search?q=${encodeURIComponent(node.name)}`,
                            hasUpdate: node.hasUpdate || false,
                            description: node.description || '无描述',
                            fileCount: node.fileCount || 0,
                            author: node.author || '未知',
                            status: node.status,
                            isLatestVersion: node.isLatestVersion === true
                        }));
                    } else {
                        throw new Error(result.message || 'Failed to fetch plugins');
                    }
                } catch (error) {
                    console.error('Error fetching installed plugins:', error);
                    throw error;
                }
            }

            // 渲染插件卡片
            renderPluginCard(plugin) {
                const safeName = this.escapeHtml(plugin.name || '').replace(/'/g, "\\'");
                const safeDisplayName = this.escapeHtml(plugin.name || '未知插件');
                const safeVersion = this.escapeHtml(plugin.version || '未知');
                const safeAuthor = this.escapeHtml(plugin.author || '未知');
                const safeDate = this.escapeHtml(plugin.date || '未知');
                const safeDescription = this.escapeHtml(plugin.description || '暂无描述');
                const isEnabled = plugin.enabled === true || plugin.status === 'enabled';
                const statusColor = isEnabled ? '#28a745' : '#dc3545';
                const statusText = isEnabled ? '✓ 已启用' : '✗ 已禁用';
                const safeUrl = plugin.url || `https://github.com/search?q=${encodeURIComponent(plugin.name || '')}`;
                const toggleButtonColor = isEnabled ? '#ffc107' : '#28a745';
                const toggleButtonText = isEnabled ? '禁用' : '启用';
                const toggleButtonIcon = isEnabled ? 'fa-pause' : 'fa-play';

                // 判断是否为最新版本（用于更新按钮颜色）
                const isLatestVersion = plugin.isLatestVersion === true;
                const updateButtonColor = isLatestVersion ? '#6c757d' : '#28a745';

                return `
                    <div data-plugin-name="${safeName}" style="background: rgba(255,255,255,0.05); padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 3px solid #00f5ff; width: 100%; box-sizing: border-box;">
                        <div style="margin-bottom: 15px;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #00f5ff; font-size: 18px; display: block; margin-bottom: 5px;">${safeDisplayName}</strong>
                                <span style="color: ${statusColor}; font-size: 13px; font-weight: bold;">${statusText}</span>
                            </div>
                            <div style="color: #ccc; font-size: 13px; margin-bottom: 8px; line-height: 1.4;">
                                <span style="margin-right: 20px;">版本: ${safeVersion}</span>
                                <span style="margin-right: 20px;">作者: ${safeAuthor}</span>
                                <span>更新: ${safeDate}</span>
                            </div>
                            <div style="color: #aaa; font-size: 12px; line-height: 1.5; margin-bottom: 15px;">
                                ${safeDescription}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <button onclick="launcherInstance.openInExternalBrowser('${safeUrl}', '插件 ${safeName} 的主页信息不可用')" style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; display: flex; align-items: center; gap: 4px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,123,255,0.3);">
                                <i class="fas fa-external-link-alt"></i> 主页
                            </button>
                            <button onclick="togglePlugin('${safeName}', ${isEnabled ? 'true' : 'false'})" style="padding: 6px 12px; background: ${toggleButtonColor}; color: ${isEnabled ? 'black' : 'white'}; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; display: flex; align-items: center; gap: 4px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(255,193,7,0.3);">
                                <i class="fas ${toggleButtonIcon}"></i> ${toggleButtonText}
                            </button>
                            <button onclick="uninstallPlugin('${safeName}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; display: flex; align-items: center; gap: 4px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(220,53,69,0.3);">
                                <i class="fas fa-trash"></i> 卸载
                            </button>
                            <button onclick="showPluginVersions('${safeName}')" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; display: flex; align-items: center; gap: 4px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(108,117,125,0.3);">
                                <i class="fas fa-code-branch"></i> 切换
                            </button>
                            <button onclick="updatePlugin('${safeName}')" style="padding: 6px 12px; background: ${updateButtonColor}; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500; display: flex; align-items: center; gap: 4px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(${updateButtonColor === '#6c757d' ? '108,117,125' : '40,167,69'},0.3);">
                                <i class="fas fa-sync-alt"></i> 更新
                            </button>
                        </div>
                    </div>
                `;
            }

            // 设置插件按钮加载状态
            setPluginButtonLoading(pluginName, actionType, isLoading, options = {}) {
                try {
                    const pluginCard = document.querySelector(`[data-plugin-name="${pluginName}"]`);
                    if (!pluginCard) return;

                    const button = pluginCard.querySelector(`[data-action-type="${actionType}"], button[onclick*="${actionType}"]`);
                    if (!button) return;

                    if (isLoading) {
                        button.disabled = true;
                        button.style.opacity = '0.6';
                        const icon = button.querySelector('i');
                        if (icon) {
                            icon.className = options.loadingIcon || 'fas fa-spinner fa-spin';
                        }
                        if (options.loadingText) {
                            const textNode = Array.from(button.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
                            if (textNode) {
                                textNode.textContent = ` ${options.loadingText}`;
                            }
                        }
                    } else {
                        button.disabled = false;
                        button.style.opacity = '1';
                        // 恢复原始状态需要重新渲染，这里简化处理
                    }
                } catch (error) {
                    console.error('Error setting plugin button loading state:', error);
                }
            }

            // HTML转义函数，防止特殊字符破坏HTML结构
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            renderInstalledPlugins(plugins) {
                console.log('=== renderInstalledPlugins START ===');
                console.log('Plugins parameter:', plugins);
                console.log('Plugins type:', typeof plugins);
                console.log('Plugins length:', plugins?.length || 0);

                // 在插件管理页面的容器内渲染，而不是替换main-content
                const pluginListContainer = document.querySelector('#installed-plugin-list');
                console.log('Plugin list container element:', pluginListContainer);

                if (!pluginListContainer) {
                    console.error('Plugin list container not found!');
                    return;
                }

                // 应用滚动条防护设置
                pluginListContainer.style.overflow = 'visible';
                pluginListContainer.style.maxHeight = 'none';
                pluginListContainer.style.height = 'auto';

                if (!plugins || plugins.length === 0) {
                    console.log('No plugins to render, showing empty state');
                    this.renderEmptyStateInContainer(pluginListContainer);
                    return;
                }

                // 预设容器高度，避免渲染过程中的高度跳跃
                const estimatedItemHeight = 150; // 已安装插件项高度估计
                const estimatedTotalHeight = plugins.length * estimatedItemHeight;
                pluginListContainer.style.minHeight = `${estimatedTotalHeight}px`;

                // 在插件容器内生成插件列表
                console.log('Generating plugin list in container...');
                this.generatePluginListInContainer(pluginListContainer, plugins);

                // 确保插件列表容器可见
                pluginListContainer.classList.add('show');
                pluginListContainer.style.display = 'block';

                // 隐藏加载状态 - 关键修复！
                const loadingElement = document.getElementById('installed-loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                    console.log('Hidden installed loading indicator');
                } else {
                    console.warn('Installed loading element not found');
                }

                // 重置容器高度为自动
                requestAnimationFrame(() => {
                    pluginListContainer.style.minHeight = 'auto';
                });

                // 缓存渲染后的HTML内容，用于快速显示
                this.cachedPluginHTML = pluginListContainer.innerHTML;

                console.log('Plugin list container made visible with .show class');
                console.log('HTML content cached for future use');
                console.log('=== renderInstalledPlugins COMPLETE ===');
            }

            renderEmptyStateInContainer(container) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: white;">
                        <i class="fas fa-puzzle-piece" style="font-size: 48px; color: #00f5ff; margin-bottom: 20px;"></i>
                        <h3 style="color: #00f5ff;">暂无已安装插件</h3>
                        <p style="color: #ccc;">您还没有安装任何自定义节点插件</p>
                    </div>
                `;
                console.log('Empty state rendered in container');
            }

            generatePluginListInContainer(container, plugins) {
                console.log('=== generatePluginListInContainer START ===');

                try {
                    // 清空容器
                    container.innerHTML = '';

                    // 如果插件数量较少，直接渲染
                    if (plugins.length <= 50) {
                        this.renderPluginsDirectly(container, plugins);
                    } else {
                        // 插件数量较多，使用分批渲染
                        this.renderPluginsBatch(container, plugins);
                    }

                    console.log('Plugin list generated in container successfully');

                } catch (error) {
                    console.error('Error generating plugin list in container:', error);
                    container.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <h3>插件列表生成失败</h3>
                            <p>错误信息: ${error.message}</p>
                        </div>
                    `;
                }
            }

            // 直接渲染插件（适用于少量插件）
            renderPluginsDirectly(container, plugins) {
                console.log(`🔍 renderPluginsDirectly called with ${plugins.length} plugins`);

                const pluginHTML = plugins.map((plugin, index) => {
                    try {
                        console.log(`🔍 Rendering plugin ${index + 1}/${plugins.length}: ${plugin.name}`);
                        const cardHTML = this.renderPluginCard(plugin);
                        console.log(`🔍 Plugin card HTML length: ${cardHTML ? cardHTML.length : 0}`);
                        return cardHTML;
                    } catch (error) {
                        console.error(`🔍 Error rendering plugin card for ${plugin.name}:`, error);
                        return `
                            <div style="background: rgba(255,0,0,0.1); padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 3px solid #ff0000; color: #ff6666;">
                                插件 "${plugin.name || '未知'}" 渲染失败: ${error.message}
                            </div>
                        `;
                    }
                }).join('');

                console.log(`🔍 Total HTML length: ${pluginHTML.length}`);
                console.log(`🔍 Setting container innerHTML...`);
                container.innerHTML = pluginHTML;
                console.log(`🔍 Container innerHTML set successfully`);
            }

            // 超级优化的分批渲染插件
            renderPluginsBatch(container, plugins) {
                console.log(`🔍 renderPluginsBatch called with ${plugins.length} plugins`);

                const BATCH_SIZE = 8; // 减少批次大小，更频繁的让出控制权
                let currentIndex = 0;

                // 添加到渲染队列
                this.renderQueue.push({
                    container,
                    plugins,
                    currentIndex: 0,
                    batchSize: BATCH_SIZE
                });

                console.log(`🔍 Added to render queue. Queue length: ${this.renderQueue.length}`);
                console.log(`🔍 Is rendering: ${this.isRendering}`);

                // 如果没有正在渲染，开始渲染
                if (!this.isRendering) {
                    console.log(`🔍 Starting render queue processing...`);
                    this.processRenderQueue();
                } else {
                    console.log(`🔍 Already rendering, will process queue later`);
                }
            }

            // 处理渲染队列
            processRenderQueue() {
                console.log(`🔍 processRenderQueue called. Queue length: ${this.renderQueue.length}`);

                if (this.renderQueue.length === 0) {
                    console.log(`🔍 Queue is empty, stopping rendering`);
                    this.isRendering = false;
                    return;
                }

                this.isRendering = true;
                const task = this.renderQueue[0];
                console.log(`🔍 Processing task with ${task.plugins.length} plugins, currentIndex: ${task.currentIndex}`);

                const renderBatch = () => {
                    // 检查是否被取消
                    if (this.renderQueue.length === 0 || this.renderQueue[0] !== task) {
                        this.isRendering = false;
                        return;
                    }

                    const { container, plugins, batchSize } = task;
                    const endIndex = Math.min(task.currentIndex + batchSize, plugins.length);
                    const batch = plugins.slice(task.currentIndex, endIndex);

                    // 使用DocumentFragment优化DOM操作
                    const fragment = document.createDocumentFragment();

                    batch.forEach(plugin => {
                        try {
                            const div = document.createElement('div');
                            div.innerHTML = this.renderPluginCard(plugin);
                            fragment.appendChild(div.firstChild);
                        } catch (error) {
                            console.error(`Error rendering plugin card for ${plugin.name}:`, error);
                            const errorDiv = document.createElement('div');
                            errorDiv.innerHTML = `
                                <div style="background: rgba(255,0,0,0.1); padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 3px solid #ff0000; color: #ff6666;">
                                    插件 "${plugin.name || '未知'}" 渲染失败: ${error.message}
                                </div>
                            `;
                            fragment.appendChild(errorDiv.firstChild);
                        }
                    });

                    // 一次性添加到容器
                    container.appendChild(fragment);

                    task.currentIndex = endIndex;

                    // 如果还有更多插件，继续下一批
                    if (task.currentIndex < plugins.length) {
                        // 使用更短的延迟，让出控制权给其他任务
                        this.renderAnimationId = requestAnimationFrame(renderBatch);
                    } else {
                        // 当前任务完成，移除队列并处理下一个
                        this.renderQueue.shift();
                        this.processRenderQueue();
                    }
                };

                // 开始渲染第一批
                this.renderAnimationId = requestAnimationFrame(renderBatch);
            }





            generateFullPluginList(pluginManagement, plugins) {
                console.log('=== generateFullPluginList START ===');

                console.log('Starting to generate HTML for plugins...');
                try {
                    // 生成简化的插件管理界面（使用统一模板）
                    const pluginItems = plugins.map((plugin, index) => {
                        console.log(`Generating HTML for plugin ${index + 1}/${plugins.length}: ${plugin.name}`);
                        return this.renderPluginCard(plugin);
                    }).join('');

                    // 生成完整的插件管理页面
                    const fullHTML = `
                        <div style="padding: 20px; color: white; /* 移除overflow-y: auto，使用页面级别滚动条 */">
                            <div style="display: flex; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #333;">
                                <i class="fas fa-puzzle-piece" style="color: #00f5ff; font-size: 24px; margin-right: 15px;"></i>
                                <h2 style="color: #00f5ff; margin: 0; font-size: 24px;">插件管理</h2>
                                <div style="margin-left: auto; color: #ccc; font-size: 14px;">
                                    共 ${plugins.length} 个插件
                                </div>
                            </div>

                            <div style="background: rgba(0, 245, 255, 0.1); border: 1px solid #00f5ff; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h3 style="color: #00f5ff; margin: 0 0 15px 0; font-size: 18px;">
                                    <i class="fas fa-check-circle" style="margin-right: 10px;"></i>
                                    已安装插件
                                </h3>
                                <div style="/* 移除高度限制，使用页面级别滚动条 */">
                                    ${pluginItems}
                                </div>
                            </div>

                            <div style="text-align: center; color: #666; padding: 20px; border-top: 1px solid #333;">
                                <p style="margin: 0; font-size: 12px;">
                                    插件管理功能正在完善中，更多功能即将推出
                                </p>
                            </div>
                        </div>
                    `;

                    console.log('HTML generation complete, length:', fullHTML.length);
                    console.log('Setting plugin management innerHTML...');

                    pluginManagement.innerHTML = fullHTML;

                    console.log('Plugin management innerHTML set successfully');
                    console.log('Plugin management size:', pluginManagement.getBoundingClientRect());

                    console.log('=== generateFullPluginList COMPLETE ===');

                } catch (error) {
                    console.error('Error generating plugin HTML:', error);
                    console.error('Error stack:', error.stack);
                    pluginManagement.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: white;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc3545; margin-bottom: 20px;"></i>
                            <h3 style="color: #dc3545;">渲染插件列表时出错</h3>
                            <p style="color: #ccc;">错误信息: ${error.message}</p>
                            <button onclick="location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px;">
                                重新加载页面
                            </button>
                        </div>
                    `;
                }
            }

            async loadAvailablePlugins(silent = false, forceRefresh = false) {
                console.log(`=== loadAvailablePlugins START (silent: ${silent}) ===`);
                this.isLoadingAvailable = true;

                const loading = document.getElementById('available-loading');
                const pluginList = document.getElementById('available-plugin-list');

                console.log('Available loading element:', loading);
                console.log('Available plugin list element:', pluginList);

                if (!loading || !pluginList) {
                    console.error('Available plugins DOM elements not found!');
                    this.isLoadingAvailable = false;
                    return;
                }

                // 只在非静默模式下显示加载状态
                if (loading && !silent) {
                    loading.style.display = 'flex';
                }

                // 初始化进度显示（静默模式下跳过）
                if (!silent) {
                    this.updateLoadingProgress('available', 0, '正在获取插件列表...');
                }

                try {
                    console.log('Fetching available plugins from API...');
                    console.log('Backend URL:', this.backendUrl);

                    if (!silent) this.updateLoadingProgress('available', 20, '正在连接服务器...');
                    const pluginData = await this.fetchAvailablePlugins(forceRefresh);
                    console.log('Available plugins data received:', pluginData);
                    console.log('Plugin data type:', typeof pluginData);
                    console.log('Plugin data length:', Array.isArray(pluginData) ? pluginData.length : 'Not an array');

                    if (!silent) this.updateLoadingProgress('available', 50, '正在处理插件数据...');

                    this.availablePlugins = pluginData;
                    this.allAvailablePlugins = [...pluginData]; // 保存完整列表用于搜索

                    if (!silent) this.updateLoadingProgress('available', 80, '正在渲染插件列表...');
                    // 渲染可用插件列表（静默模式下不渲染UI）
                    if (!silent) {
                        this.renderAvailablePlugins(pluginData);
                    }

                    if (!silent) this.updateLoadingProgress('available', 100, '加载完成！');

                    // 延迟隐藏加载状态，让用户看到100%完成
                    if (!silent) {
                        setTimeout(() => {
                            if (loading) {
                                loading.style.display = 'none';
                            }
                        }, 300);

                        // 强制显示插件列表
                        pluginList.style.display = 'block';
                        pluginList.style.visibility = 'visible';
                        pluginList.style.opacity = '1';
                    }

                    console.log('Available plugins loaded successfully');

                    // 异步获取真实的GitHub star数（仅对前50个插件）
                    if (!silent) {
                        this.loadRealGitHubStars();
                    }

                } catch (error) {
                    console.error('Failed to load available plugins:', error);

                    // 只在非静默模式下显示错误信息
                    if (!silent) {
                        pluginList.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #ff4757; background: rgba(255,71,87,0.1); border: 2px solid #ff4757; margin: 20px; border-radius: 10px;">
                                <h3>❌ 加载可用插件失败</h3>
                                <p>无法从ComfyUI Manager获取插件列表</p>
                                <p style="font-size: 14px; opacity: 0.8;">错误信息: ${error.message}</p>
                                <button onclick="launcherInstance.loadAvailablePlugins()" style="background: #ff4757; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-top: 10px; cursor: pointer;">
                                    重试
                                </button>
                                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                                    <p style="font-size: 14px; opacity: 0.8;">
                                        💡 提示：请确保ComfyUI Manager已正确安装<br>
                                        或者手动将插件文件夹放入 custom_nodes 目录
                                    </p>
                                </div>
                            </div>
                        `;

                        // 强制显示插件列表
                        pluginList.style.display = 'block';
                        pluginList.style.visibility = 'visible';
                        pluginList.style.opacity = '1';

                        // 隐藏加载状态
                        if (loading) {
                            loading.style.display = 'none';
                        }
                    }
                } finally {
                    this.isLoadingAvailable = false;
                }

                console.log('=== loadAvailablePlugins END ===');
            }

            // 更新加载进度显示
            updateLoadingProgress(type, percentage, message) {
                const textElement = document.getElementById(`${type}-loading-text`);
                const progressFill = document.getElementById(`${type}-progress-fill`);

                if (textElement) {
                    textElement.textContent = message;
                }

                if (progressFill) {
                    progressFill.style.width = `${percentage}%`;
                }

                console.log(`Loading progress [${type}]: ${percentage}% - ${message}`);
            }

            // 辅助方法：检查插件是否已安装
            isPluginInstalled(pluginName) {
                return this.installedPlugins.some(plugin =>
                    plugin.name.toLowerCase() === pluginName.toLowerCase()
                );
            }

            async fetchAvailablePlugins(forceRefresh = false) {
                try {
                    const url = `${this.backendUrl}/nodes/available`;
                    const params = new URLSearchParams();
                    if (forceRefresh) {
                        params.append('force_refresh', 'true');
                    }
                    params.append('_t', Date.now().toString());

                    const fullUrl = `${url}?${params}`;
                    console.log('Fetching available plugins from:', fullUrl);

                    const response = await fetch(fullUrl, {
                        headers: forceRefresh ? {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        } : {}
                    });
                    console.log('Available plugins API response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('Available plugins API response data:', data);

                    if (data.status === 'success') {
                        // 转换后端数据格式为前端期望的格式
                        const plugins = data.nodes.map(node => {
                            logger.debug('Processing node:', node);
                            return {
                                name: node.title || node.name,
                                author: node.author || '未知',
                                stars: node.stars || 0, // 使用后端返回的真实star数
                                url: node.reference || node.repo_url || `https://github.com/search?q=${encodeURIComponent(node.title || node.name)}`,
                                category: node.category || 'other', // 使用后端返回的分类
                                description: node.description || "无描述",
                                installed: node.is_installed || false, // 使用后端返回的安装状态
                                tags: node.tags || [],
                                files: node.files || [],
                                install_type: node.install_type || 'git-clone'
                            };
                        });

                        console.log(`Processed ${plugins.length} available plugins`);
                        return plugins;
                    } else {
                        throw new Error(data.message || 'Failed to fetch available plugins');
                    }
                } catch (error) {
                    console.error('Error fetching available plugins:', error);
                    console.error('Error details:', {
                        message: error.message,
                        stack: error.stack,
                        url: fullUrl
                    });

                    // 如果API失败，返回示例数据作为后备
                    console.log('Falling back to example data');
                    return [
                        {
                            name: "ComfyUI-Manager",
                            author: "ltdrdata",
                            stars: 8234,
                            url: "https://github.com/ltdrdata/ComfyUI-Manager",
                            category: "utils",
                            description: "ComfyUI extension manager"
                        },
                        {
                            name: "ComfyUI-Custom-Scripts",
                            author: "pythongosssss",
                            stars: 1567,
                            url: "https://github.com/pythongosssss/ComfyUI-Custom-Scripts",
                            category: "ui",
                            description: "Custom UI scripts and enhancements"
                        }
                    ];
                }
            }



            renderAvailablePlugins(plugins) {
                console.log('=== renderAvailablePlugins START ===');
                console.log('Plugins to render:', plugins.length);

                const container = document.getElementById('available-plugin-list');
                if (!container) {
                    console.error('Available plugin list container not found!');
                    return;
                }

                if (plugins.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; padding: 60px 40px; text-align: center; color: var(--text-secondary);">
                            <div style="background: rgba(26, 26, 46, 0.3); border-radius: 20px; padding: 40px; border: 1px solid rgba(0, 245, 255, 0.1);">
                                <i class="fas fa-search" style="font-size: 64px; margin-bottom: 24px; opacity: 0.3; color: var(--neon-glow);"></i>
                                <h3 style="color: var(--text-primary); margin-bottom: 12px; font-size: 20px;">没有找到匹配的插件</h3>
                                <p style="font-size: 14px; opacity: 0.8;">尝试调整搜索条件或选择不同的分类</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                // 使用优化的渲染策略
                this.renderAvailablePluginsBatch(container, plugins);

            }

            // 分批渲染可用插件（性能优化版本）
            renderAvailablePluginsBatch(container, plugins) {
                // 清空容器
                container.innerHTML = '';

                // 设置容器样式
                container.classList.add('show');
                container.style.display = 'block';

                // 如果插件数量较少，直接渲染
                if (plugins.length <= 3000) {
                    this.renderAvailablePluginsDirectly(container, plugins);
                } else {
                    // 插件数量较多，使用分批渲染
                    this.renderAvailablePluginsBatchAsync(container, plugins);
                }

                console.log('=== renderAvailablePlugins END ===');
            }

            // 直接渲染可用插件（适用于少量插件）
            renderAvailablePluginsDirectly(container, plugins) {
                console.log(`🔍 renderAvailablePluginsDirectly called with ${plugins.length} plugins`);

                const allHTML = plugins.map((plugin, index) => {
                    if (index < 5) { // 只记录前5个插件的渲染过程
                        console.log(`🔍 Rendering available plugin ${index + 1}/${plugins.length}: ${plugin.name}`);
                    }
                    return this.generateAvailablePluginHTML(plugin);
                }).join('');

                console.log(`🔍 Total available HTML length: ${allHTML.length}`);
                console.log(`🔍 Setting available container innerHTML...`);
                container.innerHTML = allHTML;
                console.log(`🔍 Available container innerHTML set successfully`);
            }

            // 超级优化的异步分批渲染可用插件
            renderAvailablePluginsBatchAsync(container, plugins) {
                console.log(`🔍 renderAvailablePluginsBatchAsync called with ${plugins.length} plugins`);

                const BATCH_SIZE = 6; // 进一步减少批次大小

                // 添加到渲染队列
                this.renderQueue.push({
                    container,
                    plugins,
                    currentIndex: 0,
                    batchSize: BATCH_SIZE,
                    type: 'available'
                });

                console.log(`🔍 Added available plugins to render queue. Queue length: ${this.renderQueue.length}`);
                console.log(`🔍 Is rendering: ${this.isRendering}`);

                // 如果没有正在渲染，开始渲染
                if (!this.isRendering) {
                    console.log(`🔍 Starting available render queue processing...`);
                    this.processAvailableRenderQueue();
                } else {
                    console.log(`🔍 Already rendering, will process available queue later`);
                }
            }

            // 处理可用插件渲染队列
            processAvailableRenderQueue() {
                console.log(`🔍 processAvailableRenderQueue called. Queue length: ${this.renderQueue.length}`);

                if (this.renderQueue.length === 0) {
                    console.log(`🔍 Available queue is empty, stopping rendering`);
                    this.isRendering = false;
                    return;
                }

                this.isRendering = true;
                const task = this.renderQueue.find(t => t.type === 'available') || this.renderQueue[0];
                console.log(`🔍 Processing available task with ${task.plugins.length} plugins, currentIndex: ${task.currentIndex}`);

                const renderBatch = () => {
                    // 检查是否被取消
                    if (this.renderQueue.length === 0 || !this.renderQueue.includes(task)) {
                        this.isRendering = false;
                        return;
                    }

                    const { container, plugins, batchSize } = task;
                    const endIndex = Math.min(task.currentIndex + batchSize, plugins.length);
                    const batch = plugins.slice(task.currentIndex, endIndex);

                    // 使用DocumentFragment优化DOM操作
                    const fragment = document.createDocumentFragment();

                    batch.forEach(plugin => {
                        try {
                            const div = document.createElement('div');
                            div.innerHTML = this.generateAvailablePluginHTML(plugin);
                            fragment.appendChild(div.firstChild);
                        } catch (error) {
                            console.error(`Error rendering available plugin for ${plugin.name}:`, error);
                        }
                    });

                    // 一次性添加到容器
                    container.appendChild(fragment);

                    task.currentIndex = endIndex;

                    // 如果还有更多插件，继续下一批
                    if (task.currentIndex < plugins.length) {
                        this.renderAnimationId = requestAnimationFrame(renderBatch);
                    } else {
                        // 当前任务完成，移除队列
                        const index = this.renderQueue.indexOf(task);
                        if (index > -1) {
                            this.renderQueue.splice(index, 1);
                        }
                        this.processAvailableRenderQueue();
                    }
                };

                // 开始渲染第一批
                this.renderAnimationId = requestAnimationFrame(renderBatch);
            }

            // 生成单个可用插件的HTML
            generateAvailablePluginHTML(plugin) {
                // 检查插件是否已安装
                const backendInstalled = plugin.installed; // 后端检测结果
                const frontendInstalled = this.isPluginInstalled(plugin.name); // 前端检测结果

                // 优先使用后端检测结果，前端作为备用
                const isInstalled = backendInstalled || frontendInstalled;

                // 调试信息：记录安装状态检测结果
                if (plugin.name.toLowerCase().includes('test') || backendInstalled !== frontendInstalled) {
                    console.log(`🔍 Plugin ${plugin.name}: backend=${backendInstalled}, frontend=${frontendInstalled}, final=${isInstalled}`);
                }

                // 额外调试：记录最近安装的插件状态
                if (window.lastInstalledPlugin && plugin.name === window.lastInstalledPlugin) {
                    console.log(`🎯 最近安装的插件 ${plugin.name}: backend=${backendInstalled}, frontend=${frontendInstalled}, final=${isInstalled}`);
                    // 清除标记，避免重复日志
                    window.lastInstalledPlugin = null;
                }

                // 额外调试：记录最近卸载的插件状态
                if (window.lastUninstalledPlugin && plugin.name === window.lastUninstalledPlugin) {
                    console.log(`🗑️ 最近卸载的插件 ${plugin.name}: backend=${backendInstalled}, frontend=${frontendInstalled}, final=${isInstalled}`);
                    // 清除标记，避免重复日志
                    window.lastUninstalledPlugin = null;
                }

                const installButtonText = isInstalled ? '已安装' : '安装';
                const installButtonClass = isInstalled ? 'installed' : 'install';
                const installButtonDisabled = isInstalled ? 'disabled' : '';

                return `
                    <div class="available-plugin-item" data-plugin="${plugin.name}" data-category="${plugin.category}">
                        <div class="available-plugin-info">
                            <!-- 主要信息区域 -->
                            <div class="plugin-main-info">
                                <!-- 插件名称和作者 -->
                                <div class="plugin-title-line">
                                    <span class="available-plugin-name" title="${plugin.name}">${plugin.name}</span>
                                    <span class="plugin-author">@${plugin.author}</span>
                                </div>

                                <!-- 插件描述 -->
                                <div class="plugin-description" title="${plugin.description}">${plugin.description}</div>

                                <!-- 底部信息行：分类、星标、主页、安装 -->
                                <div class="plugin-bottom-line">
                                    <div class="plugin-left-info">
                                        <span class="plugin-category">${this.getCategoryDisplayName(plugin.category)}</span>
                                        <span class="plugin-stars">
                                            <i class="fas fa-star"></i> ${plugin.stars}
                                        </span>
                                    </div>
                                    <div class="plugin-right-actions">
                                        <button class="plugin-action-btn info"
                                                onclick="launcherInstance.showPluginInfo('${plugin.name}', '${plugin.url}')"
                                                title="查看插件详情">
                                            <i class="fas fa-info-circle"></i>
                                            主页
                                        </button>
                                        <button class="plugin-action-btn ${installButtonClass}"
                                                data-plugin-name="${plugin.name}"
                                                data-action-type="installAvailablePlugin"
                                                onclick="launcherInstance.installAvailablePlugin('${plugin.name}', '${plugin.url}')"
                                                ${installButtonDisabled}>
                                            <i class="fas ${isInstalled ? 'fa-check' : 'fa-download'}"></i>
                                            ${installButtonText}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 检查插件是否已安装（改进的匹配逻辑）
            isPluginInstalled(pluginName) {
                if (!this.installedPlugins || !pluginName) {
                    return false;
                }

                const searchName = pluginName.toLowerCase().trim();

                return this.installedPlugins.some(plugin => {
                    const installedName = plugin.name.toLowerCase();

                    // 精确匹配
                    if (installedName === searchName) {
                        return true;
                    }

                    // 移除常见前缀后匹配
                    const prefixes = ['comfyui-', 'comfyui_', 'comfy-', 'comfy_'];
                    for (const prefix of prefixes) {
                        if (installedName.startsWith(prefix) && searchName === installedName.substring(prefix.length)) {
                            return true;
                        }
                        if (searchName.startsWith(prefix) && installedName === searchName.substring(prefix.length)) {
                            return true;
                        }
                    }

                    // 包含匹配（双向，但要求长度足够避免误匹配）
                    if (searchName.length > 3 && installedName.length > 3) {
                        if (installedName.includes(searchName) || searchName.includes(installedName)) {
                            return true;
                        }
                    }

                    // 分隔符变体匹配
                    const normalizedInstalled = installedName.replace(/[-_\s]/g, '');
                    const normalizedSearch = searchName.replace(/[-_\s]/g, '');
                    if (normalizedInstalled === normalizedSearch) {
                        return true;
                    }

                    return false;
                });
            }

            // 获取分类显示名称
            getCategoryDisplayName(category) {
                const categoryNames = {
                    'image': '图像处理',
                    'video': '视频处理',
                    'audio': '音频处理',
                    'ai': 'AI模型',
                    '3d': '3D相关',
                    'tool': '工具类',
                    'other': '其他'
                };
                return categoryNames[category] || '其他';
            }

            // 安装可用插件
            async installAvailablePlugin(pluginName, pluginUrl) {
                try {
                    console.log('Installing available plugin:', pluginName, 'from:', pluginUrl);

                    // 设置安装按钮为加载状态
                    this.setPluginButtonLoading(pluginName, 'installAvailablePlugin', true, {
                        loadingText: '安装中'
                    });

                    // 确认安装
                    const confirmed = await this.showCustomConfirm(
                        '确认安装插件',
                        `确定要安装插件 "${pluginName}" 吗？\n\n这将从远程仓库下载并安装插件。`
                    );
                    if (!confirmed) {
                        // 取消加载状态
                        this.setPluginButtonLoading(pluginName, 'installAvailablePlugin', false);
                        return;
                    }

                    this.showNotification(`正在安装插件 ${pluginName}...`, 'info');

                    // 设置调试标记，用于追踪安装状态
                    window.lastInstalledPlugin = pluginName;

                    // 调用真实的安装API
                    const response = await fetch(`${this.backendUrl}/nodes/install`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            node_id: pluginName,
                            repo_url: pluginUrl,
                            install_type: 'git-clone'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();

                        if (result.status === 'success') {
                            // 保存当前的搜索和浏览状态
                            const currentSearchTerm = document.getElementById('plugin-search')?.value || '';
                            const currentScrollPosition = document.getElementById('available-plugin-list')?.scrollTop || 0;

                            console.log(`保存状态 - 搜索词: "${currentSearchTerm}", 滚动位置: ${currentScrollPosition}`);

                            // 清除缓存并刷新插件列表
                            this.clearAllPluginCaches();

                            // 等待一下确保安装完成
                            await new Promise(resolve => setTimeout(resolve, 1500));

                            // 重新加载已安装插件列表
                            await this.loadInstalledPlugins();

                            // 等待一下确保已安装插件列表更新完成
                            await new Promise(resolve => setTimeout(resolve, 500));

                            // 强制重新加载可用插件列表（带强制刷新）
                            await this.loadAvailablePlugins(true);

                            // 再次等待确保状态更新完成
                            await new Promise(resolve => setTimeout(resolve, 500));

                            // 额外的状态验证和同步
                            await this.ensurePluginStatusSync(pluginName);

                            // 恢复用户的搜索和浏览状态
                            await this.restorePluginBrowsingState(currentSearchTerm, currentScrollPosition, pluginName);

                            // 确保已安装插件页面也能显示新安装的插件
                            await this.syncInstalledPluginDisplay(pluginName);

                            // 检查ComfyUI运行状态
                            const comfyuiRunning = await this.checkComfyUIStatus();
                            const restartMessage = comfyuiRunning ? ' 请重启ComfyUI以使更改生效。' : '';

                            this.showNotification(`✅ 插件 ${pluginName} 安装成功！${restartMessage}`, 'success', 'plugin');

                            // 验证插件是否正确添加到已安装列表
                            const installedPlugin = this.installedPlugins?.find(p => p.name === pluginName);
                            logger.info(`📦 安装后验证 - 插件 ${pluginName} 在已安装列表中:`, !!installedPlugin);
                            logger.debug(`📊 当前已安装插件总数: ${this.installedPlugins?.length || 0}`);
                            logger.debug(`🏷️ 已设置已安装页面刷新标记: ${this.needRefreshInstalledTab}`);
                        } else {
                            this.showNotification(`❌ 安装失败：${result.message}`, 'error');
                        }
                    } else {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }

                } catch (error) {
                    console.error('Install plugin failed:', error);
                    this.showNotification(`❌ 插件安装失败: ${error.message}`, 'error');
                } finally {
                    // 无论成功还是失败，都要清除加载状态
                    this.setPluginButtonLoading(pluginName, 'installAvailablePlugin', false);
                }
            }

            // 在外部浏览器中打开URL
            async openInExternalBrowser(url, fallbackMessage = '无法打开链接') {
                if (!url || url === '#') {
                    this.showNotification(fallbackMessage, 'warning');
                    return false;
                }

                logger.info('Opening URL in external browser:', url);

                // 尝试多种方式打开浏览器
                let opened = false;

                // 方式1: 使用Electron的shell.openExternal (推荐)
                if (window.electronAPI && window.electronAPI.openExternal) {
                    try {
                        await window.electronAPI.openExternal(url);
                        opened = true;
                        logger.info('Opened using Electron shell.openExternal');
                    } catch (e) {
                        logger.warn('Failed to open with Electron shell:', e);
                    }
                }

                // 方式2: 使用window.open作为备选
                if (!opened) {
                    try {
                        const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
                        if (newWindow) {
                            opened = true;
                            logger.info('Opened using window.open');
                        }
                    } catch (e) {
                        logger.warn('Failed to open with window.open:', e);
                    }
                }

                // 方式3: 复制URL到剪贴板作为最后备选
                if (!opened && navigator.clipboard) {
                    try {
                        await navigator.clipboard.writeText(url);
                        this.showNotification('链接已复制到剪贴板，请手动在浏览器中打开', 'info');
                        opened = true;
                        logger.info('URL copied to clipboard as fallback');
                    } catch (e) {
                        logger.warn('Failed to copy to clipboard:', e);
                    }
                }

                if (!opened) {
                    this.showNotification('无法打开链接，请手动复制URL到浏览器', 'error');
                    logger.error('All methods failed to open URL:', url);
                }

                return opened;
            }

            // 显示插件详情
            async showPluginInfo(pluginName, pluginUrl) {
                logger.info('Opening plugin homepage for:', pluginName, 'URL:', pluginUrl);

                // 使用外部浏览器打开插件主页
                const success = await this.openInExternalBrowser(
                    pluginUrl,
                    `插件 ${pluginName} 的主页信息不可用`
                );

                if (success) {
                    this.showNotification(`正在浏览器中打开 ${pluginName} 主页`, 'success');
                }
            }

            // 异步加载真实的GitHub star数
            async loadRealGitHubStars() {
                if (!this.allAvailablePlugins || this.allAvailablePlugins.length === 0) {
                    return;
                }

                console.log('Starting to load real GitHub stars for top plugins...');

                // 只对前50个插件获取真实star数，避免API限制
                const topPlugins = this.allAvailablePlugins.slice(0, 50);
                let updatedCount = 0;

                for (const plugin of topPlugins) {
                    try {
                        // 提取GitHub仓库信息
                        const githubUrl = plugin.url;
                        if (!githubUrl || !githubUrl.includes('github.com')) {
                            continue;
                        }

                        // 解析仓库owner和name
                        const urlParts = githubUrl.replace('.git', '').split('/');
                        if (urlParts.length < 5) {
                            continue;
                        }

                        const owner = urlParts[urlParts.length - 2];
                        const repo = urlParts[urlParts.length - 1];

                        // 调用后端API获取star数
                        const response = await fetch(`${this.backendUrl}/nodes/github-stars/${owner}/${repo}`);
                        if (response.ok) {
                            const result = await response.json();
                            if (result.status === 'success' && result.stars > 0) {
                                // 更新插件的star数
                                plugin.stars = result.stars;
                                updatedCount++;

                                console.log(`Updated ${plugin.name}: ${result.stars} stars`);

                                // 每更新10个插件就重新渲染一次，减少频繁渲染
                                if (updatedCount % 10 === 0) {
                                    this.sortPluginsByStars(this.allAvailablePlugins);
                                    this.renderAvailablePlugins(this.availablePlugins);
                                }
                            }
                        }

                        // 小延迟避免API限制
                        await new Promise(resolve => setTimeout(resolve, 100));

                    } catch (error) {
                        console.error(`Error loading stars for ${plugin.name}:`, error);
                    }
                }

                // 最终重新排序和渲染
                if (updatedCount > 0) {
                    console.log(`Updated ${updatedCount} plugins with real GitHub stars`);
                    this.sortPluginsByStars(this.allAvailablePlugins);
                    this.renderAvailablePlugins(this.availablePlugins);
                }
            }

            // 自定义确认对话框
            showCustomConfirm(title, message) {
                return new Promise((resolve) => {
                    // 创建模态框
                    const modal = document.createElement('div');
                    modal.className = 'custom-confirm-modal';
                    modal.innerHTML = `
                        <div class="custom-confirm-content">
                            <div class="custom-confirm-header">
                                <h3>${title}</h3>
                            </div>
                            <div class="custom-confirm-body">
                                <p>${message.replace(/\n/g, '<br>')}</p>
                            </div>
                            <div class="custom-confirm-footer">
                                <button class="custom-confirm-btn cancel">取消</button>
                                <button class="custom-confirm-btn confirm">确定</button>
                            </div>
                        </div>
                    `;

                    // 添加到页面
                    document.body.appendChild(modal);

                    // 绑定事件
                    const cancelBtn = modal.querySelector('.cancel');
                    const confirmBtn = modal.querySelector('.confirm');

                    const cleanup = () => {
                        document.body.removeChild(modal);
                    };

                    cancelBtn.onclick = () => {
                        // 播放点击音效
                        if (window.audioManager) {
                            audioManager.play('click');
                        }
                        cleanup();
                        resolve(false);
                    };

                    confirmBtn.onclick = () => {
                        // 播放点击音效
                        if (window.audioManager) {
                            audioManager.play('click');
                        }
                        cleanup();
                        resolve(true);
                    };

                    // 点击背景关闭
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            cleanup();
                            resolve(false);
                        }
                    };

                    // ESC键关闭
                    const handleKeydown = (e) => {
                        if (e.key === 'Escape') {
                            cleanup();
                            resolve(false);
                            document.removeEventListener('keydown', handleKeydown);
                        }
                    };
                    document.addEventListener('keydown', handleKeydown);
                });
            }

            // 确保插件状态正确同步（解决状态更新不稳定的问题）
            async ensurePluginStatusSync(pluginName) {
                console.log(`开始同步插件状态: ${pluginName}`);

                try {
                    // 1. 强制刷新已安装插件列表
                    const response = await fetch(`${this.backendUrl}/nodes/installed?force_refresh=true&_t=${Date.now()}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'success') {
                            // 更新前端缓存
                            this.installedPlugins = data.nodes.map(node => ({
                                name: node.name,
                                version: node.version || '未知',
                                date: node.git_date || node.date || '未知',
                                enabled: node.enabled,
                                url: node.repo_url || `https://github.com/search?q=${node.name}`,
                                hasUpdate: node.hasUpdate || false
                            }));

                            console.log(`已更新已安装插件列表，共 ${this.installedPlugins.length} 个插件`);
                        }
                    }

                    // 2. 验证目标插件是否在已安装列表中
                    const isInstalled = this.isPluginInstalled(pluginName);
                    console.log(`插件 ${pluginName} 安装状态检查: ${isInstalled}`);

                    // 3. 如果检测到已安装，立即更新对应的按钮状态
                    if (isInstalled) {
                        this.updatePluginButtonStatus(pluginName, true);
                    } else {
                        // 如果仍未检测到，等待一下再重试
                        logger.debug(`插件 ${pluginName} 状态检测失败，1秒后重试...`);
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        // 重新检查
                        const retryInstalled = this.isPluginInstalled(pluginName);
                        console.log(`插件 ${pluginName} 重试检查结果: ${retryInstalled}`);

                        if (retryInstalled) {
                            this.updatePluginButtonStatus(pluginName, true);
                        }
                    }

                } catch (error) {
                    console.error('同步插件状态时出错:', error);
                }
            }

            // 更新特定插件的按钮状态
            updatePluginButtonStatus(pluginName, isInstalled) {
                try {
                    // 查找插件按钮
                    const pluginButtons = document.querySelectorAll(`button[data-plugin-name="${pluginName}"]`);

                    pluginButtons.forEach(button => {
                        if (button.dataset.actionType === 'installAvailablePlugin') {
                            if (isInstalled) {
                                // 更新为已安装状态
                                button.textContent = '已安装';
                                button.className = 'plugin-action-btn installed';
                                button.disabled = true;
                                button.style.cursor = 'not-allowed';
                                console.log(`已更新插件 ${pluginName} 按钮为已安装状态`);
                            } else {
                                // 更新为可安装状态
                                button.innerHTML = '<i class="fas fa-download"></i> 安装';
                                button.className = 'plugin-action-btn install';
                                button.disabled = false;
                                button.style.cursor = 'pointer';
                                console.log(`已更新插件 ${pluginName} 按钮为可安装状态`);
                            }
                        }
                    });
                } catch (error) {
                    console.error('更新插件按钮状态时出错:', error);
                }
            }

            // 同步卸载插件的状态（确保可用插件列表中显示为可安装状态）
            async syncUninstalledPluginStatus(pluginName) {
                console.log(`开始同步卸载插件状态: ${pluginName}`);

                try {
                    // 1. 清除插件缓存
                    this.clearAllPluginCaches();

                    // 2. 强制刷新已安装插件列表（确保后端数据同步）
                    const response = await fetch(`${this.backendUrl}/nodes/installed?force_refresh=true&_t=${Date.now()}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'success') {
                            // 更新前端缓存
                            this.installedPlugins = data.nodes.map(node => ({
                                name: node.name,
                                version: node.version || '未知',
                                date: node.git_date || node.date || '未知',
                                enabled: node.enabled,
                                url: node.repo_url || `https://github.com/search?q=${node.name}`,
                                hasUpdate: node.hasUpdate || false
                            }));

                            console.log(`卸载后更新已安装插件列表，共 ${this.installedPlugins.length} 个插件`);
                        }
                    }

                    // 3. 验证插件确实已被卸载
                    const isStillInstalled = this.isPluginInstalled(pluginName);
                    console.log(`插件 ${pluginName} 卸载后状态检查: ${isStillInstalled ? '仍已安装' : '已卸载'}`);

                    // 4. 如果确认已卸载，更新可用插件列表中的按钮状态
                    if (!isStillInstalled) {
                        this.updatePluginButtonStatus(pluginName, false);

                        // 5. 如果当前在可用插件标签页，强制重新渲染以确保状态正确
                        if (this.currentPluginTab === 'available' && this.allAvailablePlugins) {
                            console.log('当前在可用插件页面，重新渲染插件列表');

                            // 保存当前搜索状态
                            const searchInput = document.getElementById('plugin-search');
                            const currentSearchTerm = searchInput?.value || '';

                            // 重新渲染
                            this.renderAvailablePlugins(this.allAvailablePlugins);

                            // 如果有搜索词，重新应用搜索
                            if (currentSearchTerm) {
                                searchInput.value = currentSearchTerm;
                                this.filterAvailablePlugins(currentSearchTerm);
                            }
                        }

                        console.log(`✅ 插件 ${pluginName} 状态已同步为可安装`);
                    } else {
                        console.log(`⚠️ 插件 ${pluginName} 卸载后仍显示为已安装，可能需要手动检查`);
                    }

                } catch (error) {
                    console.error('同步卸载插件状态时出错:', error);
                }
            }

            // 同步已安装插件页面显示（确保新安装的插件能在已安装页面显示）
            async syncInstalledPluginDisplay(pluginName) {
                console.log(`开始同步已安装插件页面显示: ${pluginName}`);

                try {
                    // 1. 验证插件确实在已安装列表中
                    const isInstalled = this.isPluginInstalled(pluginName);
                    console.log(`插件 ${pluginName} 在已安装列表中: ${isInstalled}`);

                    if (!isInstalled) {
                        console.log(`⚠️ 插件 ${pluginName} 未在已安装列表中找到，尝试重新加载...`);

                        // 强制重新加载已安装插件数据
                        await this.loadInstalledPlugins();

                        // 再次验证
                        const retryInstalled = this.isPluginInstalled(pluginName);
                        console.log(`重新加载后插件 ${pluginName} 状态: ${retryInstalled}`);
                    }

                    // 2. 如果当前不在已安装插件页面，标记需要刷新
                    if (this.currentPluginTab !== 'installed') {
                        // 设置标记，当用户切换到已安装页面时会自动刷新
                        this.needRefreshInstalledTab = true;
                        console.log('已设置已安装页面刷新标记');
                    } else {
                        // 3. 如果当前就在已安装插件页面，立即刷新显示
                        console.log('当前在已安装插件页面，立即刷新显示');
                        this.renderInstalledPlugins(this.installedPlugins);

                        // 尝试滚动到新安装的插件
                        await this.scrollToInstalledPluginInList(pluginName);
                    }

                } catch (error) {
                    console.error('同步已安装插件页面显示时出错:', error);
                }
            }

            // 在已安装插件列表中滚动到指定插件
            async scrollToInstalledPluginInList(pluginName) {
                try {
                    // 等待DOM更新
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // 查找插件元素
                    const pluginElements = document.querySelectorAll('.installed-plugin-item');
                    let targetElement = null;

                    for (const element of pluginElements) {
                        const nameElement = element.querySelector('.plugin-name');
                        if (nameElement && nameElement.textContent.includes(pluginName)) {
                            targetElement = element;
                            break;
                        }
                    }

                    if (targetElement) {
                        // 滚动到插件位置并高亮显示
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });

                        // 添加临时高亮效果
                        targetElement.style.transition = 'all 0.3s ease';
                        targetElement.style.boxShadow = '0 0 20px rgba(0, 245, 255, 0.6)';
                        targetElement.style.transform = 'scale(1.02)';

                        // 3秒后移除高亮效果
                        setTimeout(() => {
                            targetElement.style.boxShadow = '';
                            targetElement.style.transform = '';
                        }, 3000);

                        console.log(`已在已安装列表中滚动到插件 ${pluginName} 并添加高亮效果`);
                    } else {
                        console.log(`未在已安装列表中找到插件 ${pluginName} 的DOM元素`);
                    }
                } catch (error) {
                    console.error('滚动到已安装插件位置时出错:', error);
                }
            }

            // 恢复插件浏览状态（安装完成后保持用户的搜索和浏览位置）
            async restorePluginBrowsingState(searchTerm, scrollPosition, installedPluginName) {
                console.log(`恢复浏览状态 - 搜索词: "${searchTerm}", 滚动位置: ${scrollPosition}, 已安装插件: ${installedPluginName}`);

                try {
                    // 恢复搜索框内容
                    const searchInput = document.getElementById('plugin-search');
                    if (searchInput && searchTerm) {
                        searchInput.value = searchTerm;
                        console.log(`已恢复搜索框内容: "${searchTerm}"`);
                    }

                    // 如果有搜索词，重新执行搜索过滤
                    if (searchTerm && searchTerm.trim() !== '') {
                        this.filterAvailablePlugins(searchTerm);
                        console.log(`已重新执行搜索过滤: "${searchTerm}"`);
                    }

                    // 等待DOM更新完成
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // 恢复滚动位置
                    const pluginList = document.getElementById('available-plugin-list');
                    if (pluginList && scrollPosition > 0) {
                        pluginList.scrollTop = scrollPosition;
                        console.log(`已恢复滚动位置: ${scrollPosition}`);
                    }

                    // 如果没有搜索词，尝试滚动到刚安装的插件位置
                    if ((!searchTerm || searchTerm.trim() === '') && installedPluginName) {
                        await this.scrollToInstalledPlugin(installedPluginName);
                    }

                } catch (error) {
                    console.error('恢复浏览状态时出错:', error);
                }
            }

            // 滚动到刚安装的插件位置
            async scrollToInstalledPlugin(pluginName) {
                try {
                    // 等待一下确保DOM完全渲染
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // 查找插件元素（现在应该显示为"已安装"状态）
                    const pluginElements = document.querySelectorAll('.plugin-card');
                    let targetElement = null;

                    for (const element of pluginElements) {
                        const nameElement = element.querySelector('.plugin-name');
                        if (nameElement && nameElement.textContent.includes(pluginName)) {
                            targetElement = element;
                            break;
                        }
                    }

                    if (targetElement) {
                        // 滚动到插件位置并高亮显示
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });

                        // 添加临时高亮效果
                        targetElement.style.transition = 'all 0.3s ease';
                        targetElement.style.boxShadow = '0 0 20px rgba(0, 245, 255, 0.6)';
                        targetElement.style.transform = 'scale(1.02)';

                        // 3秒后移除高亮效果
                        setTimeout(() => {
                            targetElement.style.boxShadow = '';
                            targetElement.style.transform = '';
                        }, 3000);

                        console.log(`已滚动到插件 ${pluginName} 并添加高亮效果`);
                    } else {
                        console.log(`未找到插件 ${pluginName} 的DOM元素`);
                    }
                } catch (error) {
                    console.error('滚动到插件位置时出错:', error);
                }
            }

            // 搜索和过滤功能（智能搜索+排序）
            filterAvailablePlugins(searchTerm) {
                if (!this.allAvailablePlugins) return;

                if (!searchTerm || searchTerm.trim() === '') {
                    // 如果搜索词为空，显示所有插件（按star数排序）
                    this.availablePlugins = [...this.allAvailablePlugins];
                    this.sortPluginsByStars(this.availablePlugins);
                    this.renderAvailablePlugins(this.availablePlugins);
                    return;
                }

                const searchText = searchTerm.toLowerCase().trim();

                const filtered = this.allAvailablePlugins.filter(plugin => {
                    // 插件名称匹配（支持部分匹配）
                    const nameMatch = plugin.name.toLowerCase().includes(searchText);

                    // 作者匹配
                    const authorMatch = plugin.author.toLowerCase().includes(searchText);

                    // 描述匹配
                    const descMatch = plugin.description.toLowerCase().includes(searchText);

                    // 分类匹配
                    const categoryMatch = this.getCategoryDisplayName(plugin.category).toLowerCase().includes(searchText);

                    // 支持连字符和下划线的模糊匹配
                    const normalizedPluginName = plugin.name.toLowerCase().replace(/[-_]/g, '');
                    const normalizedSearchText = searchText.replace(/[-_]/g, '');
                    const fuzzyNameMatch = normalizedPluginName.includes(normalizedSearchText);

                    return nameMatch || authorMatch || descMatch || categoryMatch || fuzzyNameMatch;
                });

                // 按相似性和star数排序
                this.sortPluginsByRelevanceAndStars(filtered, searchText);

                console.log(`Search "${searchTerm}": ${filtered.length} results from ${this.allAvailablePlugins.length} total plugins`);

                this.availablePlugins = filtered;
                this.renderAvailablePlugins(filtered);
            }

            // 计算搜索相似性得分
            calculateRelevanceScore(plugin, searchText) {
                const pluginName = plugin.name.toLowerCase();
                const searchLower = searchText.toLowerCase();

                // 精确匹配得分最高
                if (pluginName === searchLower) return 100;

                // 开头匹配得分较高
                if (pluginName.startsWith(searchLower)) return 90;

                // 包含完整搜索词
                if (pluginName.includes(searchLower)) return 80;

                // 模糊匹配（去除分隔符）
                const normalizedName = pluginName.replace(/[-_\s]/g, '');
                const normalizedSearch = searchLower.replace(/[-_\s]/g, '');
                if (normalizedName.includes(normalizedSearch)) return 70;

                // 作者匹配
                if (plugin.author.toLowerCase().includes(searchLower)) return 60;

                // 描述匹配
                if (plugin.description.toLowerCase().includes(searchLower)) return 50;

                // 分类匹配
                if (this.getCategoryDisplayName(plugin.category).toLowerCase().includes(searchLower)) return 40;

                return 0;
            }

            // 按相似性和star数排序
            sortPluginsByRelevanceAndStars(plugins, searchText) {
                plugins.sort((a, b) => {
                    const scoreA = this.calculateRelevanceScore(a, searchText);
                    const scoreB = this.calculateRelevanceScore(b, searchText);

                    // 首先按相似性排序
                    if (scoreA !== scoreB) {
                        return scoreB - scoreA;
                    }

                    // 相似性相同时按star数排序
                    if (a.stars !== b.stars) {
                        return b.stars - a.stars;
                    }

                    // star数也相同时按名称排序
                    return a.name.localeCompare(b.name);
                });
            }

            // 按star数排序
            sortPluginsByStars(plugins) {
                plugins.sort((a, b) => {
                    // 首先按star数排序（降序）
                    if (a.stars !== b.stars) {
                        return b.stars - a.stars;
                    }

                    // star数相同时按名称排序
                    return a.name.localeCompare(b.name);
                });
            }

            filterPluginsByCategory(category) {
                if (!this.allAvailablePlugins) return;

                let filtered;
                if (category) {
                    filtered = this.allAvailablePlugins.filter(plugin => plugin.category === category);
                    console.log(`Category filter "${category}": ${filtered.length} results from ${this.allAvailablePlugins.length} total plugins`);
                } else {
                    filtered = [...this.allAvailablePlugins];
                    console.log(`Showing all plugins: ${filtered.length} total`);
                }

                // 按star数排序
                this.sortPluginsByStars(filtered);

                this.availablePlugins = filtered;
                this.renderAvailablePlugins(filtered);

                // 清除搜索框
                const searchInput = document.getElementById('plugin-search');
                if (searchInput) {
                    searchInput.value = '';
                }
            }



            async updatePlugin(pluginName) {
                try {
                    console.log('Updating plugin:', pluginName);

                    // 设置更新按钮为加载状态
                    this.setPluginButtonLoading(pluginName, 'updatePlugin', true, {
                        loadingText: '更新中'
                    });

                    // 显示自定义确认对话框
                    const confirmed = await this.showCustomConfirm(
                        '确认更新插件',
                        `确定要更新插件 "${pluginName}" 到最新版本吗？\n\n这将从远程仓库拉取最新代码。`
                    );
                    if (!confirmed) {
                        // 取消加载状态
                        this.setPluginButtonLoading(pluginName, 'updatePlugin', false);
                        return;
                    }

                    this.showNotification(`正在更新插件 ${pluginName}...`, 'info');

                    // 调用真实的更新API
                    const response = await fetch(`${this.backendUrl}/api/plugins/update`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ plugin_name: pluginName })
                    });

                    if (response.ok) {
                        const result = await response.json();

                        if (result.status === 'success') {
                            // 清除特定插件的版本缓存
                            this.clearPluginVersionCache(pluginName);

                            // 标记该插件刚刚更新过，下次打开版本弹窗时需要强制刷新
                            if (!this.recentlyUpdatedPlugins) {
                                this.recentlyUpdatedPlugins = new Set();
                            }
                            this.recentlyUpdatedPlugins.add(pluginName);

                            // 等待一下确保后端缓存已清除
                            await new Promise(resolve => setTimeout(resolve, 800));

                            // 强制清除缓存并刷新插件列表
                            await this.refreshPluginListAndScrollToPlugin(pluginName);

                            const updateMessage = result.updated ?
                                `插件 ${pluginName} 更新成功！` :
                                `插件 ${pluginName} 已经是最新版本。`;

                            // 检查ComfyUI运行状态
                            const comfyuiRunning = await this.checkComfyUIStatus();
                            const restartMessage = comfyuiRunning ? ' 请重启ComfyUI以使更改生效。' : '';

                            this.showNotification(`✅ ${updateMessage}${restartMessage}`, 'success');
                        } else {
                            this.showNotification(`❌ 更新失败：${result.message}`, 'error');
                        }
                    } else {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }

                } catch (error) {
                    console.error('Update plugin failed:', error);
                    this.showNotification(`❌ 插件更新失败: ${error.message}`, 'error');
                } finally {
                    // 无论成功还是失败，都要清除加载状态
                    this.setPluginButtonLoading(pluginName, 'updatePlugin', false);
                }
            }

            async showPluginVersions(pluginName) {
                this.currentVersionSwitchPlugin = pluginName;
                logger.info('Showing versions for plugin:', pluginName);

                const modal = document.getElementById('version-switch-modal');
                logger.debug('Modal element found:', !!modal);

                if (!modal) {
                    logger.error('Version switch modal not found!');
                    // 恢复按钮状态
                    this.setPluginButtonLoading(pluginName, 'showPluginVersions', false);
                    return;
                }

                // 更新弹窗标题
                const header = modal.querySelector('.version-switch-header h3');
                if (header) {
                    header.innerHTML = `<i class="fas fa-code-branch"></i> 选择 ${pluginName} 的版本`;
                }

                // 显示加载状态
                const container = document.getElementById('version-switch-list');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #ccc;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <div>正在获取版本信息...</div>
                        </div>
                    `;
                }

                // 显示模态框
                modal.style.display = 'flex';
                modal.classList.add('show');
                console.log('Modal display and show class applied');

                try {
                    // 检查是否需要强制刷新版本信息
                    // 如果插件刚刚更新过，需要强制刷新以获取最新的当前版本信息
                    const forceRefresh = this.recentlyUpdatedPlugins && this.recentlyUpdatedPlugins.has(pluginName);
                    if (forceRefresh) {
                        console.log(`Force refreshing version info for recently updated plugin: ${pluginName}`);
                        this.recentlyUpdatedPlugins.delete(pluginName); // 清除标记
                    }

                    // 异步获取版本历史
                    const versions = await this.generatePluginVersions(pluginName, forceRefresh);

                    // 渲染版本列表
                    this.renderPluginVersions(pluginName, versions);
                } catch (error) {
                    console.error('Error loading plugin versions:', error);
                    if (container) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #dc3545;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <div>获取版本信息失败</div>
                                <div style="font-size: 12px; margin-top: 10px;">${error.message}</div>
                            </div>
                        `;
                    }
                }
            }

            renderPluginVersions(pluginName, versions) {
                const container = document.getElementById('version-switch-list');
                if (!container) {
                    console.error('Version switch list container not found!');
                    return;
                }

                // 添加调试信息
                console.log('Version data for', pluginName, ':', versions);

                const html = versions.map((version, index) => {
                    // 调试每个版本的current属性
                    console.log(`Version ${index}: ${version.commit}, current: ${version.current}`);

                    // 当前版本标签（不使用背景高亮）
                    const currentBadge = version.current ? '<span style="color: #28a745; font-size: 11px; margin-left: 8px; font-weight: bold;">✓ 当前</span>' : '';

                    // 判断是否是更新版本（在当前版本之前的版本）
                    const currentIndex = versions.findIndex(v => v.current);
                    const isNewer = currentIndex > -1 && index < currentIndex;
                    const newerBadge = isNewer ? '<span style="color: #ff6b35; font-size: 11px; margin-left: 8px;">🔥 更新</span>' : '';

                    // 最新版本标记（第一个版本且不是当前版本）
                    const isLatest = index === 0 && !version.current;
                    const latestBadge = isLatest ? '<span style="color: #00f5ff; font-size: 11px; margin-left: 8px; font-weight: bold; text-shadow: 0 0 3px rgba(0, 245, 255, 0.5);">⭐ 最新</span>' : '';

                    // 版本类型标识
                    const typeIcon = {
                        'tag': '🏷️',
                        'branch': '🌿',
                        'remote_branch': '🌐',
                        'commit': '📝'
                    };
                    const typeLabel = typeIcon[version.type] || '📝';

                    return `
                        <div class="version-item ${isNewer ? 'newer' : ''}" data-version="${version.version}" style="background: ${version.current ? 'rgba(40, 167, 69, 0.1)' : 'rgba(255,255,255,0.05)'}; border-left: ${version.current ? '3px solid #28a745' : '3px solid transparent'}; padding: 15px; margin: 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <div class="version-info" style="flex: 1;">
                                <div class="version-number" style="color: #fff; font-size: 14px; margin-bottom: 5px;">
                                    ${typeLabel} ${version.version}${currentBadge}${latestBadge}${newerBadge}
                                </div>
                                <div class="version-date" style="color: #ccc; font-size: 12px;">${version.date}</div>
                                <div class="version-description" style="color: #aaa; font-size: 11px; margin-top: 4px;">
                                    ${version.description || `${version.type}: ${version.message || '无描述'}`}
                                </div>
                            </div>
                            <button class="version-switch-btn ${version.current ? 'current' : ''} ${isNewer ? 'newer' : ''}"
                                    onclick="if(window.audioManager) audioManager.play('click'); switchPluginVersion('${version.version}')"
                                    ${version.current ? 'disabled' : ''}
                                    style="min-width: 100px; padding: 8px 16px; border: none; border-radius: 4px; cursor: ${version.current ? 'not-allowed' : 'pointer'}; background: ${version.current ? '#6c757d' : (isNewer ? '#28a745' : '#007bff')}; color: white; font-size: 12px; margin-left: 15px;">
                                <i class="fas fa-${version.current ? 'check' : (isNewer ? 'arrow-up' : 'download')}"></i>
                                ${version.current ? '当前版本' : (isNewer ? '升级' : '切换')}
                            </button>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;

                // 获取模态框并显示
                const modal = document.getElementById('version-switch-modal');
                if (modal) {
                    modal.classList.add('show');
                    modal.style.display = 'flex';
                    logger.info('Modal shown');

                    // 恢复切换按钮状态
                    this.setPluginButtonLoading(pluginName, 'showPluginVersions', false);
                } else {
                    logger.error('Modal not found!');
                    // 恢复按钮状态
                    this.setPluginButtonLoading(pluginName, 'showPluginVersions', false);
                }
            }

            async generatePluginVersions(pluginName, forceRefresh = false) {
                try {
                    // 尝试获取真实的插件版本信息
                    const realVersions = await this.fetchPluginVersions(pluginName, forceRefresh);
                    if (realVersions && realVersions.length > 0) {
                        // 直接返回后端返回的版本信息，信任后端的current字段判断
                        // 后端通过Git commit hash精确比较来确定当前版本，比前端的判断更准确
                        console.log('Using real version data from backend, current version indicators:',
                            realVersions.filter(v => v.current).map(v => v.version));

                        // 如果后端没有标记任何版本为当前版本，才设置第一个为当前版本
                        if (!realVersions.some(v => v.current)) {
                            console.warn('Backend did not mark any version as current, defaulting to first version');
                            realVersions[0].current = true;
                        }

                        return realVersions;
                    }
                } catch (error) {
                    console.warn('Failed to fetch real plugin versions, using fallback:', error);
                }

                // 如果获取真实版本失败，使用改进的模拟数据
                const fallbackVersions = this.generateFallbackVersions(pluginName);

                // 对于fallback数据，设置第一个为当前版本
                fallbackVersions.forEach(v => {
                    v.current = false;
                });
                fallbackVersions[0].current = true;

                return fallbackVersions;
            }

            async fetchPluginVersions(pluginName, forceRefresh = false) {
                try {
                    // 调用后端API获取插件的Git版本历史
                    const url = `${this.backendUrl}/plugins/${encodeURIComponent(pluginName)}/versions`;
                    const params = new URLSearchParams();
                    if (forceRefresh) {
                        params.append('force_refresh', 'true');
                    }
                    params.append('_t', Date.now().toString());

                    const response = await fetch(`${url}?${params}`, {
                        headers: forceRefresh ? {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        } : {}
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'success') {
                            // 检查versions是否存在且是数组
                            if (data.versions && Array.isArray(data.versions)) {
                                // 转换API返回的数据格式为前端需要的格式
                                return data.versions.map(v => ({
                                    version: v.version,
                                    date: v.date,
                                    current: v.current,
                                    description: `${v.type}: ${v.message} (${v.author})`,
                                    commit: v.commit,
                                    type: v.type,
                                    author: v.author,
                                    message: v.message
                                }));
                            } else {
                                console.error('API returned invalid versions data:', data);
                                return null;
                            }
                        } else {
                            console.error('API error:', data.message);
                            return null;
                        }
                    } else {
                        console.error('HTTP error:', response.status);
                        return null;
                    }
                } catch (error) {
                    console.error('Error fetching plugin versions:', error);
                    return null;
                }
            }

            generateFallbackVersions(pluginName) {
                // 改进的模拟数据，更接近真实情况
                const today = new Date();
                const formatDate = (daysAgo) => {
                    const date = new Date(today);
                    date.setDate(date.getDate() - daysAgo);
                    return date.toISOString().split('T')[0];
                };

                // 为不同插件生成更真实的版本号
                if (pluginName.includes('comfyui-manager')) {
                    return [
                        { version: "main", date: formatDate(0), current: false, description: "主分支 (最新开发版)" },
                        { version: "v0.51.0", date: formatDate(7), current: false, description: "稳定版本" },
                        { version: "v0.50.2", date: formatDate(14), current: false, description: "修复版本" },
                        { version: "v0.50.0", date: formatDate(21), current: false, description: "重大更新" },
                        { version: "v0.49.5", date: formatDate(35), current: false, description: "功能增强" }
                    ];
                } else if (pluginName.includes('Easy-Use')) {
                    return [
                        { version: "main", date: formatDate(0), current: false, description: "主分支 (最新开发版)" },
                        { version: "v3.2.1", date: formatDate(5), current: false, description: "稳定版本" },
                        { version: "v3.2.0", date: formatDate(12), current: false, description: "新功能" },
                        { version: "v3.1.8", date: formatDate(20), current: false, description: "优化版本" },
                        { version: "v3.1.5", date: formatDate(28), current: false, description: "修复版本" }
                    ];
                } else {
                    return [
                        { version: "main", date: formatDate(0), current: false, description: "主分支 (最新开发版)" },
                        { version: "latest-stable", date: formatDate(3), current: false, description: "最新稳定版" },
                        { version: "v1.0.0", date: formatDate(10), current: false, description: "正式版本" },
                        { version: "beta", date: formatDate(15), current: false, description: "测试版本" },
                        { version: "legacy", date: formatDate(30), current: false, description: "历史版本" }
                    ];
                }
            }

            getCurrentPluginVersion(pluginName) {
                // 初始化版本状态存储
                if (!this.pluginVersionStates) {
                    this.pluginVersionStates = {};
                }

                // 如果有存储的版本状态，返回它
                if (this.pluginVersionStates[pluginName]) {
                    return this.pluginVersionStates[pluginName];
                }

                // 否则返回默认的当前版本（第一个版本）
                if (pluginName.includes('comfyui-manager')) {
                    return "latest";
                } else if (pluginName.includes('Easy-Use')) {
                    return "latest";
                } else {
                    return "latest";
                }
            }

            async refreshPluginList() {
                try {
                    console.log('Refreshing plugin list...');

                    // 保存当前滚动位置
                    const mainContent = document.querySelector('.main-content');
                    const scrollTop = mainContent ? mainContent.scrollTop : 0;
                    console.log('Saving scroll position:', scrollTop);

                    // 重新获取插件列表
                    const response = await fetch(`${this.backendUrl}/nodes/installed`);
                    if (response.ok) {
                        const data = await response.json();

                        // 处理插件数据，确保状态格式正确
                        const plugins = (data.nodes || []).map(plugin => ({
                            ...plugin,
                            enabled: plugin.status === 'enabled' // 统一转换为布尔值
                        }));

                        // 更新插件数据
                        this.installedPlugins = plugins;

                        // 重新渲染插件列表
                        this.renderInstalledPlugins(this.installedPlugins);

                        // 恢复滚动位置
                        setTimeout(() => {
                            if (mainContent) {
                                mainContent.scrollTop = scrollTop;
                                console.log('Restored scroll position:', scrollTop);
                            }
                        }, 100); // 稍微延迟以确保DOM更新完成

                        console.log('Plugin list refreshed successfully, plugins:', plugins.length);
                        console.log('Plugin statuses:', plugins.map(p => ({ name: p.name, enabled: p.enabled, status: p.status })));
                    } else {
                        console.error('Failed to refresh plugin list:', response.status);
                    }
                } catch (error) {
                    console.error('Error refreshing plugin list:', error);
                }
            }

            // 彻底清除所有插件相关缓存
            clearAllPluginCaches() {
                console.log('Clearing all plugin caches...');

                // 清除前端缓存
                if (this.cache) {
                    const pluginCacheKeys = [
                        'installed_plugins',
                        'plugin_list',
                        'nodes_installed',
                        'plugin_data'
                    ];

                    pluginCacheKeys.forEach(key => {
                        if (this.cache.has(key)) {
                            this.cache.delete(key);
                            console.log(`Cleared cache: ${key}`);
                        }
                    });
                }

                // 清除实例变量缓存
                this.installedPlugins = null;
                this.pluginListCache = null;
                this.lastPluginUpdate = 0;
                this.pluginCacheTime = 0; // 强制重新获取插件数据

                console.log('All plugin caches cleared');
            }

            // 清除特定插件的版本缓存
            clearPluginVersionCache(pluginName) {
                console.log(`Clearing version cache for plugin: ${pluginName}`);

                // 清除版本状态缓存
                if (this.pluginVersionStates && this.pluginVersionStates[pluginName]) {
                    delete this.pluginVersionStates[pluginName];
                }

                // 清除可能的版本数据缓存
                if (this.cache) {
                    const versionCacheKey = `plugin_versions_${pluginName}`;
                    if (this.cache.has(versionCacheKey)) {
                        this.cache.delete(versionCacheKey);
                        console.log(`Cleared version cache: ${versionCacheKey}`);
                    }
                }

                console.log(`Version cache cleared for plugin: ${pluginName}`);
            }

            async refreshPluginListAndScrollToPlugin(pluginName) {
                try {
                    console.log('Refreshing plugin list and scrolling to plugin:', pluginName);

                    // 彻底清除所有相关缓存
                    this.clearAllPluginCaches();

                    // 强制后端重新扫描插件（添加强制刷新参数）
                    const response = await fetch(`${this.backendUrl}/nodes/installed?force_refresh=true&_t=${Date.now()}`, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // 处理插件数据，确保状态格式正确和版本信息映射
                        const plugins = (data.nodes || []).map(plugin => ({
                            name: plugin.name,
                            version: plugin.version || '未知',
                            date: plugin.git_date || plugin.date || 'N/A',
                            enabled: plugin.status === 'enabled',
                            url: plugin.repo_url || `https://github.com/search?q=${encodeURIComponent(plugin.name)}`,
                            hasUpdate: plugin.hasUpdate || false,
                            description: plugin.description || '无描述',
                            fileCount: plugin.fileCount || 0,
                            author: plugin.author || '未知',
                            status: plugin.status,
                            isLatestVersion: plugin.isLatestVersion !== false // 默认认为是最新版本
                        }));

                        // 更新插件数据
                        this.installedPlugins = plugins;

                        // 只更新插件列表部分，而不是整个页面
                        await this.updatePluginListOnly(plugins);

                        // 滚动到指定插件
                        setTimeout(() => {
                            console.log('About to scroll to plugin:', pluginName);
                            this.scrollToPlugin(pluginName);
                        }, 300); // 稍微延迟以确保DOM更新完成

                        console.log('Plugin list refreshed and scrolled to plugin successfully');
                    } else {
                        console.error('Failed to refresh plugin list:', response.status);
                    }
                } catch (error) {
                    console.error('Error refreshing plugin list:', error);
                }
            }

            async updatePluginListOnly(plugins) {
                try {
                    // 查找插件列表容器
                    const pluginListContainer = document.querySelector('#plugin-list-container');
                    if (!pluginListContainer) {
                        console.error('Plugin list container not found, falling back to full render');
                        this.renderInstalledPlugins(plugins);
                        return;
                    }

                    // 生成插件列表HTML（使用统一模板）
                    const pluginHTML = plugins.map(plugin => {
                        return this.renderPluginCard(plugin);
                    }).join('');

                    // 只更新插件列表部分
                    pluginListContainer.innerHTML = pluginHTML;
                    console.log('Plugin list container updated without affecting scroll position');

                } catch (error) {
                    console.error('Error updating plugin list only:', error);
                    // 如果出错，回退到完整渲染
                    this.renderInstalledPlugins(plugins);
                }
            }

            scrollToPlugin(pluginName) {
                try {
                    console.log('Scrolling to plugin:', pluginName);

                    // 查找插件元素
                    const mainContent = document.querySelector('.main-content');
                    if (!mainContent) {
                        console.error('Main content not found');
                        return;
                    }

                    // 查找包含插件名称的元素 - 使用更广泛的搜索
                    let targetElement = null;

                    // 方法1：通过插件名称查找
                    const allElements = mainContent.querySelectorAll('*');
                    for (const element of allElements) {
                        if (element.textContent && element.textContent.includes(pluginName)) {
                            // 找到包含插件名称的元素，向上查找插件容器
                            const container = element.closest('div[style*="background: rgba(255,255,255,0.05)"]') ||
                                            element.closest('div[style*="background:rgba(255,255,255,0.05)"]') ||
                                            element.closest('.plugin-item') ||
                                            element.closest('div[style*="border-left"]');
                            if (container) {
                                targetElement = container;
                                break;
                            }
                        }
                    }

                    // 方法2：如果没找到，尝试通过data属性查找
                    if (!targetElement) {
                        targetElement = mainContent.querySelector(`[data-plugin-name="${pluginName}"]`);
                    }

                    if (targetElement) {
                        console.log('Found target element:', targetElement);

                        // 计算滚动位置，让插件显示在视窗中央
                        const containerRect = mainContent.getBoundingClientRect();
                        const elementRect = targetElement.getBoundingClientRect();
                        const scrollTop = mainContent.scrollTop + elementRect.top - containerRect.top - (containerRect.height / 2) + (elementRect.height / 2);

                        // 平滑滚动到目标位置
                        const targetScrollTop = Math.max(0, scrollTop);
                        console.log('Scrolling to position:', targetScrollTop);

                        mainContent.scrollTo({
                            top: targetScrollTop,
                            behavior: 'smooth'
                        });

                        // 确保滚动完成后再应用高亮效果
                        setTimeout(() => {
                            console.log('Current scroll position after scroll:', mainContent.scrollTop);
                        }, 800);

                        // 添加高亮效果
                        const originalStyle = {
                            transition: targetElement.style.transition || '',
                            boxShadow: targetElement.style.boxShadow || '',
                            border: targetElement.style.border || '',
                            backgroundColor: targetElement.style.backgroundColor || '',
                            transform: targetElement.style.transform || ''
                        };

                        // 应用高亮效果
                        targetElement.style.transition = 'all 0.5s ease';
                        targetElement.style.boxShadow = '0 0 30px rgba(0, 245, 255, 0.8), inset 0 0 20px rgba(0, 245, 255, 0.2)';
                        targetElement.style.border = '2px solid #00f5ff';
                        targetElement.style.backgroundColor = 'rgba(0, 245, 255, 0.15)';
                        targetElement.style.transform = 'scale(1.02)';

                        console.log('Applied highlight effect to plugin:', pluginName);

                        // 3秒后移除高亮效果
                        setTimeout(() => {
                            if (targetElement) {
                                targetElement.style.transition = originalStyle.transition;
                                targetElement.style.boxShadow = originalStyle.boxShadow;
                                targetElement.style.border = originalStyle.border;
                                targetElement.style.backgroundColor = originalStyle.backgroundColor;
                                targetElement.style.transform = originalStyle.transform;
                                console.log('Removed highlight effect from plugin:', pluginName);
                            }
                        }, 3000);

                        console.log('Scrolled to plugin successfully with highlight');
                    } else {
                        console.warn('Plugin element not found:', pluginName);
                        console.log('Available elements in main content:', mainContent.children.length);

                        // 调试：列出所有可能的插件元素
                        const possibleElements = mainContent.querySelectorAll('div[style*="background"]');
                        console.log('Possible plugin elements:', possibleElements.length);
                        possibleElements.forEach((el, index) => {
                            console.log(`Element ${index}:`, el.textContent?.substring(0, 50));
                        });
                    }
                } catch (error) {
                    console.error('Error scrolling to plugin:', error);
                }
            }

            async checkComfyUIStatus() {
                try {
                    const response = await fetch(`${this.backendUrl}/comfyui/status`);
                    if (response.ok) {
                        const data = await response.json();
                        return data.status === 'running';
                    }
                } catch (error) {
                    console.error('Error checking ComfyUI status:', error);
                }
                return false;
            }

            // 测试函数 - 可以在控制台调用
            testScrollToPlugin(pluginName) {
                console.log('Testing scroll to plugin:', pluginName);
                this.scrollToPlugin(pluginName);
            }

            async switchPluginVersion(version) {
                try {
                    console.log(`Switching plugin ${this.currentVersionSwitchPlugin} to version:`, version);

                    // 获取当前版本
                    const currentVersion = this.getCurrentPluginVersion(this.currentVersionSwitchPlugin);

                    // 如果选择的是当前版本，不需要切换
                    if (version === currentVersion) {
                        alert(`${this.currentVersionSwitchPlugin} 已经是版本 ${version}，无需切换。`);
                        return;
                    }

                    // 直接切换，无需确认

                    // 显示切换进度
                    const container = document.getElementById('version-switch-list');
                    if (container) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #00f5ff;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <div>正在切换版本...</div>
                                <div style="font-size: 12px; margin-top: 10px; color: #ccc;">
                                    ${this.currentVersionSwitchPlugin}: ${currentVersion} → ${version}
                                </div>
                            </div>
                        `;
                    }

                    try {
                        // 调用真实的版本切换API
                        const response = await fetch(`${this.backendUrl}/plugins/${encodeURIComponent(this.currentVersionSwitchPlugin)}/switch-version`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ version: version })
                        });

                        if (response.ok) {
                            const result = await response.json();

                            if (result.status === 'success') {
                                // 更新插件的当前版本状态
                                if (!this.pluginVersionStates) {
                                    this.pluginVersionStates = {};
                                }
                                this.pluginVersionStates[this.currentVersionSwitchPlugin] = version;

                                // 重新生成版本列表以反映新的当前版本
                                const versions = await this.generatePluginVersions(this.currentVersionSwitchPlugin);

                                // 重新渲染版本列表
                                this.renderPluginVersions(this.currentVersionSwitchPlugin, versions);

                                // 关闭版本切换弹窗
                                const modal = document.getElementById('version-switch-modal');
                                if (modal) {
                                    modal.classList.remove('show');
                                    modal.style.display = 'none';
                                }

                                // 等待一下确保后端缓存已清除
                                await new Promise(resolve => setTimeout(resolve, 800));

                                // 强制刷新插件列表以显示最新版本信息
                                await this.refreshPluginListAndScrollToPlugin(this.currentVersionSwitchPlugin);

                                // 延迟显示成功消息，确保滚动和高亮效果先执行
                                setTimeout(async () => {
                                    // 检查ComfyUI运行状态并显示简化的成功消息
                                    const comfyuiRunning = await this.checkComfyUIStatus();
                                    const restartMessage = comfyuiRunning ? ' 请重启ComfyUI以使更改生效。' : '';
                                    this.showNotification(`✅ 版本切换成功！${restartMessage}`, 'success', 'version');
                                }, 1000); // 延长到1秒，确保滚动动画完成

                            } else if (result.status === 'warning') {
                                // 处理警告（如有未提交的更改）- 自动强制切换
                                {
                                    // 用户确认强制切换，重新调用API并添加force参数
                                    const forceResponse = await fetch(`${this.backendUrl}/plugins/${encodeURIComponent(this.currentVersionSwitchPlugin)}/switch-version`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({ version: version, force: true })
                                    });

                                    if (forceResponse.ok) {
                                        const forceResult = await forceResponse.json();
                                        if (forceResult.status === 'success') {
                                            // 更新状态并重新渲染
                                            if (!this.pluginVersionStates) {
                                                this.pluginVersionStates = {};
                                            }
                                            this.pluginVersionStates[this.currentVersionSwitchPlugin] = version;
                                            const versions = await this.generatePluginVersions(this.currentVersionSwitchPlugin);
                                            this.renderPluginVersions(this.currentVersionSwitchPlugin, versions);

                                            // 关闭版本切换弹窗
                                            const modal = document.getElementById('version-switch-modal');
                                            if (modal) {
                                                modal.classList.remove('show');
                                                modal.style.display = 'none';
                                            }

                                            // 等待一下确保后端缓存已清除
                                            await new Promise(resolve => setTimeout(resolve, 800));

                                            // 强制刷新插件列表并保持当前插件的可见性
                                            await this.refreshPluginListAndScrollToPlugin(this.currentVersionSwitchPlugin);

                                            // 延迟显示成功消息，确保滚动和高亮效果先执行
                                            setTimeout(async () => {
                                                // 检查ComfyUI运行状态并显示简化的成功消息
                                                const comfyuiRunning = await this.checkComfyUIStatus();
                                                const restartMessage = comfyuiRunning ? ' 请重启ComfyUI以使更改生效。' : '';
                                                this.showNotification(`✅ 版本切换成功！${restartMessage}`, 'success', 'version');
                                            }, 1000);
                                        } else {
                                            alert(`❌ 强制切换失败：${forceResult.message}`);
                                        }
                                    }
                                }
                            } else {
                                // 处理错误
                                alert(`❌ 切换失败：${result.message}`);
                            }

                        } else {
                            throw new Error(`HTTP错误: ${response.status}`);
                        }

                    } catch (apiError) {
                        console.error('API call failed:', apiError);
                        alert(`❌ 版本切换失败：${apiError.message}\n\n可能的原因：\n• 网络连接问题\n• 后端服务异常\n• 插件不是Git仓库\n• Git操作权限不足\n\n请检查控制台日志获取详细信息。`);
                    }

                } catch (error) {
                    console.error('Switch plugin version failed:', error);
                    alert(`版本切换失败: ${error.message}`);

                    // 恢复版本列表显示
                    try {
                        const versions = await this.generatePluginVersions(this.currentVersionSwitchPlugin);
                        this.renderPluginVersions(this.currentVersionSwitchPlugin, versions);
                    } catch (restoreError) {
                        console.error('Failed to restore version list:', restoreError);
                    }
                }
            }

            async uninstallPlugin(pluginName) {
                // 设置卸载按钮为加载状态
                this.setPluginButtonLoading(pluginName, 'uninstallPlugin', true, {
                    loadingText: '卸载中'
                });

                try {
                    // 显示自定义确认对话框
                    const confirmed = await this.showCustomConfirm(
                    '确认卸载插件',
                    `确定要卸载插件 "${pluginName}" 吗？\n\n⚠️ 警告：此操作将永久删除插件文件，无法撤销！\n建议在卸载前备份重要数据。`
                );

                    if (!confirmed) {
                        // 取消加载状态
                        this.setPluginButtonLoading(pluginName, 'uninstallPlugin', false);
                        return;
                    }
                        console.log('Uninstalling plugin:', pluginName);
                        this.showNotification(`正在卸载插件 ${pluginName}...`, 'info');

                        // 设置调试标记，用于追踪卸载状态
                        window.lastUninstalledPlugin = pluginName;

                        // 调用真实的卸载API
                        const response = await fetch(`${this.backendUrl}/nodes/uninstall`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                node_name: pluginName,
                                create_backup: true  // 创建备份
                            })
                        });

                        const result = await response.json();

                        if (result.status === 'success') {
                            // 从列表中移除插件
                            this.installedPlugins = this.installedPlugins.filter(p => p.name !== pluginName);
                            this.renderInstalledPlugins(this.installedPlugins);

                            // 同步更新可用插件列表中的状态
                            await this.syncUninstalledPluginStatus(pluginName);

                            this.showNotification(`插件 ${pluginName} 卸载成功`, 'success', 'plugin');
                        } else {
                            throw new Error(result.message || '卸载失败');
                        }

                } catch (error) {
                    console.error('Uninstall plugin failed:', error);
                    this.showNotification(`插件卸载失败: ${error.message}`, 'error');
                } finally {
                    // 无论成功还是失败，都要清除加载状态
                    this.setPluginButtonLoading(pluginName, 'uninstallPlugin', false);
                }
            }

            async togglePlugin(pluginName, currentEnabled) {
                try {
                    console.log('Toggling plugin:', pluginName, 'current enabled:', currentEnabled);

                    const action = currentEnabled ? '禁用' : '启用';

                    // 设置切换按钮为加载状态
                    this.setPluginButtonLoading(pluginName, 'togglePlugin', true, {
                        loadingText: `${action}中`
                    });

                    // 显示自定义确认对话框
                    const confirmed = await this.showCustomConfirm(
                        `确认${action}插件`,
                        `确定要${action}插件 "${pluginName}" 吗？\n\n${action}后需要重启ComfyUI才能生效。`
                    );

                    if (!confirmed) {
                        // 取消加载状态
                        this.setPluginButtonLoading(pluginName, 'togglePlugin', false);
                        return;
                    }

                    this.showNotification(`正在${action}插件 ${pluginName}...`, 'info');

                    // 调用真实的切换API
                    const response = await fetch(`${this.backendUrl}/nodes/toggle`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            node_name: pluginName,
                            enable: !currentEnabled  // 切换状态
                        })
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        // 更新插件状态（同时更新enabled和status字段）
                        const plugin = this.installedPlugins.find(p => p.name === pluginName);
                        if (plugin) {
                            const newEnabledState = !currentEnabled;
                            plugin.enabled = newEnabledState;
                            plugin.status = newEnabledState ? 'enabled' : 'disabled';

                            console.log(`Plugin ${pluginName} state updated:`, {
                                enabled: plugin.enabled,
                                status: plugin.status
                            });
                        }

                        // 清除HTML缓存并重新渲染插件列表
                        this.cachedPluginHTML = null;
                        this.renderInstalledPlugins(this.installedPlugins);

                        this.showNotification(`插件 ${pluginName} ${action}成功`, 'success', 'plugin');
                    } else {
                        throw new Error(result.message || `${action}失败`);
                    }

                } catch (error) {
                    console.error('Toggle plugin failed:', error);
                    this.showNotification(`插件状态切换失败: ${error.message}`, 'error');
                } finally {
                    // 无论成功还是失败，都要清除加载状态
                    this.setPluginButtonLoading(pluginName, 'togglePlugin', false);
                }
            }

            async installPlugin(pluginName, pluginUrl) {
                try {
                    console.log('Installing plugin:', pluginName, 'from:', pluginUrl);
                    this.showNotification(`正在安装插件 ${pluginName}...`, 'info');

                    // 模拟安装过程
                    await new Promise(resolve => setTimeout(resolve, 3000));

                    // 添加到已安装列表
                    const newPlugin = {
                        name: pluginName,
                        version: "1.0.0",
                        date: new Date().toISOString().split('T')[0],
                        enabled: true,
                        url: pluginUrl,
                        hasUpdate: false
                    };

                    this.installedPlugins.push(newPlugin);

                    // 如果当前在已安装标签页，刷新列表
                    if (this.currentPluginTab === 'installed') {
                        this.renderInstalledPlugins(this.installedPlugins);
                    }

                    this.showNotification(`插件 ${pluginName} 安装成功`, 'success', 'plugin');

                } catch (error) {
                    console.error('Install plugin failed:', error);
                    this.showNotification(`插件安装失败: ${error.message}`, 'error');
                }
            }



            filterPluginsByCategory(category) {
                if (!this.availablePlugins.length) return;

                const filtered = category ?
                    this.availablePlugins.filter(plugin => plugin.category === category) :
                    this.availablePlugins;

                this.renderAvailablePlugins(filtered);
            }

            // 环境信息检测方法
            async detectEnvironmentInfo() {
                try {
                    // 检测Python环境
                    await this.detectPythonInfo();
                    // 检测CUDA环境
                    await this.detectCudaInfo();
                    // 检测PyTorch环境
                    await this.detectPytorchInfo();
                    // 检测依赖状态
                    await this.detectDependencies();
                } catch (error) {
                    console.error('Environment detection failed:', error);
                }
            }

            async detectPythonInfo() {
                try {
                    const response = await fetch(`${this.backendUrl}/system/python-info`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Python info received:', data);

                        // 更新Python版本
                        const versionElement = document.getElementById('python-version');
                        if (versionElement) {
                            versionElement.textContent = data.version || '未检测到';
                        }

                        // 更新Python路径
                        const pathElement = document.getElementById('python-path');
                        if (pathElement) {
                            pathElement.textContent = data.path || '未知';
                        }

                        // 更新虚拟环境状态
                        const venvElement = document.getElementById('venv-status');
                        if (venvElement) {
                            const venvStatus = data.venv ? '已激活' : '未激活';
                            venvElement.textContent = venvStatus;
                            venvElement.style.color = data.venv ? '#00c864' : '#ff6b6b';
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('Failed to detect Python info:', error);
                    document.getElementById('python-version').textContent = '检测失败';
                    document.getElementById('python-path').textContent = '检测失败';
                    document.getElementById('venv-status').textContent = '检测失败';
                }
            }

            async detectCudaInfo() {
                try {
                    const response = await fetch(`${this.backendUrl}/system/cuda-info`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('CUDA info received:', data);

                        // 更新CUDA版本
                        const cudaElement = document.getElementById('cuda-version');
                        if (cudaElement) {
                            const cudaVersion = data.cuda_version || data.version || '未安装';
                            cudaElement.textContent = cudaVersion;
                            cudaElement.style.color = (cudaVersion !== '未安装' && cudaVersion !== '检测失败') ? '#00c864' : '#ff6b6b';
                        }

                        // 更新GPU信息
                        const gpuElement = document.getElementById('gpu-info');
                        if (gpuElement) {
                            const gpuInfo = data.gpu_name || data.name || '未检测到GPU';
                            gpuElement.textContent = gpuInfo;
                        }

                        // 更新GPU内存
                        const memoryElement = document.getElementById('gpu-memory');
                        if (memoryElement) {
                            let memoryInfo = '未知';
                            if (data.memory) {
                                if (typeof data.memory === 'string') {
                                    memoryInfo = data.memory;
                                } else {
                                    memoryInfo = `${Math.round(data.memory / 1024 / 1024)} MB`;
                                }
                            } else if (data.total_memory) {
                                memoryInfo = `${Math.round(data.total_memory / 1024 / 1024)} MB`;
                            }
                            memoryElement.textContent = memoryInfo;
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('Failed to detect CUDA info:', error);
                    document.getElementById('cuda-version').textContent = '检测失败';
                    document.getElementById('gpu-info').textContent = '检测失败';
                    document.getElementById('gpu-memory').textContent = '检测失败';
                }
            }

            async detectPytorchInfo() {
                try {
                    const response = await fetch(`${this.backendUrl}/system/pytorch-info`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('PyTorch info received:', data);

                        // 更新PyTorch版本
                        const versionElement = document.getElementById('pytorch-version');
                        if (versionElement) {
                            const version = data.version || '未安装';
                            versionElement.textContent = version;
                            versionElement.style.color = (version !== '未安装' && version !== '检测失败') ? '#00c864' : '#ff6b6b';
                        }

                        // 更新CUDA支持状态
                        const cudaSupportElement = document.getElementById('pytorch-cuda');
                        if (cudaSupportElement) {
                            const cudaAvailable = data.cuda_available || data.cuda_support;
                            const supportText = cudaAvailable ? '支持' : '不支持';
                            cudaSupportElement.textContent = supportText;
                            cudaSupportElement.style.color = cudaAvailable ? '#00c864' : '#ff6b6b';
                        }

                        // 更新设备信息
                        const deviceElement = document.getElementById('pytorch-device');
                        if (deviceElement) {
                            const device = data.device || '未知';
                            deviceElement.textContent = device;
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('Failed to detect PyTorch info:', error);
                    document.getElementById('pytorch-version').textContent = '检测失败';
                    document.getElementById('pytorch-cuda').textContent = '检测失败';
                    document.getElementById('pytorch-device').textContent = '检测失败';
                }
            }

            async detectDependencies() {
                try {
                    const response = await fetch(`${this.backendUrl}/system/dependencies`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Dependencies info received:', data);

                        // 更新核心依赖状态
                        const coreElement = document.getElementById('core-deps');
                        if (coreElement) {
                            const coreStatus = data.core_status || data.core || '检测失败';
                            coreElement.textContent = coreStatus;
                            coreElement.style.color = (coreStatus === '完整' || coreStatus === 'ok') ? '#00c864' : '#ff6b6b';
                        }

                        // 更新可选依赖状态
                        const optionalElement = document.getElementById('optional-deps');
                        if (optionalElement) {
                            const optionalStatus = data.optional_status || data.optional || '检测失败';
                            optionalElement.textContent = optionalStatus;
                            optionalElement.style.color = (optionalStatus === '完整' || optionalStatus === 'ok') ? '#00c864' : '#ff6b6b';
                        }

                        // 更新整体环境状态
                        const envElement = document.getElementById('env-status');
                        if (envElement) {
                            const envStatus = data.overall_status || data.status || '检测失败';
                            envElement.textContent = envStatus;
                            envElement.style.color = (envStatus === '完整' || envStatus === 'ok') ? '#00c864' : '#ff6b6b';
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('Failed to detect dependencies:', error);
                    document.getElementById('core-deps').textContent = '检测失败';
                    document.getElementById('optional-deps').textContent = '检测失败';
                    document.getElementById('env-status').textContent = '检测失败';
                }
            }

            // 检测环境信息
            async detectEnvironmentInfo() {
                console.log('Detecting environment information...');
                await this.refreshEnvironmentInfo();
            }

            // 刷新环境信息
            async refreshEnvironmentInfo() {
                console.log('Refreshing environment information...');

                // 显示加载状态
                const loadingElements = [
                    'python-version', 'python-path', 'venv-status',
                    'cuda-version', 'gpu-info', 'gpu-memory',
                    'pytorch-version', 'pytorch-cuda', 'pytorch-device',
                    'core-deps', 'optional-deps', 'env-status'
                ];

                loadingElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = '检测中...';
                        element.style.color = '#888';
                    }
                });

                // 并行检测所有环境信息
                try {
                    await Promise.all([
                        this.detectPythonInfo(),
                        this.detectCudaInfo(),
                        this.detectPytorchInfo(),
                        this.detectDependencies()
                    ]);
                    console.log('Environment information refreshed successfully');
                } catch (error) {
                    console.error('Failed to refresh environment information:', error);
                }
            }

            // 手动安装插件相关方法
            initManualInstallPage() {
                console.log('Initializing manual install page');

                // 加载安装历史
                this.loadInstallHistory();

                // 绑定表单事件
                this.bindManualInstallEvents();
            }

            bindManualInstallEvents() {
                // URL输入框实时验证
                const urlInput = document.getElementById('plugin-url');
                if (urlInput) {
                    urlInput.addEventListener('input', () => {
                        this.validateUrlInput();
                    });
                }


            }

            validateUrlInput() {
                const urlInput = document.getElementById('plugin-url');
                const hint = document.getElementById('url-hint');

                if (!urlInput || !hint) return;

                const url = urlInput.value.trim();
                if (!url) {
                    hint.innerHTML = '<i class="fas fa-lightbulb"></i><span>支持GitHub、GitLab、Gitee等Git仓库地址</span>';
                    hint.style.color = 'var(--text-secondary)';
                    return;
                }

                if (this.isValidGitUrl(url)) {
                    hint.innerHTML = '<i class="fas fa-check-circle"></i><span>地址格式正确</span>';
                    hint.style.color = '#28a745';
                } else {
                    hint.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>请输入有效的Git仓库地址</span>';
                    hint.style.color = '#dc3545';
                }
            }

            isValidGitUrl(url) {
                // 支持的Git仓库地址格式
                const gitUrlPatterns = [
                    /^https:\/\/github\.com\/[\w\-\.]+\/[\w\-\.]+(?:\.git)?$/,
                    /^https:\/\/gitlab\.com\/[\w\-\.]+\/[\w\-\.]+(?:\.git)?$/,
                    /^https:\/\/gitee\.com\/[\w\-\.]+\/[\w\-\.]+(?:\.git)?$/,
                    /^https:\/\/[\w\-\.]+\/[\w\-\.]+\/[\w\-\.]+(?:\.git)?$/,
                    /^git@[\w\-\.]+:[\w\-\.]+\/[\w\-\.]+(?:\.git)?$/
                ];

                return gitUrlPatterns.some(pattern => pattern.test(url));
            }

            extractRepoName(url) {
                try {
                    // 从URL中提取仓库名称
                    const match = url.match(/\/([^\/]+?)(?:\.git)?(?:\/)?$/);
                    return match ? match[1] : null;
                } catch (error) {
                    return null;
                }
            }

            async validatePluginUrl() {
                const urlInput = document.getElementById('plugin-url');
                const validateBtn = document.querySelector('.validate-btn');

                if (!urlInput || !validateBtn) return;

                const url = urlInput.value.trim();
                if (!url) {
                    this.showNotification('请输入Git仓库地址', 'warning');
                    return;
                }

                // 设置验证中状态
                const originalIcon = validateBtn.innerHTML;
                validateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                validateBtn.disabled = true;

                try {
                    // 验证URL可访问性
                    const response = await fetch(`${this.backendUrl}/plugins/validate-url`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ url })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showNotification('仓库地址验证成功', 'success');


                    } else {
                        this.showNotification(`验证失败: ${result.message}`, 'error');
                    }
                } catch (error) {
                    console.error('URL validation failed:', error);
                    this.showNotification('验证失败，请检查网络连接', 'error');
                } finally {
                    // 恢复按钮状态
                    validateBtn.innerHTML = originalIcon;
                    validateBtn.disabled = false;
                }
            }

            async installManualPlugin() {
                const urlInput = document.getElementById('plugin-url');
                const forceInstall = document.getElementById('force-install');
                const shallowClone = document.getElementById('shallow-clone');

                if (!urlInput) return;

                const url = urlInput.value.trim();
                if (!url) {
                    this.showNotification('请输入Git仓库地址', 'warning');
                    return;
                }

                if (!this.isValidGitUrl(url)) {
                    this.showNotification('请输入有效的Git仓库地址', 'error');
                    return;
                }

                const pluginName = this.extractRepoName(url);
                if (!pluginName) {
                    this.showNotification('无法从URL中提取插件名称', 'error');
                    return;
                }

                // 显示安装进度
                this.showInstallProgress();

                const installOptions = {
                    url: url,
                    name: pluginName,
                    force: forceInstall?.checked || false,
                    shallow: shallowClone?.checked || true
                };

                try {
                    await this.performManualInstall(installOptions);
                } catch (error) {
                    console.error('Manual install failed:', error);
                    this.hideInstallProgress();
                    this.showNotification(`安装失败: ${error.message}`, 'error');
                }
            }

            showInstallProgress() {
                const progressContainer = document.getElementById('manual-install-progress');
                const formContainer = document.querySelector('.manual-install-form');

                if (progressContainer) {
                    progressContainer.style.display = 'block';
                }
                if (formContainer) {
                    formContainer.style.opacity = '0.5';
                    formContainer.style.pointerEvents = 'none';
                }

                // 重置进度
                this.updateInstallProgress(0, '准备安装...', '');
            }

            hideInstallProgress() {
                const progressContainer = document.getElementById('manual-install-progress');
                const formContainer = document.querySelector('.manual-install-form');

                if (progressContainer) {
                    progressContainer.style.display = 'none';
                }
                if (formContainer) {
                    formContainer.style.opacity = '1';
                    formContainer.style.pointerEvents = 'auto';
                }
            }

            updateInstallProgress(percentage, text, details) {
                const progressFill = document.getElementById('manual-progress-fill');
                const progressText = document.getElementById('progress-text');
                const progressDetails = document.getElementById('progress-details');
                const progressPercentage = document.getElementById('progress-percentage');

                if (progressFill) {
                    progressFill.style.width = `${percentage}%`;
                }
                if (progressText) {
                    progressText.textContent = text;
                }
                if (progressDetails) {
                    progressDetails.textContent = details;
                }
                if (progressPercentage) {
                    progressPercentage.textContent = `${Math.round(percentage)}%`;
                }
            }

            async performManualInstall(options) {
                this.currentInstallProcess = {
                    cancelled: false,
                    options: options
                };

                try {
                    this.updateInstallProgress(10, '正在验证仓库...', `检查 ${options.url}`);

                    // 调用后端API进行安装
                    const response = await fetch(`${this.backendUrl}/plugins/install-manual`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(options)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    // 处理流式响应
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        if (this.currentInstallProcess?.cancelled) {
                            throw new Error('安装已取消');
                        }

                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n').filter(line => line.trim());

                        for (const line of lines) {
                            try {
                                const data = JSON.parse(line);
                                this.handleInstallProgress(data);
                            } catch (e) {
                                // 忽略非JSON行
                            }
                        }
                    }

                    // 安装完成
                    this.updateInstallProgress(100, '安装完成', '插件已成功安装');
                    this.showNotification(`插件 ${options.name} 安装成功`, 'success', 'plugin');

                    // 添加到安装历史
                    this.addToInstallHistory({
                        name: options.name,
                        url: options.url,
                        status: 'success',
                        time: new Date().toLocaleString()
                    });

                    // 清空表单
                    setTimeout(() => {
                        this.clearManualInstallForm();
                        this.hideInstallProgress();

                        // 如果当前在已安装标签页，刷新列表
                        if (this.currentPluginTab === 'installed') {
                            this.needRefreshInstalledTab = true;
                        }
                    }, 2000);

                } catch (error) {
                    console.error('Manual install failed:', error);

                    // 添加到安装历史（失败记录）
                    this.addToInstallHistory({
                        name: options.name,
                        url: options.url,
                        status: 'failed',
                        time: new Date().toLocaleString(),
                        error: error.message
                    });

                    throw error;
                } finally {
                    this.currentInstallProcess = null;
                }
            }

            handleInstallProgress(data) {
                if (data.progress !== undefined) {
                    this.updateInstallProgress(
                        data.progress,
                        data.message || '正在安装...',
                        data.details || ''
                    );
                }

                if (data.error) {
                    throw new Error(data.error);
                }
            }

            cancelManualInstall() {
                if (this.currentInstallProcess) {
                    this.currentInstallProcess.cancelled = true;
                    this.showNotification('正在取消安装...', 'info');

                    // 添加取消记录到历史
                    this.addToInstallHistory({
                        name: this.currentInstallProcess.options.name,
                        url: this.currentInstallProcess.options.url,
                        status: 'cancelled',
                        time: new Date().toLocaleString()
                    });

                    setTimeout(() => {
                        this.hideInstallProgress();
                        this.showNotification('安装已取消', 'warning');
                    }, 1000);
                }
            }

            clearManualInstallForm() {
                const urlInput = document.getElementById('plugin-url');
                const forceInstall = document.getElementById('force-install');
                const shallowClone = document.getElementById('shallow-clone');
                const hint = document.getElementById('url-hint');

                if (urlInput) urlInput.value = '';
                if (forceInstall) forceInstall.checked = false;
                if (shallowClone) shallowClone.checked = true;

                if (hint) {
                    hint.innerHTML = '<i class="fas fa-lightbulb"></i><span>支持GitHub、GitLab、Gitee等Git仓库地址</span>';
                    hint.style.color = 'var(--text-secondary)';
                }
            }

            loadInstallHistory() {
                try {
                    const history = JSON.parse(localStorage.getItem('manual-install-history') || '[]');
                    this.renderInstallHistory(history);
                } catch (error) {
                    console.error('Failed to load install history:', error);
                    this.renderInstallHistory([]);
                }
            }

            addToInstallHistory(record) {
                try {
                    const history = JSON.parse(localStorage.getItem('manual-install-history') || '[]');
                    history.unshift(record); // 添加到开头

                    // 限制历史记录数量
                    if (history.length > 50) {
                        history.splice(50);
                    }

                    localStorage.setItem('manual-install-history', JSON.stringify(history));
                    this.renderInstallHistory(history);
                } catch (error) {
                    console.error('Failed to save install history:', error);
                }
            }

            renderInstallHistory(history) {
                const container = document.getElementById('install-history-list');
                if (!container) return;

                if (!history || history.length === 0) {
                    container.innerHTML = `
                        <div class="history-empty">
                            <i class="fas fa-clock"></i>
                            <span>暂无安装历史</span>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = history.map(record => `
                    <div class="history-item">
                        <div class="history-header">
                            <div class="history-name">${this.escapeHtml(record.name)}</div>
                            <div class="history-status ${record.status}">${this.getStatusText(record.status)}</div>
                        </div>
                        <div class="history-details">
                            <div class="history-url" title="${this.escapeHtml(record.url)}">${this.escapeHtml(record.url)}</div>
                            <div class="history-time">${record.time}</div>
                        </div>
                        ${record.error ? `<div style="color: #dc3545; font-size: 11px; margin-top: 5px;">${this.escapeHtml(record.error)}</div>` : ''}
                    </div>
                `).join('');
            }

            getStatusText(status) {
                const statusMap = {
                    'success': '成功',
                    'failed': '失败',
                    'cancelled': '已取消',
                    'installing': '安装中'
                };
                return statusMap[status] || status;
            }
        }

        // 初始化启动器
        let launcherInstance;

        // 启动器更新函数
        async function checkLauncherUpdate() {
            const btn = document.getElementById('check-launcher-update-btn');
            const originalText = btn.innerHTML;
            
            try {
                // 显示检查中状态
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 检查中...';
                btn.disabled = true;
                
                // 获取后端URL
                const backendUrl = await window.electronAPI.getBackendUrl();
                const response = await fetch(`${backendUrl}/launcher/version-info`);
                const versionInfo = await response.json();
                
                if (versionInfo.error) {
                    throw new Error(versionInfo.error);
                }
                
                // 更新页面中的版本信息
                updateVersionDisplay(versionInfo);
                
                if (versionInfo.has_update) {
                    showUpdateNotification(versionInfo);
                } else if (versionInfo.manual_update) {
                    // 显示手动更新指引
                    showManualUpdateDialog(versionInfo);
                } else {
                    showMessage('启动器已是最新版本！', 'success');
                }
                
            } catch (error) {
                console.error('检查更新失败:', error);
                showMessage('检查更新失败，请检查网络连接', 'error');
            } finally {
                // 恢复按钮状态
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function showManualUpdateDialog(versionInfo) {
            const modal = document.createElement('div');
            modal.className = 'custom-confirm-modal';
            modal.innerHTML = `
                <div class="custom-confirm-content">
                    <div class="custom-confirm-header">
                        <h3>🚀 启动器更新</h3>
                    </div>
                    <div class="custom-confirm-body">
                        <p><strong>当前版本:</strong> v${versionInfo.current_version}</p>
                        <div style="margin: 15px 0; padding: 15px; background: rgba(0, 245, 255, 0.1); border-radius: 8px; border-left: 3px solid var(--neon-glow);">
                            <p style="margin: 0; color: var(--neon-glow);"><strong>ℹ️ 更新说明</strong></p>
                            <p style="margin: 5px 0 0 0;">${versionInfo.message}</p>
                        </div>
                        <p><strong>如需获取最新版本，请：</strong></p>
                        <ul style="text-align: left; margin: 10px 0; color: var(--text-secondary);">
                            <li>访问项目GitHub页面查看最新Release</li>
                            <li>下载launcher更新包</li>
                            <li>替换当前launcher目录</li>
                            <li>重启启动器应用</li>
                        </ul>
                    </div>
                    <div class="custom-confirm-actions">
                        <button class="custom-confirm-btn confirm" onclick="openGitHubPage('${versionInfo.github_url}')">
                            <i class="fas fa-external-link-alt"></i> 访问GitHub
                        </button>
                        <button class="custom-confirm-btn cancel" onclick="document.body.removeChild(this.closest('.custom-confirm-modal'))">
                            知道了
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openGitHubPage(url) {
            // 使用Electron API打开外部链接
            if (window.electronAPI && window.electronAPI.openExternal) {
                window.electronAPI.openExternal(url);
            } else {
                // 备用方案
                window.open(url, '_blank');
            }
            
            // 关闭弹窗
            const modal = document.querySelector('.custom-confirm-modal');
            if (modal) document.body.removeChild(modal);
        }

        function updateVersionDisplay(versionInfo) {
            // 更新当前版本显示
            const versionElements = document.querySelectorAll('.info-value');
            if (versionElements.length >= 2) {
                versionElements[0].textContent = `v${versionInfo.current_version}`;
                
                // 优先显示GitHub Release发布时间，否则显示本地时间
                if (versionInfo.published_at) {
                    const date = new Date(versionInfo.published_at);
                    const formattedDate = date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit', 
                        day: '2-digit'
                    });
                    versionElements[1].textContent = formattedDate;
                } else if (versionInfo.lastModified) {
                    versionElements[1].textContent = versionInfo.lastModified;
                }
            }
        }

        function showUpdateNotification(versionInfo) {
            const modal = document.createElement('div');
            modal.className = 'custom-confirm-modal';
            modal.innerHTML = `
                <div class="custom-confirm-content">
                    <div class="custom-confirm-header">
                        <h3>🚀 发现启动器新版本</h3>
                    </div>
                    <div class="custom-confirm-body">
                        <p><strong>当前版本:</strong> v${versionInfo.current_version}</p>
                        <p><strong>最新版本:</strong> v${versionInfo.latest_version}</p>
                        <p><strong>更新大小:</strong> ${formatFileSize(versionInfo.size)}</p>
                        <div style="margin-top: 15px;">
                            <strong>更新内容:</strong>
                            <div style="max-height: 200px; overflow-y: auto; margin-top: 5px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                                ${formatChangelog(versionInfo.changelog)}
                            </div>
                        </div>
                    </div>
                    <div class="custom-confirm-actions">
                        <button class="custom-confirm-btn confirm" onclick="startLauncherUpdate('${versionInfo.download_url}', this.closest('.custom-confirm-modal'))">
                            <i class="fas fa-download"></i> 立即更新
                        </button>
                        <button class="custom-confirm-btn cancel" onclick="document.body.removeChild(this.closest('.custom-confirm-modal'))">
                            稍后提醒
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function startLauncherUpdate(downloadUrl, modal) {
            try {
                // 关闭更新通知弹窗
                document.body.removeChild(modal);
                
                // 显示下载进度
                showUpdateProgress();
                
                const response = await fetch('/launcher/download-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ download_url: downloadUrl })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    updateProgressText('下载完成，正在安装...');
                    
                    // 使用Electron API安装更新
                    if (window.electronAPI && window.electronAPI.installLauncherUpdate) {
                        const installResult = await window.electronAPI.installLauncherUpdate(result.file_path);
                        
                        if (installResult.success) {
                            updateProgressText('安装成功，3秒后重启...');
                            setTimeout(() => {
                                window.electronAPI.restartLauncher();
                            }, 3000);
                        } else {
                            throw new Error(installResult.error);
                        }
                    } else {
                        throw new Error('Electron API不可用，请手动重启启动器');
                    }
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('更新失败:', error);
                hideUpdateProgress();
                showMessage(`更新失败: ${error.message}`, 'error');
            }
        }

        function showUpdateProgress() {
            const progress = document.createElement('div');
            progress.id = 'launcher-update-progress';
            progress.className = 'custom-confirm-modal';
            progress.innerHTML = `
                <div class="custom-confirm-content">
                    <div class="custom-confirm-header">
                        <h3>正在更新启动器</h3>
                    </div>
                    <div class="custom-confirm-body">
                        <div style="text-align: center; padding: 20px;">
                            <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                            <p id="update-progress-text">正在下载更新包...</p>
                            <p style="color: #666; font-size: 0.9rem;">请勿关闭启动器</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(progress);
        }

        function updateProgressText(text) {
            const textEl = document.getElementById('update-progress-text');
            if (textEl) textEl.textContent = text;
        }

        function hideUpdateProgress() {
            const progress = document.getElementById('launcher-update-progress');
            if (progress) document.body.removeChild(progress);
        }

        function formatFileSize(bytes) {
            if (!bytes) return '未知';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatChangelog(changelog) {
            if (!changelog) return '暂无更新说明';
            
            // 简单处理markdown格式
            return changelog
                .replace(/^### /gm, '<strong>')
                .replace(/^## /gm, '<strong>')
                .replace(/^# /gm, '<strong>')
                .replace(/\n- /g, '<br>• ')
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        function showMessage(message, type = 'info') {
            // 简单的消息提示
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        // 音效管理器初始化
        let audioManager;

        // 音效绑定函数
        function bindAudioToButtons() {
            if (!audioManager) return;

            // 为所有按钮绑定点击音效
            document.querySelectorAll('button').forEach(button => {
                if (!button.hasAttribute('data-audio-bound')) {
                    button.addEventListener('click', (e) => {
                        const buttonType = getButtonType(button);
                        audioManager.play(buttonType);
                    });

                    // 悬停音效（如果启用）
                    button.addEventListener('mouseenter', () => {
                        if (audioManager.settings.hoverSounds) {
                            audioManager.play('hover');
                        }
                    });

                    button.setAttribute('data-audio-bound', 'true');
                }
            });

            // 使用事件委托为动态添加的按钮绑定音效
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && !e.target.hasAttribute('data-audio-bound')) {
                    const buttonType = getButtonType(e.target);
                    audioManager.play(buttonType);
                }
            });

            // 标签页音效现在通过 getButtonType() 函数和通用按钮绑定处理
            // 不需要单独的标签页音效绑定逻辑

            // 为输入框绑定输入音效
            document.querySelectorAll('input[type="text"], input[type="search"], textarea').forEach(input => {
                if (!input.hasAttribute('data-audio-bound')) {
                    input.addEventListener('focus', () => {
                        audioManager.play('input');
                    });
                    input.setAttribute('data-audio-bound', 'true');
                }
            });
        }

        // 优化的按钮音效识别 - 基于音效方案规划
        function getButtonType(button) {
            const classList = button.classList;
            const id = button.id;
            const text = button.textContent.toLowerCase();

            // 标签页按钮 - 使用标签页切换音效（导航标签音效）
            if (classList.contains('tab-btn') || classList.contains('plugin-tab-btn') ||
                classList.contains('version-tab-btn') || classList.contains('environment-tab-btn') ||
                button.hasAttribute('data-tab') || button.hasAttribute('data-type')) {
                return 'tab-switch';
            }

            // ComfyUI系统级操作 - 使用专用系统音效
            if (id === 'start-comfyui-btn' || (text.includes('启动') && text.includes('comfyui'))) {
                return 'startup';
            }
            if (id === 'stop-comfyui-btn' || (text.includes('停止') && text.includes('comfyui')) ||
                (text.includes('关闭') && text.includes('comfyui'))) {
                return 'shutdown';
            }

            // 警告类按钮 - 使用警告音效
            if (classList.contains('danger') || classList.contains('warning') || classList.contains('uninstall') ||
                text.includes('删除') || text.includes('卸载') || text.includes('清空') ||
                text.includes('重置') || text.includes('取消') || text.includes('移除')) {
                return 'warning';
            }

            // 主要操作按钮 - 使用主要按钮音效（按钮科技音效）
            if (classList.contains('primary') || classList.contains('btn-primary') ||
                classList.contains('main-btn') || classList.contains('important') ||
                classList.contains('install') || classList.contains('update') ||
                text.includes('保存') || text.includes('确认') || text.includes('安装') ||
                text.includes('更新') || text.includes('下载') || text.includes('应用') ||
                text.includes('切换版本') || text.includes('切换到')) {
                return 'click-primary';
            }

            // 开关切换按钮 - 使用切换音效（导航标签音效）
            if (classList.contains('toggle') || classList.contains('switch') ||
                text.includes('启用') || text.includes('禁用') || text.includes('开启') || text.includes('关闭')) {
                return 'switch';
            }

            // 确认对话框按钮 - 使用确认音效（导航标签音效）
            if (classList.contains('confirm') || text.includes('确定') || text.includes('好的')) {
                return 'confirm';
            }

            // 默认使用普通点击音效（按钮科技音效）
            return 'click';
        }

        // 初始化声音设置
        function initAudioSettings() {
            // 初始化背景视频声音设置
            initVideoAudioSettings();

            if (!audioManager) return;

            // 加载保存的设置
            const settings = audioManager.getSettings();

            // 设置UI控件的值
            const audioEnabled = document.getElementById('audio-enabled');
            const audioVolume = document.getElementById('audio-volume');
            const volumeDisplay = document.getElementById('volume-display');

            if (audioEnabled) {
                audioEnabled.checked = settings.enabled;
                audioEnabled.addEventListener('change', (e) => {
                    audioManager.setEnabled(e.target.checked);
                    if (e.target.checked) {
                        audioManager.play('click');
                    }
                });
            }

            if (audioVolume && volumeDisplay) {
                audioVolume.value = settings.volume * 100;
                volumeDisplay.textContent = Math.round(settings.volume * 100) + '%';
                audioVolume.addEventListener('input', (e) => {
                    const volume = e.target.value / 100;
                    audioManager.setVolume(volume);
                    volumeDisplay.textContent = e.target.value + '%';
                    // 播放预览音效
                    audioManager.play('click', volume);
                });
            }

        }

        // 初始化背景视频声音设置
        function initVideoAudioSettings() {
            const videoAudioEnabled = document.getElementById('video-audio-enabled');
            const videoVolume = document.getElementById('video-volume');
            const videoVolumeDisplay = document.getElementById('video-volume-display');
            const backgroundVideo = document.getElementById('backgroundVideo');

            // 从localStorage加载设置
            const savedVideoAudioEnabled = localStorage.getItem('video-audio-enabled') === 'true';
            const savedVideoVolume = parseFloat(localStorage.getItem('video-volume')) || 0.3;

            // 设置初始值
            if (videoAudioEnabled) {
                videoAudioEnabled.checked = savedVideoAudioEnabled;
                videoAudioEnabled.addEventListener('change', (e) => {
                    const enabled = e.target.checked;
                    localStorage.setItem('video-audio-enabled', enabled);
                    if (backgroundVideo) {
                        backgroundVideo.muted = !enabled;
                        if (enabled) {
                            backgroundVideo.volume = savedVideoVolume;
                        }
                    }
                    // 播放点击音效
                    if (window.audioManager) {
                        audioManager.play('click');
                    }
                });
            }

            if (videoVolume && videoVolumeDisplay) {
                videoVolume.value = savedVideoVolume * 100;
                videoVolumeDisplay.textContent = Math.round(savedVideoVolume * 100) + '%';
                videoVolume.addEventListener('input', (e) => {
                    const volume = e.target.value / 100;
                    localStorage.setItem('video-volume', volume);
                    videoVolumeDisplay.textContent = e.target.value + '%';
                    if (backgroundVideo && !backgroundVideo.muted) {
                        backgroundVideo.volume = volume;
                    }
                });
            }

            // 应用初始设置到视频元素
            if (backgroundVideo) {
                backgroundVideo.muted = !savedVideoAudioEnabled;
                if (savedVideoAudioEnabled) {
                    backgroundVideo.volume = savedVideoVolume;
                }
            }
        }

        // 音效预览函数
        function previewSound(soundName) {
            if (audioManager) {
                audioManager.preview(soundName);
            }
        }

        // 自动更新启动器版本信息显示
        async function updateLauncherVersionInfo() {
            try {
                // 获取后端URL
                const backendUrl = await window.electronAPI.getBackendUrl();
                const response = await fetch(`${backendUrl}/launcher/get-version`);
                const versionData = await response.json();
                
                if (versionData.status === 'success') {
                    // 更新设置页面中的版本信息显示
                    const versionElements = document.querySelectorAll('.info-value');
                    if (versionElements.length >= 2) {
                        versionElements[0].textContent = `v${versionData.version}`;
                        versionElements[1].textContent = versionData.lastModified;
                    }
                    
                    console.log('启动器版本信息已更新:', versionData);
                }
            } catch (error) {
                console.warn('获取启动器版本信息失败:', error);
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded - initializing launcher...');

            // 初始化音效管理器
            if (window.audioManager) {
                audioManager = window.audioManager;
                console.log('Audio manager initialized');

                // 绑定按钮音效
                setTimeout(() => {
                    bindAudioToButtons();
                    initAudioSettings();
                    console.log('Audio effects bound to buttons');
                }, 100);

                // 播放启动音效
                setTimeout(() => audioManager.play('startup'), 500);
            }

            launcherInstance = new AIVisionLauncher();
            console.log('launcherInstance created:', !!launcherInstance);
            console.log('showPluginVersions method exists:', !!(launcherInstance && launcherInstance.showPluginVersions));

            // 初始化启动器版本信息显示
            setTimeout(async () => {
                await updateLauncherVersionInfo();
                // 同时获取GitHub Release信息来更新显示
                try {
                    const backendUrl = await window.electronAPI.getBackendUrl();
                    const response = await fetch(`${backendUrl}/launcher/version-info`);
                    const versionInfo = await response.json();
                    if (versionInfo.published_at) {
                        updateVersionDisplay(versionInfo);
                    }
                } catch (error) {
                    console.warn('获取GitHub版本信息失败:', error);
                }
            }, 1000);

            // 添加窗口关闭音效
            window.addEventListener('beforeunload', () => {
                if (window.audioManager) {
                    audioManager.play('app-close');
                }
            });

            // 初始化时立即加载GPU信息
            if (launcherInstance && launcherInstance.loadRealGPUInfo) {
                setTimeout(() => {
                    launcherInstance.loadRealGPUInfo();
                }, 1000); // 延迟1秒确保后端服务已启动
            }



            // 加载保存的主题
            loadSavedTheme();

            // 初始化开机自启动设置
            initAutoStartSetting();

            // 为开机自启动复选框添加事件监听器
            const autoStartCheckbox = document.getElementById('autoStart');
            if (autoStartCheckbox) {
                autoStartCheckbox.addEventListener('change', toggleAutoStart);
            }

            // 初始化命令预览（仅在启动设置元素存在时）
            if (document.getElementById('listen-ip')) {
                launcherInstance.updateCommandPreview();
            }
            console.log('Launcher initialization complete');
        });

        // 全局函数，供HTML按钮调用
        function saveSettings() {
            if (launcherInstance) {
                launcherInstance.saveSettings();
            }
        }

        function applyAndLaunch() {
            if (launcherInstance) {
                launcherInstance.applyAndLaunch();
            }
        }

        // 版本切换全局函数
        function switchToVersion(commit, versionHash) {
            console.log('Global switchToVersion called:', commit, versionHash);
            if (launcherInstance && launcherInstance.switchToVersion) {
                launcherInstance.switchToVersion(commit, versionHash);
            } else {
                console.error('launcherInstance or switchToVersion method not available');
            }
        }

        // 环境配置页面相关函数
        function switchEnvironmentTab(tabId) {
            // 隐藏所有标签页内容
            const allTabs = document.querySelectorAll('.environment-tab-content');
            allTabs.forEach(tab => tab.classList.remove('active'));

            // 移除所有标签按钮的active类
            const allButtons = document.querySelectorAll('.environment-tab-btn');
            allButtons.forEach(btn => btn.classList.remove('active'));

            // 显示选中的标签页
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // 激活对应的标签按钮
            const selectedButton = document.querySelector(`[onclick="switchEnvironmentTab('${tabId}')"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }

            // 根据标签页类型执行相应的初始化
            if (tabId === 'env-info' && launcherInstance) {
                // 如果切换到环境信息标签页，自动检测环境信息
                launcherInstance.detectEnvironmentInfo();
            } else if (tabId === 'env-terminal') {
                // 如果切换到终端标签页，加载终端信息
                loadTerminalInfo();
            }
        }



        function returnToMainPage() {
            // 切换到主页标签
            if (launcherInstance && launcherInstance.switchTab) {
                launcherInstance.switchTab('home');
            } else {
                console.error('launcherInstance or switchTab method not available');
            }
        }

        // 主题切换功能
        function switchTheme(theme) {
            // 更新主题按钮状态
            const themeBtns = document.querySelectorAll('.theme-btn');
            themeBtns.forEach(btn => btn.classList.remove('active'));

            const activeBtn = document.querySelector(`[data-theme="${theme}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            // 应用主题颜色
            const root = document.documentElement;
            switch(theme) {
                case 'blue':
                    root.style.setProperty('--neon-glow', '#00f5ff');
                    root.style.setProperty('--accent-cyan', '#00f5ff');
                    break;
                case 'green':
                    root.style.setProperty('--neon-glow', '#00ff88');
                    root.style.setProperty('--accent-cyan', '#00ff88');
                    break;
                case 'purple':
                    root.style.setProperty('--neon-glow', '#8a2be2');
                    root.style.setProperty('--accent-cyan', '#8a2be2');
                    break;
                case 'red':
                    root.style.setProperty('--neon-glow', '#ff4757');
                    root.style.setProperty('--accent-cyan', '#ff4757');
                    break;
            }

            // 保存主题设置到本地存储
            localStorage.setItem('selectedTheme', theme);

            console.log(`Theme switched to: ${theme}`);
        }

        // 页面加载时恢复保存的主题
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'blue';
            switchTheme(savedTheme);
        }

        // 开机自启动功能
        async function initAutoStartSetting() {
            try {
                const result = await window.electronAPI.getAutoStart();
                if (result.success) {
                    const autoStartCheckbox = document.getElementById('autoStart');
                    if (autoStartCheckbox) {
                        autoStartCheckbox.checked = result.enabled;
                        console.log('开机自启动状态:', result.enabled);
                    }
                }
            } catch (error) {
                console.error('获取开机自启动状态失败:', error);
            }
        }

        async function toggleAutoStart(event) {
            try {
                const enabled = event.target.checked;
                console.log('设置开机自启动:', enabled);

                const result = await window.electronAPI.setAutoStart(enabled);

                if (result.success) {
                    console.log('开机自启动设置成功:', enabled);

                    // 显示成功提示
                    await window.electronAPI.showMessageBox({
                        type: 'info',
                        title: '设置成功',
                        message: enabled ? '已启用开机自启动' : '已禁用开机自启动',
                        buttons: ['确定']
                    });
                } else {
                    throw new Error(result.error || '设置开机自启动失败');
                }
            } catch (error) {
                console.error('设置开机自启动失败:', error);

                // 恢复复选框状态
                event.target.checked = !event.target.checked;

                // 显示错误提示
                await window.electronAPI.showMessageBox({
                    type: 'error',
                    title: '设置失败',
                    message: '设置开机自启动失败',
                    detail: error.message,
                    buttons: ['确定']
                });
            }
        }

        // 创建桌面快捷方式
        async function createDesktopShortcut(event) {
            try {
                // 显示加载状态
                const button = event ? event.target.closest('.action-btn') : document.querySelector('.action-btn[onclick*="createDesktopShortcut"]');
                if (!button) {
                    throw new Error('无法找到按钮元素');
                }
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 创建中...';
                button.disabled = true;

                // 调用Electron API创建快捷方式
                const result = await window.electronAPI.createDesktopShortcut();

                if (result.success) {
                    // 显示成功消息
                    await window.electronAPI.showMessageBox({
                        type: 'info',
                        title: '成功',
                        message: result.message,
                        detail: `快捷方式已创建到桌面：\n${result.path || ''}`,
                        buttons: ['确定']
                    });

                    // 更新按钮状态
                    button.innerHTML = '<i class="fas fa-check"></i> 创建成功';
                    button.style.background = 'linear-gradient(45deg, #00ff88, #00cc6a)';

                    // 3秒后恢复原状
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                        button.style.background = '';
                    }, 3000);

                } else {
                    throw new Error(result.error || '创建快捷方式失败');
                }

            } catch (error) {
                console.error('创建桌面快捷方式失败:', error);

                // 显示错误消息
                await window.electronAPI.showMessageBox({
                    type: 'error',
                    title: '错误',
                    message: '创建桌面快捷方式失败',
                    detail: error.message,
                    buttons: ['确定']
                });

                // 恢复按钮状态
                const button = event ? event.target.closest('.action-btn') : document.querySelector('.action-btn[onclick*="createDesktopShortcut"]');
                if (button) {
                    button.innerHTML = '<i class="fas fa-plus"></i> 创建快捷方式';
                    button.disabled = false;
                }
            }
        }



        // 获取终端环境信息
        async function loadTerminalInfo() {
            try {
                const response = await fetch('http://127.0.0.1:8404/terminal/info');
                if (response.ok) {
                    const data = await response.json();
                    console.log('Terminal info received:', data);

                    // 检查是否有错误
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // 更新工作目录
                    const cwdElement = document.getElementById('terminal-cwd');
                    if (cwdElement) {
                        cwdElement.textContent = data.work_dir || '未知';
                    }

                    // 更新虚拟环境信息
                    const venvElement = document.getElementById('terminal-venv');
                    if (venvElement) {
                        const venvInfo = data.venv_exists ?
                            `${data.env_type} (${data.venv_path})` :
                            '未检测到虚拟环境';
                        venvElement.textContent = venvInfo;
                        venvElement.style.color = data.venv_exists ? '#00ff88' : '#ff6b6b';
                    }

                    // 更新Python版本
                    const pythonElement = document.getElementById('terminal-python');
                    if (pythonElement) {
                        pythonElement.textContent = data.python_version || '未知';
                    }

                    // 更新环境状态
                    const statusElement = document.getElementById('terminal-status');
                    if (statusElement) {
                        statusElement.textContent = data.env_status || '未知';
                        statusElement.style.color = data.env_status === '已激活' ? '#00ff88' : '#ff6b6b';
                    }

                    // 更新终端提示符
                    const promptElement = document.getElementById('terminal-prompt');
                    if (promptElement) {
                        promptElement.textContent = data.prompt || 'cmd> ';
                    }

                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Failed to load terminal info:', error);
                // 使用便携包的实际环境信息作为备用
                loadTerminalInfoFallback();
            }
        }

        // 备用的终端信息加载（使用便携包的实际路径）
        function loadTerminalInfoFallback() {
            console.log('Using fallback terminal info...');

            // 基于便携包的实际路径设置环境信息
            const portableRoot = 'D:\\AI\\ComfyUI-AI-Vision\\Portable\\ComfyUI-AI-Vision-Portable';
            const venvPath = portableRoot + '\\venv';

            // 更新工作目录
            const cwdElement = document.getElementById('terminal-cwd');
            if (cwdElement) {
                cwdElement.textContent = portableRoot;
            }

            // 更新虚拟环境信息
            const venvElement = document.getElementById('terminal-venv');
            if (venvElement) {
                venvElement.textContent = `venv (${venvPath})`;
                venvElement.style.color = '#00ff88';
            }

            // 更新Python版本
            const pythonElement = document.getElementById('terminal-python');
            if (pythonElement) {
                pythonElement.textContent = 'Python 3.12.9';
            }

            // 更新环境状态
            const statusElement = document.getElementById('terminal-status');
            if (statusElement) {
                statusElement.textContent = '已激活';
                statusElement.style.color = '#00ff88';
            }

            // 更新终端提示符
            const promptElement = document.getElementById('terminal-prompt');
            if (promptElement) {
                promptElement.textContent = 'venv> ';
            }
        }

        function clearTerminal() {
            const terminalOutput = document.getElementById('terminal-output');
            if (terminalOutput) {
                terminalOutput.innerHTML = '';
            }
        }


        function handleTerminalInput(event) {
            if (event.key === 'Enter') {
                const input = event.target;
                const command = input.value.trim();

                if (command) {
                    // 添加命令到输出
                    const terminalOutput = document.getElementById('terminal-output');
                    if (terminalOutput) {
                        // 获取当前提示符
                        const promptElement = document.getElementById('terminal-prompt');
                        const currentPrompt = promptElement ? promptElement.textContent : 'cmd> ';

                        const commandLine = document.createElement('div');
                        commandLine.innerHTML = `<span style="color: #00ff88;">${currentPrompt}</span><span style="color: #00ff00;">${command}</span>`;
                        commandLine.style.marginBottom = '8px';
                        terminalOutput.appendChild(commandLine);

                        // 执行命令
                        executeTerminalCommand(command, terminalOutput);

                        // 自动滚动到底部
                        scrollTerminalToBottom(terminalOutput);
                    }

                    // 清空输入
                    input.value = '';
                }
            }
        }

        function scrollTerminalToBottom(terminalOutput) {
            // 平滑滚动到底部
            setTimeout(() => {
                terminalOutput.scrollTop = terminalOutput.scrollHeight;
            }, 100);
        }

        async function executeTerminalCommand(command, outputElement) {
            // 显示执行中状态
            const executingDiv = document.createElement('div');
            executingDiv.style.color = '#888';
            executingDiv.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 执行中...`;
            outputElement.appendChild(executingDiv);

            try {
                // 调用后端API执行命令
                const response = await fetch('http://127.0.0.1:8404/terminal/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: command })
                });

                // 移除执行中状态
                outputElement.removeChild(executingDiv);

                if (response.ok) {
                    const data = await response.json();

                    // 处理清空命令
                    if (data.clear) {
                        outputElement.innerHTML = '';
                        return;
                    }

                    // 显示命令输出
                    const result = document.createElement('div');
                    result.style.marginBottom = '12px';
                    result.style.lineHeight = '1.4';

                    if (data.error) {
                        result.style.color = '#ff6b6b';
                        result.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${data.error}`;
                    } else if (data.output) {
                        result.style.color = '#cccccc';
                        result.style.whiteSpace = 'pre-wrap';
                        result.textContent = data.output;
                    }

                    outputElement.appendChild(result);

                    // 自动滚动到底部
                    scrollTerminalToBottom(outputElement);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                // 移除执行中状态
                if (executingDiv.parentNode) {
                    outputElement.removeChild(executingDiv);
                }

                // 显示错误信息
                const errorDiv = document.createElement('div');
                errorDiv.style.color = '#ff6b6b';
                errorDiv.style.marginBottom = '12px';
                errorDiv.style.lineHeight = '1.4';
                errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 命令执行失败: ${error.message}`;
                outputElement.appendChild(errorDiv);

                // 自动滚动到底部
                scrollTerminalToBottom(outputElement);
            }
        }

        function resetToDefault() {
            if (launcherInstance) {
                launcherInstance.resetToDefault();
            }
        }

        // 插件管理全局函数
        function updatePlugin(pluginName) {
            console.log('updatePlugin called for:', pluginName);
            if (launcherInstance && launcherInstance.updatePlugin) {
                launcherInstance.updatePlugin(pluginName);
            } else {
                setTimeout(() => {
                    if (launcherInstance && launcherInstance.updatePlugin) {
                        launcherInstance.updatePlugin(pluginName);
                    }
                }, 100);
            }
        }

        function showPluginVersions(pluginName) {
            console.log('Global showPluginVersions called for:', pluginName);
            console.log('launcherInstance available:', !!launcherInstance);

            if (launcherInstance && launcherInstance.showPluginVersions) {
                launcherInstance.showPluginVersions(pluginName);
            } else {
                console.warn('launcherInstance not ready, retrying in 100ms...');
                setTimeout(() => {
                    if (launcherInstance && launcherInstance.showPluginVersions) {
                        launcherInstance.showPluginVersions(pluginName);
                    } else {
                        console.error('launcherInstance still not available after retry');
                        alert('启动器尚未完全加载，请稍后再试');
                    }
                }, 100);
            }
        }





        function installPlugin(pluginName, pluginUrl) {
            if (launcherInstance) {
                launcherInstance.installPlugin(pluginName, pluginUrl);
            }
        }

        function switchPluginVersion(version) {
            if (launcherInstance) {
                launcherInstance.switchPluginVersion(version);
            }
        }

        function closeVersionSwitchModal() {
            logger.debug('closeVersionSwitchModal called');
            const modal = document.getElementById('version-switch-modal');
            if (modal) {
                modal.classList.remove('show');
                // 添加淡出动画
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
                logger.debug('Modal closed successfully');
            } else {
                logger.error('Modal not found');
            }
            if (launcherInstance) {
                // 恢复切换按钮状态
                if (launcherInstance.currentVersionSwitchPlugin) {
                    launcherInstance.setPluginButtonLoading(
                        launcherInstance.currentVersionSwitchPlugin,
                        'showPluginVersions',
                        false
                    );
                }
                launcherInstance.currentVersionSwitchPlugin = null;
            }
        }

        // 添加键盘支持
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('version-switch-modal');
                if (modal && modal.classList.contains('show')) {
                    closeVersionSwitchModal();
                }
            }
        });

        // 版本管理全局函数


        function cancelVersionSwitch() {
            document.getElementById('version-confirm-modal').classList.remove('show');
            if (launcherInstance) {
                launcherInstance.pendingVersionSwitch = null;
            }
        }

        function confirmVersionSwitch() {
            document.getElementById('version-confirm-modal').classList.remove('show');
            if (launcherInstance && launcherInstance.pendingVersionSwitch) {
                launcherInstance.performVersionSwitch(launcherInstance.pendingVersionSwitch);
            }
        }



        function switchPluginVersion(version) {
            if (launcherInstance && launcherInstance.switchPluginVersion) {
                launcherInstance.switchPluginVersion(version);
            } else {
                setTimeout(() => {
                    if (launcherInstance && launcherInstance.switchPluginVersion) {
                        launcherInstance.switchPluginVersion(version);
                    }
                }, 100);
            }
        }



        function togglePlugin(pluginName, currentEnabled) {
            // 将字符串转换为布尔值
            const isEnabled = currentEnabled === 'true' || currentEnabled === true;

            if (launcherInstance && launcherInstance.togglePlugin) {
                launcherInstance.togglePlugin(pluginName, isEnabled);
            } else {
                setTimeout(() => {
                    if (launcherInstance && launcherInstance.togglePlugin) {
                        launcherInstance.togglePlugin(pluginName, isEnabled);
                    }
                }, 100);
            }
        }

        function uninstallPlugin(pluginName) {
            if (launcherInstance && launcherInstance.uninstallPlugin) {
                launcherInstance.uninstallPlugin(pluginName);
            } else {
                setTimeout(() => {
                    if (launcherInstance && launcherInstance.uninstallPlugin) {
                        launcherInstance.uninstallPlugin(pluginName);
                    }
                }, 100);
            }
        }



        function installPlugin(pluginName, pluginUrl) {
            if (launcherInstance && launcherInstance.installPlugin) {
                launcherInstance.installPlugin(pluginName, pluginUrl);
            } else {
                setTimeout(() => {
                    if (launcherInstance && launcherInstance.installPlugin) {
                        launcherInstance.installPlugin(pluginName, pluginUrl);
                    }
                }, 100);
            }
        }

        // 手动安装插件全局函数
        function validatePluginUrl() {
            if (launcherInstance && launcherInstance.validatePluginUrl) {
                launcherInstance.validatePluginUrl();
            }
        }

        function installManualPlugin() {
            if (launcherInstance && launcherInstance.installManualPlugin) {
                launcherInstance.installManualPlugin();
            }
        }

        function cancelManualInstall() {
            if (launcherInstance && launcherInstance.cancelManualInstall) {
                launcherInstance.cancelManualInstall();
            }
        }

        function clearManualInstallForm() {
            if (launcherInstance && launcherInstance.clearManualInstallForm) {
                launcherInstance.clearManualInstallForm();
            }
        }

        function refreshEnvironmentInfo() {
            if (launcherInstance && launcherInstance.refreshEnvironmentInfo) {
                launcherInstance.refreshEnvironmentInfo();
            }
        }


    </script>

    <!-- 版本管理优化脚本 -->
    <script src="version-management-optimized.js"></script>
    <script src="version-management-integration.js"></script>
</body>
</html>